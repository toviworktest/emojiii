<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì´ëª¨ì§€ ì§„í™” : The Final Collection</title>
    <style>
        :root {
            --common: #b2bec3; --magic: #00cec9; --rare: #2ecc71; --epic: #ff4757; --legendary: #ffd700;
            --bg: #0d0d0d; --panel: #161616; --border: #333;
            --success: #2ecc71; --stay: #f1c40f; --destroy: #e74c3c; --red-alert: #ff4757;
            --tier-f: #b2bec3; 
            --tier-c: #00cec9; --tier-b: #a29bfe; --tier-a: #ff4757; --tier-s: #ff4757; --tier-ss: #ffd700; --tier-sss: #fdcb6e;
        }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; background-color: var(--bg); color: #eee; margin: 0; padding: 10px; overflow-x: hidden; padding-bottom: 20px; }
        .game-container { width: 100%; max-width: 560px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* í—¤ë” */
        .game-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 4px; 
            border-bottom: 1px solid #222; 
            margin-bottom: 0; 
        }
        
        .header-left { 
            display: flex; 
            align-items: baseline; 
            gap: 6px; 
        }
        
        .game-title { font-size: 1.3rem; font-weight: 900; color: #fff; letter-spacing: -0.5px; margin: 0; line-height: 1; }
        
        .insta-link {
            font-size: 0.5rem; 
            color: #74b9ff; 
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
            letter-spacing: 0.5px;
        }
        .insta-link:hover { color: #fff; text-decoration: underline; }

        .header-notice-bar {
            width: 100%;
            text-align: center;
            font-size: 0.4rem;
            color: #666;
            margin-bottom: -6px; 
            line-height: 1.2;
            padding: 2px 0;
            word-break: keep-all;
        }

        .header-right { display: flex; align-items: center; gap: 6px; }
        .id-box { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 4px 10px; font-size: 0.7rem; font-weight: bold; color: #ccc; display: flex; align-items: center; justify-content: center; }
        .header-btn { background: #222; border: 1px solid #444; color: #888; border-radius: 6px; padding: 5px 8px; font-size: 0.7rem; cursor: pointer; transition: 0.2s; }
        .header-btn:hover { background: #333; color: #fff; }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .main-split { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: stretch; }
        .left-col, .right-col { display: flex; flex-direction: column; gap: 8px; }

        /* ìº”ë²„ìŠ¤ */
        .canvas-area { height: 180px; background: #1a1a1a; border: 2px solid var(--border); border-radius: 12px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: inset 0 0 20px #000; flex-shrink: 0; }
        .canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; padding: 8px 10px; box-sizing: border-box; background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%); display: flex; justify-content: space-between; align-items: center; z-index: 5; }
        #overlay-grade { font-size: 0.65rem; font-weight: bold; }
        #overlay-name-level { font-size: 0.8rem; font-weight: 900; }
        .glow-legendary { animation: text-glow 1.5s infinite alternate; }
        @keyframes text-glow { from { text-shadow: 0 0 5px #ffd700; } to { text-shadow: 0 0 20px #ffd700; } }
        .emoji-wrap { display: flex; align-items: center; gap: 10px; font-size: 4.2rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.1)); }
        .deco-icon { font-size: 1.5rem; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* ì§„í™” ì• ë‹ˆë©”ì´ì…˜ */
        .anim-success { animation: pop-success 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .anim-fail { animation: shake-destroy 0.5s ease-in-out; }
        .anim-stay { animation: wobble-stay 0.4s ease-in-out; }

        @keyframes pop-success { 0% { transform: scale(1); } 50% { transform: scale(1.5); filter: brightness(2); } 100% { transform: scale(1); filter: brightness(1); } }
        @keyframes shake-destroy { 0% { transform: translate(0, 0) rotate(0deg); } 20% { transform: translate(-10px, 0) rotate(-10deg); } 40% { transform: translate(10px, 0) rotate(10deg); } 60% { transform: translate(-10px, 0) rotate(-10deg); filter: grayscale(1); } 100% { transform: translate(0, 0) rotate(0deg); filter: grayscale(1); } }
        @keyframes wobble-stay { 0% { transform: translateX(0%); } 15% { transform: translateX(-15%) rotate(-5deg); } 30% { transform: translateX(10%) rotate(3deg); } 45% { transform: translateX(-10%) rotate(-3deg); } 60% { transform: translateX(5%) rotate(2deg); } 100% { transform: translateX(0%); } }

        .in-game-log { height: 180px; background: #080808; border: 1px solid #222; border-radius: 10px; padding: 10px; font-size: 0.55rem; color: #999; line-height: 1.5; overflow-y: auto; scroll-behavior: smooth; box-shadow: inset 0 0 5px #000; }

        /* ì •ë³´ íŒ¨ë„ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        .info-cell { background: var(--panel); padding: 6px; display: flex; flex-direction: column; gap: 2px; }
        .info-label { font-size: 0.55rem; color: #666; }
        .info-value { font-weight: bold; color: #fff; font-size: 0.7rem; }

        .gauge-mini { background: var(--panel); padding: 6px; border-radius: 10px; border: 1px solid var(--border); }
        .gauge-bar { width: 100%; height: 6px; background: #222; border-radius: 4px; display: flex; overflow: hidden; margin: 4px 0; }
        .gauge-seg { height: 100%; transition: width 0.3s; }
        .gauge-text { display: flex; justify-content: space-between; font-size: 0.45rem; font-weight: bold; }
        .wealth-box { background: #222; padding: 8px; border-radius: 10px; text-align: center; border: 1px solid #ffd70044; color: #ffd700; font-weight: 900; font-size: 1.1rem; text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }

        /* ë²„íŠ¼ ì‹œìŠ¤í…œ */
        .btn-stack { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        button { border: none; font-weight: bold; cursor: pointer; transition: 0.1s; position: relative; overflow: hidden; font-family: inherit; }
        button:active { transform: scale(0.97); }
        button:disabled { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; pointer-events: none; }
        .btn-action { padding: 12px 5px; border-radius: 8px; color: white; box-shadow: 0 3px 0 rgba(0,0,0,0.3); }
        .btn-action:active { box-shadow: 0 0 0 rgba(0,0,0,0); transform: translateY(3px); }
        
        .btn-evolve { background: #6c5ce7; grid-column: span 2; display: flex; flex-direction: column; align-items: center; }
        .btn-labor { background: #576574; grid-column: span 2; display: flex; flex-direction: column; align-items: center; border: 2px dashed #999; animation: laborPulse 1s infinite; }
        @keyframes laborPulse { 0% { border-color: #999; } 50% { border-color: #fff; } 100% { border-color: #999; } }

        .btn-allin { background: #e74c3c; grid-column: span 2; display: flex; flex-direction: column; align-items: center; border: 1px solid #ff7675; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        .btn-normal-summ { background: var(--success); display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:0.7rem; }
        .btn-premium-summ { background: linear-gradient(135deg, #e1b12c, #fbc531); color:#222; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:0.7rem; box-shadow: 0 0 10px rgba(251, 197, 49, 0.3); }
        
        .btn-sell { background: var(--stay); color: #333; }
        .btn-cleanup { background: #e74c3c; color: white; }
        .btn-gene { background: #333; color: #bbb; font-size: 0.75rem; padding: 10px; }
        
        .menu-btn-square { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #ccc; font-size: 0.65rem; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; box-shadow: 0 3px 0 #000; position: relative; font-weight: bold; aspect-ratio: 1.2/1; }
        .menu-btn-square:hover { background: #222; color: #fff; border-color: #555; }
        .menu-btn-square:active { transform: translateY(3px); box-shadow: none; }
        .menu-icon { font-size: 1.4rem; margin-bottom: -2px; }

        /* ë­í‚¹ ëŒ€ì‹œë³´ë“œ */
        .rank-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2px; }
        .rank-panel { background: #111; border: 1px solid #333; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; height: 60px; }
        .rank-panel:active { transform: scale(0.98); background: #1a1a1a; }
        .rank-label { font-size: 0.6rem; font-weight: 900; margin-bottom: 2px; letter-spacing: 0.5px; }
        .rank-value { font-size: 0.7rem; color: #ddd; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 2; }
        .rank-icon { position: absolute; right: 8px; bottom: 5px; font-size: 1.8rem; opacity: 0.9; animation: float 2.5s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .panel-global { border-color: #9c27b0; box-shadow: 0 4px 0 #2c0e33; }
        .panel-global .rank-label { color: #9c27b0; }
        .panel-local { border-color: #00cec9; box-shadow: 0 4px 0 #003635; }
        .panel-local .rank-label { color: #00cec9; }

        /* ê³µí†µ UI */
        .full-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal-header { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 15px; gap: 5px; }
        .modal-title { color: #ffd700; margin: 0; font-size: 1.3rem; text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .close-btn { width: 100%; padding: 12px; background: #333; color: white; border-radius: 10px; margin-top: 15px; font-size: 0.9rem; }
        .status-dot { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: var(--red-alert); border-radius: 50%; box-shadow: 0 0 5px var(--red-alert); display: none; animation: blink 1s infinite alternate; }
        @keyframes blink { from { opacity: 0.7; } to { opacity: 1; box-shadow: 0 0 10px var(--red-alert); } }

        /* ì¸ë²¤í† ë¦¬ */
        .inv-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; }
        .inv-slot { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; aspect-ratio: 1/1; transition: 0.2s; }
        .inv-slot.selected { border: 2px solid #fff; box-shadow: 0 0 10px #fff; z-index: 10; }
        .inv-emoji { font-size: 1.7rem; }
        .inv-tag { position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 0.45rem; color: #888; font-weight: bold; }
        .inv-status-bar { background: #222; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; cursor: pointer; }

        /* ë„ê° */
        .chart-section { background: #161616; border: 1px solid #333; border-radius: 12px; padding: 12px; margin-bottom: 15px; }
        .chart-header { text-align:center; font-weight:900; color:#fff; font-size:0.9rem; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px; }
        .chart-grid { display: flex; gap: 8px; justify-content: space-between; }
        .chart-box { flex: 1; background: #1a1a1a; border: 1px solid #222; border-radius: 8px; padding: 6px; }
        .chart-title { font-size: 0.7rem; color: #888; text-align: center; margin-bottom: 4px; font-weight: bold; border-bottom: 1px solid #222; padding-bottom: 4px; }
        
        .rate-table { width: 100%; border-collapse: collapse; font-size: 0.6rem; }
        .rate-table th { color:#888; border-bottom:1px solid #444; padding:3px;}
        .rate-table td { padding: 3px 1px; text-align: center !important; vertical-align: middle; border-bottom: 1px solid #222; color: #aaa; }
        
        .book-compact-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 2px; }
        .book-card-mini { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; padding: 4px; position: relative; width: 100%; aspect-ratio: 0.85/1; box-sizing: border-box; overflow: hidden; cursor: pointer; transition: all 0.2s ease; }
        .book-card-mini:hover { transform: translateY(-3px); }
        .book-legendary { border: 1px solid #ffd700 !important; box-shadow: 0 0 5px rgba(255, 215, 0, 0.2); }
        .book-mini-header { font-size: 0.5rem; font-weight: bold; text-align: center; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #555; height: 12px; }
        .book-mini-slots { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 1px; flex: 1; }
        .book-mini-slot { background: #000; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .silhouette { filter: brightness(0); opacity: 0.3; }
        .book-completed { border-color: #ffd700; box-shadow: 0 0 5px rgba(255,215,0,0.2); }
        .mini-reward-dot { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: var(--red-alert); border-radius: 50%; border: 1px solid #fff; z-index: 10; animation: blink 0.8s infinite alternate; }

        /* ë„ê° íƒ­ */
        .book-tabs { display: flex; gap: 4px; margin-bottom: 10px; justify-content: center; flex-wrap: wrap; }
        .book-tab-btn { background: #222; border: 1px solid #444; color: #888; padding: 6px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; cursor: pointer; transition:0.2s; }
        .book-tab-btn.active { color: #000; font-weight: 900; border-color: #fff; transform: scale(1.05); }

        /* ë­í‚¹ íƒ­ */
        .rank-tabs { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; width: 100%; }
        .rank-tab { flex: 1; background: #222; border: 1px solid #333; color: #888; padding: 8px; border-radius: 8px; font-weight: bold; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
        .rank-tab.active { background: #333; color: #fff; border-color: #666; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        
        /* íƒ€ì´ë¨¸ ë°•ìŠ¤ */
        .reset-timer-box { 
            font-size: 0.65rem; color: #74b9ff; font-weight: bold; 
            text-align: center; margin-top: 5px; 
            border: 1px solid #74b9ff; border-radius: 12px; padding: 4px 10px; 
            background: rgba(116, 185, 255, 0.1); display: inline-block;
        }

        /* ë­í‚¹ ì¹´ë“œ */
        .rank-card-styled { display: grid; grid-template-columns: 1fr 1fr 4fr; background: #111; border-radius: 8px; margin-bottom: 6px; border: 1px solid #222; align-items: stretch; overflow: hidden; position: relative; height: 74px; }
        .rank-col-rank { display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border-right: 1px solid #222; font-size: 0.8rem; font-weight: 900; color: #666; }
        .rank-col-icon { display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border-right: 1px solid #222; font-size: 1.8rem; }
        .rank-col-info { padding: 4px 10px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        
        .rank-card-wealth { display: grid; grid-template-columns: 0.8fr 1.5fr 2fr; background: #111; border-radius: 8px; margin-bottom: 6px; border: 1px solid #222; align-items: stretch; overflow: hidden; position: relative; height: 50px; }
        
        .rank-user { font-weight: 900; font-size: 0.8rem; color: #fff; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }
        .rank-detail { font-size: 0.65rem; margin-bottom: 2px; font-weight: bold; }
        .rank-meta-row { display: flex; align-items: center; gap: 5px; font-size: 0.65rem; color: #aaa; margin-bottom: 2px; }
        .rank-prob-thin { font-weight: 300; }
        .rank-date { position: absolute; top: 8px; right: 12px; font-size: 0.55rem; color: #666; font-weight: normal; letter-spacing: 0.5px; }

        .tier-badge { display: inline-block; background: #222; border: 1px solid #444; border-radius: 3px; padding: 1px 4px; font-weight: bold; font-size: 0.6rem; line-height: 1; }
        .rank-gold { font-size: 0.6rem; color: #ffd700; font-weight: bold; }

        .rank-glow-1 { box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); border: 1px solid #ffd700 !important; z-index: 2; }
        .rank-glow-2 { box-shadow: 0 0 15px rgba(255, 71, 87, 0.3); border: 1px solid #ff4757 !important; z-index: 2; }
        .rank-glow-3 { box-shadow: 0 0 15px rgba(52, 152, 219, 0.3); border: 1px solid #3498db !important; z-index: 2; }

        /* EX ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .tier-ex-gradient { 
            background: linear-gradient(135deg, #00cec9, #a29bfe, #e056fd); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            font-weight: 900; 
            display: inline-block;
            filter: drop-shadow(0 0 3px rgba(162, 155, 254, 0.5)); 
            animation: ex-pulse 2s infinite alternate; 
        }
        .tier-badge-ex { border: 1px solid #a29bfe !important; background: linear-gradient(135deg, rgba(0, 206, 201, 0.1), rgba(162, 155, 254, 0.1)); }
        @keyframes ex-pulse { from { filter: drop-shadow(0 0 2px rgba(0, 206, 201, 0.5)); } to { filter: drop-shadow(0 0 8px rgba(224, 86, 253, 0.8)); } }

        /* ìì‚° ë°°ë„ˆ */
        .my-max-asset-banner { background: linear-gradient(90deg, #111, #222); border: 1px solid #ffd700; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: inset 0 0 10px rgba(255,215,0,0.1); }
        .banner-label { font-size: 0.6rem; color: #ffd700; font-weight: bold; margin-bottom: 2px; }
        .banner-value { font-size: 1.1rem; color: #fff; font-weight: 900; text-shadow: 0 0 5px rgba(255,215,0,0.3); }
        .banner-date { font-size: 0.55rem; color: #666; }

        /* ëª¨ë‹¬ */
        #nick-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background:#1a1a1a; padding:25px; border-radius:15px; border:2px solid #e74c3c; text-align:center; width:85%; max-width:340px; }
        .login-input { width:100%; padding:12px; background:#000; border:1px solid #444; color:white; border-radius:8px; margin: 5px 0; box-sizing:border-box; }
        .btn-google { width:100%; background:#fff; color:#333; display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:15px; padding: 12px; border-radius: 8px; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        /* --- [ğŸ”® íƒ€ë¡œ ì‹œìŠ¤í…œ CSS (v6: 3ë²„íŠ¼ ì •ë ¬ ìˆ˜ì •)] --- */
        
        .tarot-banner-wrap {
            background: linear-gradient(90deg, #2c0e33, #000000);
            border-bottom: 1px solid #9c27b0;
            border-top: 1px solid #333;
            height: 22px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .tarot-msg-rolling {
            white-space: nowrap;
            font-size: 0.6rem;
            font-weight: bold;
            color: #e056fd;
            text-shadow: 0 0 5px rgba(224, 86, 253, 0.5);
            animation: text-scroll 12s linear infinite;
            padding-top: 1px;
        }
        @keyframes text-scroll {
            0% { transform: translateX(100%); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }

        .tarot-scene {
            perspective: 600px;
            width: 120px;
            height: 180px;
            margin: 10px auto;
            cursor: pointer;
        }
        .tarot-card {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .tarot-card.is-flipped {
            transform: rotateY(180deg);
        }
        .tarot-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #444;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .tarot-front {
            background: repeating-linear-gradient(45deg, #1a1a1a, #1a1a1a 10px, #222 10px, #222 20px);
            color: #555;
            transform: rotateY(180deg);
        }
        .tarot-back {
            background: #111;
            transform: rotateY(0deg);
            border-color: #ffd700;
        }
        
        .tarot-table-wrap {
            height: auto;
            max-height: 280px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #0f0f0f;
        }
        .tarot-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .tarot-table th {
            position: sticky;
            top: 0;
            background: #222;
            color: #aaa;
            padding: 4px 2px;
            border-bottom: 1px solid #444;
            z-index: 2;
            font-size: 0.55rem;
        }
        .tarot-table td {
            padding: 3px 2px;
            border-bottom: 1px solid #1a1a1a;
            color: #888;
            text-align: center;
            vertical-align: middle;
            font-size: 0.6rem;
            height: 24px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tarot-row-active {
            background: rgba(224, 86, 253, 0.1);
            border: 1px solid #e056fd;
        }
        .tarot-row-active td {
            color: #fff;
            font-weight: bold;
        }

        .btn-action {
            min-height: 54px; 
            height: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }
        
        .menu-btn-square {
            height: 68px !important; 
            padding: 0 !important;   
            width: 100%;             
            min-width: 0;            
            justify-content: center;
            gap: 5px;                
        }

        .menu-btn-square .menu-icon {
            font-size: 1.15rem;      
            margin-bottom: 0;
            line-height: 1;
            display: block;
        }
        .menu-btn-square span:not(.menu-icon) {
            font-size: 0.6rem;       
            margin-top: 0;
            white-space: nowrap;     
        }

        .btn-stack-3col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 5px; 
            margin-top: 6px;
            width: 100%;
        }

        .fortune-text {
            text-align: center;
            font-size: 0.7rem;
            color: #a29bfe;
            margin: 5px 0;
            font-style: italic;
            min-height: 18px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .fortune-text.show { opacity: 1; }
        /* --- [ê°•í™” ë³´ì¡° ì•„ì´í…œ ë°” ìŠ¤íƒ€ì¼ (í”ŒëŸ¬ìŠ¤ ë±ƒì§€ ì¶•ì†Œ)] --- */
        .buff-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            background: #0f0f0f;
            padding: 6px;
            border-radius: 10px;
            border: 1px solid #222;
            margin-bottom: 5px;
        }

        .buff-item {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 5px 0;
            transition: all 0.2s;
            position: relative; 
            height: auto;
            opacity: 1;
        }

        .buff-item:active { transform: scale(0.96); }

        /* [ìƒíƒœ 1] ì—†ì„ ë•Œ (êµ¬ë§¤ ìœ ë„) : ì ì„  + ì‘ì€ í”ŒëŸ¬ìŠ¤ ë±ƒì§€ */
        .buff-item.empty {
            border: 1px dashed #555;
            background: #111;
            color: #777;
        }
        
        /* â­ ìˆ˜ì •ë¨: í”ŒëŸ¬ìŠ¤(+) ë±ƒì§€ í¬ê¸° ì¶•ì†Œ */
        .buff-item.empty::after {
            content: '+';
            position: absolute;
            top: -3px; right: -3px; /* ìœ„ì¹˜ë¥¼ ë” ì•ˆìª½ìœ¼ë¡œ */
            background: #ffd700;
            color: #000;
            font-weight: 900;
            font-size: 0.5rem; /* í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
            width: 11px; height: 11px; /* ë±ƒì§€ ì „ì²´ í¬ê¸° ì¶•ì†Œ (13px -> 11px) */
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: 1px solid #000;
            /* ì• ë‹ˆë©”ì´ì…˜ ì—†ìŒ */
        }

        /* [ìƒíƒœ 2] ì¥ì°©(ì„ íƒ) ì¤‘ */
        .buff-item.active {
            background: #252a34;
            border: 1px solid #00cec9;
            box-shadow: 0 0 5px rgba(0, 206, 201, 0.3);
            color: #fff;
            z-index: 2;
        }

        /* íŒŒê´´ ë°©ì§€ê¶Œ íŠ¹ìˆ˜ ì»¬ëŸ¬ */
        .buff-item.protect.active {
            border-color: #e74c3c;
            background: #2c1e1e;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.3);
        }
        
        .buff-icon { font-size: 1.1rem; line-height: 1; margin-bottom: 2px; }
        .buff-name { font-size: 0.5rem; font-weight: bold; letter-spacing: -0.5px; }
        /* --- [ë„ê° ë³´ìƒ ì•Œë¦¼ íš¨ê³¼ (ì¶”ê°€ë¨)] --- */
        
        /* 1. íƒ­ ë²„íŠ¼ ì•Œë¦¼ (ë³´ìƒì´ ìˆëŠ” ë“±ê¸‰ íƒ­) */
        .tab-reward-alert {
            border-color: #ff4757 !important;
            color: #ff4757 !important;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.6) !important;
            animation: pulse-red-border 1.2s infinite alternate;
            position: relative;
            z-index: 10;
        }
        
        /* íƒ­ ë²„íŠ¼ ìœ„ì— ë¹¨ê°„ ì ë„ ì¶”ê°€ */
        .tab-reward-alert::after {
            content: '';
            position: absolute;
            top: -3px; right: -3px;
            width: 8px; height: 8px;
            background: #ff4757;
            border-radius: 50%;
            border: 1px solid #fff;
        }

        /* 2. ì¹´ë“œ ì•Œë¦¼ (ë³´ìƒ ìˆ˜ë ¹ ê°€ëŠ¥ ì¹´ë“œ) */
        .book-card-reward-aura {
            border: 2px solid #ff4757 !important;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.5) !important;
            animation: pulse-red-border 1.2s infinite alternate;
            z-index: 5;
        }

        /* ë¶‰ì€ìƒ‰ ìˆ¨ì‰¬ëŠ” íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-red-border {
            from { box-shadow: 0 0 5px rgba(255, 71, 87, 0.4); border-color: rgba(255, 71, 87, 0.6); }
            to { box-shadow: 0 0 15px rgba(255, 71, 87, 0.9); border-color: #ff4757; }
        }

    </style>
</head>
<body>
<div id="nick-modal">
    <div class="login-box">
        <h2 style="color:#ffd700; margin-top:0;">GAME START</h2>
        <button class="btn-google" onclick="googleLogin()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18" alt="G">
            <span>Google ê³„ì •ìœ¼ë¡œ ì‹œì‘</span>
        </button>
        <div style="display:flex; align-items:center; gap:10px; margin:15px 0; color:#555; font-size:0.7rem;">
            <div style="flex:1; height:1px; background:#333;"></div> OR <div style="flex:1; height:1px; background:#333;"></div>
        </div>
        <input type="email" id="inp-email" class="login-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <input type="password" id="inp-pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <input type="text" id="inp-nick" class="login-input" placeholder="ë‹‰ë„¤ì„" style="display:none;">
        
        <button class="btn-action" onclick="startGuestMode()" style="width:100%; background:#444; color:#ccc; margin-top:15px; border:1px solid #666; font-size:0.8rem;">
            ğŸ‘» ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸° (ì €ì¥ ì•ˆ ë¨)
        </button>

        <div style="display:flex; justify-content:space-between; gap:10px; margin-top:10px;">
            <button class="btn-action" style="flex:1; background:#00cec9; color:#000;" onclick="toggleJoinMode()" id="btn-mode-switch">íšŒì›ê°€ì…</button>
            <button class="btn-action" style="flex:1; background:#e74c3c;" onclick="processAuth()" id="btn-auth-action">ë¡œê·¸ì¸</button>
        </div>
        <div id="auth-msg" style="color:#ff7675; font-size:0.75rem; margin-top:10px; height:15px;"></div>
    </div>
</div>

<div class="game-container">
    <header class="game-header">
        <div class="header-left">
            <h1 class="game-title">ì´ëª¨ì§€ ì§„í™”</h1>
            <a href="https://www.instagram.com/tovi_work" target="_blank" class="insta-link">by. @tovi_work</a>
        </div>
        <div class="header-right">
            <div class="id-box" id="my-id-label">ID: -</div>
            
            <button class="header-btn" id="btn-link-google" onclick="linkGoogleAccount()" style="display:none; background:#e74c3c; color:white; border:1px solid #ff7675; animation:pulse-red 2s infinite; font-weight:bold; margin-right:5px;">
                ğŸ’¾ ì €ì¥
            </button>
            
            <button class="header-btn" onclick="changeNickname()">âœï¸</button>
            <button class="header-btn" onclick="logout()">OUT</button>
        </div>
    </header>
    
    <div class="header-notice-bar">
        *ì •ì‹ì„œë¹„ìŠ¤ê°€ ì•„ë‹Œ ê°œì¸ì´ í•™ìŠµì„ ëª©í‘œë¡œ ì œì‘ ì¤‘ì…ë‹ˆë‹¤ ë‹¤ì†Œ ë¶ˆì•ˆì •í•œ ìš´ì˜ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤
    </div>

    <div class="tarot-banner-wrap" onclick="openTarotModal()">
        <div id="tarot-msg-box" class="tarot-msg-rolling">
            ğŸ”¯ íƒ€ë¡œë¥¼ ë’¤ì§‘ì–´ ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•˜ì„¸ìš”!
        </div>
    </div>

    <div class="main-split">
        <div class="left-col">
            <div class="canvas-area" id="display-area" title="ì•„ì´í…œ ì¡°ì‘">
                <div class="canvas-overlay">
                    <span id="overlay-grade">-</span>
                    <span id="overlay-name-level">ì¤€ë¹„ë¨</span>
                    <div id="book-status-badge" style="margin-top:42px; position:absolute; right:10px;"></div>
                </div>
                <div class="emoji-wrap">
                    <span id="deco-l" class="deco-icon"></span>
                    <span id="main-emoji">ğŸ”’</span>
                    <span id="deco-r" class="deco-icon"></span>
                </div>
            </div>
            <div class="buff-bar">
                <div class="buff-item" id="btn-buff-5" onclick="toggleBuff('charm_5')">
                    <div class="buff-icon">ğŸ“œ</div>
                    <div class="buff-name">5%</div>
                </div>
                <div class="buff-item" id="btn-buff-10" onclick="toggleBuff('charm_10')">
                    <div class="buff-icon">ğŸ“œ</div>
                    <div class="buff-name">10%</div>
                </div>
                <div class="buff-item" id="btn-buff-30" onclick="toggleBuff('charm_30')">
                    <div class="buff-icon">ğŸŒŸ</div>
                    <div class="buff-name">30%</div>
                </div>
                <div class="buff-item protect" id="btn-buff-protect" onclick="toggleBuff('protect')">
                    <div class="buff-icon">ğŸ›¡ï¸</div>
                    <div class="buff-name">ë°©ì§€ê¶Œ</div>
                </div>
            </div>
            <div id="game-log" class="in-game-log"></div>
        </div>

        <div class="right-col">
            <div class="info-grid">
                <div class="info-cell"><span class="info-label">ê°€ì¹˜</span><span class="info-value" id="st-value">-</span></div>
                <div class="info-cell"><span class="info-label">ë“±ê¸‰</span><span class="info-value" id="st-grade">-</span></div>
                <div class="info-cell"><span class="info-label">ìœ ì „ì</span><span class="info-value" id="st-gene">-</span></div>
                <div class="info-cell"><span class="info-label" style="color:#ffd700;">í¬ê·€ë„ (Tier)</span><span class="info-value" id="st-rarity" style="color:#ffd700;">-</span></div>
            </div>
            <div class="gauge-mini">
                <div class="gauge-text"><span id="val-s-text" style="color:var(--success)">ì„±ê³µ <span id="val-s">0%</span></span><span style="color:var(--destroy)">íŒŒê´´ <span id="val-b">0%</span></span></div>
                <div class="gauge-bar"><div id="seg-s" class="gauge-seg" style="background:var(--success); width:0%"></div><div id="seg-m" class="gauge-seg" style="background:var(--stay); width:0%"></div><div id="seg-b" class="gauge-seg" style="background:var(--destroy); width:0%"></div></div>
            </div>
            <div class="wealth-box" id="gold-display">0 ğŸŸ¡</div>
            
            <div id="dynamic-btn-area"></div>

            <div class="btn-stack" style="margin-top:6px; grid-template-columns: 1fr 1fr 1fr;">
                <button class="menu-btn-square" onclick="openInventory()">
                    <span class="menu-icon">ğŸ’</span>
                    <span>ì¸ë²¤í† ë¦¬</span>
                </button>
                <button class="menu-btn-square" onclick="openBook()" id="btn-main-book">
                    <span class="menu-icon">ğŸ“•</span>
                    <span>ë„ê°</span>
                    <div id="book-alert" class="status-dot"></div>
                </button>
                <button class="menu-btn-square" onclick="openTarotModal()">
                    <span class="menu-icon">ğŸ”¯</span>
                    <span>íƒ€ë¡œì </span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="rank-dashboard">
        <div class="rank-panel panel-global" onclick="openGlobalRanking()">
            <div class="rank-label">ğŸ† ê¸€ë¡œë²Œ ë­í‚¹</div>
            <div id="world-best-info" class="rank-value">ë¡œë”© ì¤‘...</div>
            <div id="world-best-icon" class="rank-icon">ğŸ‘‘</div>
        </div>
        <div class="rank-panel panel-local" onclick="openMyHistory()">
            <div class="rank-label">ğŸ‘‘ MY BEST</div>
            <div id="my-best-info" class="rank-value">ê¸°ë¡ ì—†ìŒ</div>
            <div class="rank-icon" id="my-best-icon">ğŸ‘»</div>
        </div>
    </div>
</div>
<div id="inv-page" class="full-page">
    <div class="modal-header"><h2 class="modal-title">ğŸ’ ì¸ë²¤í† ë¦¬</h2></div>
    <div class="inv-status-bar" onclick="swapWithMain()">
        <div class="inv-current-info">
            <div id="inv-current-emoji" class="inv-current-icon">ğŸ”’</div>
            <div>
                <span style="font-size:0.6rem; color:#aaa;">í˜„ì¬ ì¥ì°© ì¤‘</span>
                <div id="inv-current-name" style="font-weight:bold; font-size:0.9rem; color:#fff;">ì—†ìŒ</div>
            </div>
        </div>
        <div id="inv-total-gold" style="font-size:1.2rem; font-weight:bold; color:#ffd700;">0 ğŸŸ¡</div>
    </div>
    <div class="inv-grid" id="inv-grid-list"></div>
    <button class="close-btn" onclick="closePage('inv-page')">ë‹«ê¸°</button>
</div>

<div id="book-page" class="full-page">
    <div class="modal-header">
        <h2 class="modal-title">ğŸ“• ë„ê° ì»¬ë ‰ì…˜</h2>
    </div>
    
    <div class="chart-section">
        <div class="chart-header">ì´ëª¨ì§€ í™•ë¥  ì •ë³´</div>
        <div class="chart-grid">
            <div class="chart-box">
                <div class="chart-title">ë“±ê¸‰ë³„ ì†Œí™˜ í™•ë¥ </div>
                <table class="rate-table" id="grade-rate-table"></table>
            </div>
            <div class="chart-box">
                <div class="chart-title">í¬ê·€ë„(Tier) í™•ë¥ </div>
                <table class="rate-table">
                    <tr><td><span class="tier-ex-gradient">EX</span></td><td>0.000001% â†“</td></tr>
                    <tr><td style="color:var(--tier-sss)">SSS</td><td>0.01% â†“</td></tr>
                    <tr><td style="color:var(--tier-ss)">SS</td><td>0.1% â†“</td></tr>
                    <tr><td style="color:var(--tier-s)">S</td><td>1.0% â†“</td></tr>
                    <tr><td style="color:var(--tier-a)">A</td><td>5.0% â†“</td></tr>
                    <tr><td style="color:var(--tier-b)">B</td><td>15.0% â†“</td></tr>
                </table>
            </div>
        </div>
    </div>

    <div class="book-tabs" id="book-grade-tabs">
        <button class="book-tab-btn active" onclick="switchBookTab('ì¼ë°˜')">ì¼ë°˜</button>
        <button class="book-tab-btn" onclick="switchBookTab('ë§¤ì§')">ë§¤ì§</button>
        <button class="book-tab-btn" onclick="switchBookTab('ë ˆì–´')">ë ˆì–´</button>
        <button class="book-tab-btn" onclick="switchBookTab('ì—í”½')">ì—í”½</button>
        <button class="book-tab-btn" onclick="switchBookTab('ë ˆì „ë”ë¦¬')">ë ˆì „ë”ë¦¬</button>
    </div>

    <div style="font-size:0.8rem; color:#aaa; margin-bottom:2px; text-align:center;">ğŸ§¬ ìˆ˜ì§‘ í˜„í™© (íƒœìƒ ë“±ê¸‰ ê¸°ì¤€)</div>
    <div id="book-hint-text" style="font-size:0.6rem; color:#ffd700; margin-bottom:10px; text-align:center; font-weight:bold;">* ê³ ì§„ê°ë˜ : ì“´ ê²ƒì´ ë‹¤í•˜ë©´ ë‹¨ ê²ƒì´ ì˜¨ë‹¤.</div>
    <div id="book-list" class="book-compact-grid"></div>
    <button class="close-btn" onclick="closePage('book-page')">ë‹«ê¸°</button>
</div>

<div id="rank-page" class="full-page">
    <div class="modal-header">
        <h2 id="rank-title" class="modal-title">ì „ë‹¹</h2>
        <div id="reset-timer" class="reset-timer-box">ì£¼ê°„ë­í‚¹ ê°±ì‹ ê¹Œì§€ 0ì¼ 0ì‹œê°„ ë‚¨ìŒ</div>
        <div style="font-size:0.6rem; color:#ff7675; margin-top:5px; margin-bottom:-5px;">* í¬ê·€ë„ ë­í‚¹ì€ ë§¤ì£¼ ì›”ìš”ì¼ 0ì‹œì— ê°±ì‹ (ë¦¬ì…‹)ë©ë‹ˆë‹¤. (ë‚˜ì˜ê¸°ë¡ì€ ê³„ì† ìœ ì§€)</div>
    </div>
    
    <div class="rank-tabs" id="rank-tabs-container" style="display:none;">
        <button class="rank-tab active" onclick="switchRankTab('rarity')">ğŸ’ í¬ê·€ë„ ë­í‚¹</button>
        <button class="rank-tab" onclick="switchRankTab('wealth')">ğŸ’° ìì‚° ë­í‚¹</button>
    </div>

    <div style="text-align:center; margin:10px 0;">
        <div style="font-size:0.6rem; color:#74b9ff; line-height:1.4;">
            * ì ìˆ˜(RP)ê°€ ë†’ì„ìˆ˜ë¡ í¬ê·€í•œ ì´ëª¨ì§€ì…ë‹ˆë‹¤.<br>
            * ë™ì ì¼ ê²½ìš°, ë” ìµœê·¼ì— íŒë§¤í•œ ê¸°ë¡ì´ ìƒìœ„ ë­í¬ë©ë‹ˆë‹¤.
        </div>
    </div>

    <div id="my-wealth-banner" class="my-max-asset-banner" style="display:none;">
        <div>
            <div class="banner-label">ğŸ† ë‚˜ì˜ ì—­ëŒ€ ìµœê³  ìì‚°</div>
            <div class="banner-date" id="my-wealth-date">-</div>
        </div>
        <div class="banner-value" id="my-wealth-val">0 ğŸŸ¡</div>
    </div>

    <div id="rank-list"></div>
    <button class="close-btn" onclick="closePage('rank-page')">ë‹«ê¸°</button>
</div>

<div id="tarot-modal" class="full-page">
    <div class="modal-header">
        <h2 class="modal-title">ğŸ”¯ ì˜¤ëŠ˜ì˜ ìš´ì„¸</h2>
        <div style="font-size:0.6rem; color:#aaa; margin-top:2px;">ë§¤ì¼ í•œ ë²ˆ, ìš´ëª…ì˜ ì¹´ë“œë¥¼ ë’¤ì§‘ìœ¼ì„¸ìš”!</div>
        
        <div id="tarot-reset-timer" style="font-size:0.7rem; color:#ff7675; font-weight:bold; margin-top:8px; background:rgba(255, 118, 117, 0.1); padding:4px 10px; border-radius:12px; border:1px solid #ff7675; display: inline-block;">
            â³ ì„œë²„ ì‹œê°„ í™•ì¸ ì¤‘...
        </div>
    </div>

    <div class="tarot-scene">
        <div class="tarot-card" id="tarot-card-el" onclick="flipTarotCard()">
            <div class="tarot-face tarot-front" id="tarot-front-face">
                <div style="font-size:3rem; margin-bottom:10px;" id="tarot-result-icon">â“</div>
                <div style="font-size:0.8rem; font-weight:bold; text-align:center; width:100%; padding:0 5px; box-sizing:border-box; word-break:keep-all; line-height:1.2;" id="tarot-result-name">-</div>
                <div style="font-size:0.6rem; color:#e056fd; text-align:center; width:100%; margin-top:2px;" id="tarot-result-desc">-</div>
            </div>
            <div class="tarot-face tarot-back">
                <div style="font-size:3rem;">ğŸ”¯</div>
            </div>
        </div>
    </div>

    <div id="tarot-fortune-text" class="fortune-text">
        "ì¹´ë“œë¥¼ í„°ì¹˜í•˜ì—¬ ë’¤ì§‘ìœ¼ì„¸ìš”..."
    </div>

    <div style="background:#1a1a1a; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #333;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <span style="color:#aaa; font-size:0.7rem;">ë‚´ ë³´ìœ  ê³¨ë“œ:</span>
            <span id="tarot-my-gold" style="color:#ffd700; font-weight:bold; font-size:0.9rem;">0 ğŸŸ¡</span>
        </div>
        <button id="btn-reroll" class="btn-action" style="width:100%; height:40px; background:#9c27b0; border:1px solid #e056fd;" onclick="rerollTarot()">
            <span id="reroll-btn-text" style="font-size:0.8rem;">ğŸ”„ ìš´ëª… ë°”ê¾¸ê¸°</span>
            <div id="reroll-cost-text" style="font-size:0.6rem; opacity:0.8;">ë¹„ìš©: 50,000,000 ğŸŸ¡</div>
        </button>
    </div>

    <div style="margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px;">
        <div style="text-align:center; font-size:0.5rem; color:#666; margin-bottom:5px;">â–¼ íšë“ ê°€ëŠ¥ ì¹´ë“œ ëª©ë¡ â–¼</div>
        <div class="tarot-table-wrap">
            <table class="tarot-table">
                <thead>
                    <tr>
                        <th width="15%">ì´ëª¨ì§€</th>
                        <th width="45%">ì´ë¦„</th>
                        <th width="40%">íš¨ê³¼</th>
                    </tr>
                </thead>
                <tbody id="tarot-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <button class="close-btn" onclick="closePage('tarot-modal')">ë‹«ê¸°</button>
</div>

<div id="allin-modal" class="full-page" style="z-index:4000; display:none; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.9);">
    <div class="login-box" style="border-color:#ff4757; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <h2 style="color:#ff4757; margin-top:0; font-size:1.5rem; text-shadow:0 0 10px rgba(255, 71, 87, 0.5);">âš ï¸ ìœ„í—˜í•œ ë„ë°•</h2>
        <p style="color:#ddd; margin:15px 0; line-height:1.6; font-size:0.9rem;">
            í˜„ì¬ ë³´ìœ  ìì‚°ì´ ê°•í™” ë¹„ìš©ì˜ ì ˆë°˜ ì´ìƒì…ë‹ˆë‹¤.<br>
            ëª¨ë“  ì¬ì‚°ì„ ê±¸ê³  ê°•í™”ë¥¼ 1íšŒ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><br>
            
            <div style="background:#222; padding:10px; border-radius:8px; border:1px solid #444; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="color:#aaa; font-size:0.8rem;">í•„ìš” ë¹„ìš©:</span>
                    <span id="allin-cost-disp" style="color:#ff7675; font-weight:bold;">-</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:#aaa; font-size:0.8rem;">ë³´ìœ  ì¬ì‚°:</span>
                    <span id="allin-gold-disp" style="color:#ffd700; font-weight:bold;">-</span>
                </div>
            </div>

            <span style="color:#ff7675; font-weight:bold; font-size:0.85rem;">
                (ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì”ì•¡ì€ 0ì›ì´ ë©ë‹ˆë‹¤)
            </span>
        </p>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn-action" onclick="confirmAllIn()" style="background:#ff4757; color:white; flex:1; font-weight:bold;">ğŸ”¥ ì§„í–‰ì‹œì¼œ!</button>
            <button class="btn-action" onclick="closePage('allin-modal')" style="background:#444; color:white; flex:1;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="exit-modal" class="full-page" style="z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.85);">
    <div class="login-box" style="border-color:#e74c3c; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <h2 style="color:#e74c3c; margin-top:0; font-size:1.5rem;">âš ï¸ WARNING</h2>
        <p style="color:#ddd; margin:20px 0; line-height:1.6; font-size:0.9rem;">
            ì •ë§ë¡œ ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            <span style="color:#4cd137; font-size:0.8rem; font-weight:bold;">
                (í˜„ì¬ ë‚´ìš©ì€ ì„œë²„ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤)
            </span>
        </p>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn-action" onclick="realExit()" style="background:#e74c3c; color:white; flex:1;">ì¢…ë£Œ</button>
            <button class="btn-action" onclick="cancelExit()" style="background:#444; color:white; flex:1;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, query, where, limit, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA-QVwu7jpUUeLH3jtqYHChfwOW3FHY3pc", 
        authDomain: "gkyoungee.firebaseapp.com",
        projectId: "gkyoungee",
        storageBucket: "gkyoungee.firebasestorage.app",
        messagingSenderId: "903817816298",
        appId: "1:903817816298:web:a607dd06d9729bc7a60f93"
    };

    let app, db, auth;
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch(e) {}

    const gradeInfo = { 
        "ë ˆì „ë”ë¦¬": { color: "#ffd700", mod: 0.3, rank: 4, prob: 5.0, weight: 15.0, sellMod: 1.0 },
        "ì—í”½": { color: "#ff4757", mod: 0.5, rank: 3, prob: 10.0, weight: 4.0, sellMod: 1.0 },
        "ë ˆì–´": { color: "#2ecc71", mod: 0.7, rank: 2, prob: 15.0, weight: 3.0, sellMod: 1.0 },
        "ë§¤ì§": { color: "#00cec9", mod: 0.85, rank: 1, prob: 25.0, weight: 2.0, sellMod: 0.45 }, 
        "ì¼ë°˜": { color: "#b2bec3", mod: 1.0, rank: 0, prob: 45.0, weight: 1.0, sellMod: 0.5 }   
    };

    const rewardInfo = {
        "ì¼ë°˜": 1000000000,
        "ë§¤ì§": 800000000,
        "ë ˆì–´": 700000000,
        "ì—í”½": 500000000,
        "ë ˆì „ë”ë¦¬": 500000000
    };

    const EX_THRESHOLD = 0.000001; 

    const tarotCards = [
        { id: 0, name: "THE FOOL", icon: "ğŸ¤¡", desc: "ê½! ë‹¤ìŒ ê¸°íšŒì—...", type: "none", val: 0, prob: 15, grade: "fail" },
        { id: 1, name: "THE MAGICIAN", icon: "ğŸ©", desc: "ë³€ì´ ì„±ê³µ í™•ë¥  +5%", type: "mutation_prob", val: 5, prob: 10, grade: "low" },
        { id: 2, name: "THE CHARIOT", icon: "ğŸ›’", desc: "ì†Œí™˜ ë¹„ìš© -10%", type: "summon_discount", val: 10, prob: 10, grade: "low" },
        { id: 3, name: "THE EMPRESS", icon: "ğŸ‘‘", desc: "íŒë§¤ ê°€ê²© +10%", type: "sell_bonus", val: 10, prob: 10, grade: "low" },
        { id: 4, name: "STRENGTH", icon: "ğŸ¦", desc: "ê°•í™” ì„±ê³µ +1%", type: "enhance_prob", val: 1, prob: 10, grade: "low" },
        { id: 5, name: "THE LOVERS", icon: "â¤ï¸", desc: "ë³€ì´ ì„±ê³µ í™•ë¥  +15%", type: "mutation_prob", val: 15, prob: 8, grade: "mid" },
        { id: 6, name: "THE HIEROPHANT", icon: "âš–ï¸", desc: "ì†Œí™˜ ë¹„ìš© -30%", type: "summon_discount", val: 30, prob: 8, grade: "mid" },
        { id: 7, name: "THE HERMIT", icon: "ğŸ•¯ï¸", desc: "íŒë§¤ ê°€ê²© +30%", type: "sell_bonus", val: 30, prob: 8, grade: "mid" },
        { id: 8, name: "JUSTICE", icon: "âš”ï¸", desc: "ê°•í™” ì„±ê³µ +2%", type: "enhance_prob", val: 2, prob: 8, grade: "mid" },
        { id: 9, name: "WHEEL OF FORTUNE", icon: "ğŸ¡", desc: "ì†Œí™˜ ë¹„ìš© -50%", type: "summon_discount", val: 50, prob: 5, grade: "high" },
        { id: 10, name: "THE SUN", icon: "â˜€ï¸", desc: "íŒë§¤ ê°€ê²© +50%", type: "sell_bonus", val: 50, prob: 4, grade: "high" },
        { id: 11, name: "THE JUDGEMENT", icon: "ğŸº", desc: "ê°•í™” ì„±ê³µ +3%", type: "enhance_prob", val: 3, prob: 3, grade: "high" },
        { id: 12, name: "THE WORLD", icon: "ğŸŒ", desc: "ê°•í™” ì„±ê³µ +5%", type: "enhance_prob", val: 5, prob: 1, grade: "legendary" }
    ];

    function getRareScore(prob) {
        // [ì•ˆì „ì¥ì¹˜] í™•ë¥ ì´ 0ì´ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ 0ì  ì²˜ë¦¬ (í˜¹ì€ ìµœëŒ€ ì ìˆ˜ ì œí•œ)
        if (prob <= 0 || !isFinite(prob)) return 999999; // 0ì´ ë˜ë©´ ì‚¬ì‹¤ìƒ ë¬´í•œëŒ€ ì ìˆ˜
        
        // ì ìˆ˜ ê³„ì‚° (ë¡œê·¸ ìŠ¤ì¼€ì¼)
        return Math.floor(Math.log10(100 / prob) * 100);
    }

    function formatProb(num) {
        if (typeof num !== 'number') num = parseFloat(num);
        if (isNaN(num)) return "0.00";
        if (num < 0.00001) return num.toFixed(9); 
        if (num < 0.001) return num.toFixed(7);
        return parseFloat(num.toFixed(6)); 
    }

    function getTier(rarity) {
        const val = parseFloat(rarity);
        if (isNaN(val)) return { text: "F", color: "#636e72" };
        if (val < EX_THRESHOLD) return { text: "EX", color: "EX" }; 
        if (val > 30.0) return { text: "F", color: "#636e72" };
        if (val > 15.0) return { text: "C", color: "#00cec9" };
        if (val > 5.0)  return { text: "B", color: "#a29bfe" };
        if (val > 1.0)  return { text: "A", color: "#fab1a0" };
        if (val > 0.1)  return { text: "S", color: "#ff4757" };
        if (val > 0.01) return { text: "SS", color: "#ffd700" };
        return { text: "SSS", color: "#fdcb6e" };
    }

    /* ğŸ‘‡ [ìµœì¢… í†µí•©ë³¸] ì§„í™” ë°ì´í„° ë¦¬ìŠ¤íŠ¸ (ID ì¤‘ë³µ ì™„ë²½ ì œê±°ë¨) */
    const evoPaths = [
        // ==========================================
        // 1. ë ˆì „ë”ë¦¬ / ì—í”½ (ì‹ í™”, ìš°ì£¼, ê°œë…)
        // ==========================================
        { id: "divinity", name: "ì‹ ì„±", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ¥š", "ğŸ•Šï¸", "â˜ï¸", "ğŸŒ"] },
        { id: "jewelry", name: "ë³´ì„", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ“¿", "ğŸ’", "ğŸ‘‘", "âœ¨"] },
        { id: "space", name: "ìš°ì£¼", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ›°ï¸", "ğŸš€", "ğŸ›¸", "ğŸ‘½"] },
        { id: "deep_sea", name: "ì‹¬í•´", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸš", "ğŸ¦€", "ğŸ™", "ğŸ¦ˆ"] },
        { id: "future", name: "ë¯¸ë˜", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ”‹", "âš¡", "ğŸ¤–", "ğŸ›¸"] },
        { id: "time", name: "ì‹œê°„", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ•°ï¸", "â°", "âŒ›", "â³"] },
        { id: "celestial", name: "ì²œì²´", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸŒ‘", "ğŸŒ™", "â˜€ï¸", "ğŸŒŒ"] },
        { id: "knowledge", name: "ì§€ì‹", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ“œ", "ğŸ“–", "ğŸ“", "ğŸ‘ï¸"] },
        { id: "wealth", name: "ì¬í™”", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸª™", "ğŸ’µ", "ğŸ’°", "ğŸ’"] },
        { id: "magic_legend", name: "ë§ˆë²•", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸª„", "ğŸ©", "ğŸ”®", "ğŸ§™"] },
        { id: "love", name: "ì‚¬ë‘", grades: ["ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["â¤ï¸", "ğŸ’–", "ğŸ’˜", "ğŸ’"] },
        { id: "halloween", name: "í• ë¡œìœˆ", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸƒ", "ğŸ‘»", "ğŸ§›", "ğŸ°"] },
        { id: "explosion", name: "í­ë°œ", grades: ["ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ§¨", "ğŸ’¥", "ğŸ”¥", "ğŸŒ‹"] },
        { id: "horror", name: "ê³µí¬", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ•¯ï¸", "ğŸ•¸ï¸", "ğŸ§Ÿ", "ğŸ’€"] },
        { id: "demon_king", name: "ë§ˆì™•", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ¦‡","ğŸ•¸ï¸","ğŸ˜ˆ","ğŸ‘¿"] },
        { id: "necro", name: "ë„¤í¬ë¡œ", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ¦´","ğŸ’€","âš°ï¸","ğŸ§Ÿ"] },
        { id: "rich", name: "ë¶€ì", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸª™","ğŸ’µ","ğŸ’³","ğŸ’"] },
        { id: "weapon_dark", name: "í‰ê¸°", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ”ª","ğŸ©¸","âš°ï¸","ğŸ‘»"] },
        { id: "hero", name: "íˆì–´ë¡œ", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ•¶ï¸", "ğŸ•¸ï¸", "ğŸ¦¸", "ğŸ¦¹"] }, 
        
        // â­ [ì£¼ì˜] ë“œë˜ê³¤ì´ 2ì¢…ë¥˜ë¼ì„œ IDë¥¼ í™•ì‹¤íˆ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.
        { id: "dragon_origin", name: "ë“œë˜ê³¤", grades: ["ì¼ë°˜", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ¥š", "ğŸ¦", "ğŸŠ", "ğŸ²"] },
        { id: "dragon_epic", name: "ë“œë˜ê³¤", grades: ["ì—í”½"], stages: ["ğŸ¥š", "ğŸ²", "ğŸ‰", "ğŸ”¥"] }, // ì´ë¦„ì€ ê°™ì§€ë§Œ IDëŠ” ë‹¤ë¦„

        // ==========================================
        // 2. ì§ì—… / íŒíƒ€ì§€
        // ==========================================
        { id: "warrior", name: "ì „ì‚¬", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ—¡ï¸","âš”ï¸","ğŸ›¡ï¸","ğŸ¤´"] },
        { id: "archer", name: "ê¶ìˆ˜", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¯","ğŸ¹","ğŸ¦…","ğŸ§š"] },
        { id: "priest", name: "ì„±ì§ì", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ•¯ï¸","ğŸ“–","â›ª","ğŸ‘¼"] },
        { id: "thief", name: "ë„ì ", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ’°","ğŸ—ï¸","ğŸ­","ğŸ¥·"] },
        { id: "golem", name: "ê³¨ë ˜", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸª¨","ğŸ§±","ğŸ—¿","ğŸ¤–"] },
        { id: "spirit", name: "ì •ë ¹", grades: ["ë ˆì–´","ì—í”½"], stages: ["âœ¨","ğŸƒ","ğŸŒ¬ï¸","ğŸ§šâ€â™€ï¸"] },
        { id: "alchemy", name: "ì—°ê¸ˆìˆ ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ§ª", "âš—ï¸", "ğŸ”®", "ğŸ§™"] },
        { id: "equipment", name: "ì¥ë¹„", grades: ["ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["â›ï¸", "âš”ï¸", "ğŸ›¡ï¸", "ğŸ‘‘"] },
        { id: "soldier", name: "êµ°ì¸", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸª–","ğŸ”«","ğŸ’£","ğŸ–ï¸"] },
        { id: "doctor", name: "ì˜ì‚¬", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ˜·","ğŸ©º","ğŸ’‰","ğŸ¥"] },
        { id: "developer", name: "ê°œë°œì", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ‘“","ğŸ’»","ğŸ’¾","ğŸ–¥ï¸"] },
        { id: "scientist", name: "ê³¼í•™ì", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ’¡","ğŸ”¬","ğŸ”­","ğŸ§¬"] },
        { id: "painter", name: "í™”ê°€", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["âœï¸","ğŸ–Œï¸","ğŸ¨","ğŸ–¼ï¸"] },
        { id: "musician", name: "ìŒì•…ê°€", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¼","ğŸ§","ğŸ¤","ğŸ¹"] },
        { id: "athlete", name: "ìš´ë™ì„ ìˆ˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ‘Ÿ","âš½","ğŸ€","ğŸ†"] },
        { id: "office", name: "ì‚¬ë¬´", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ“", "ğŸ“‚", "ğŸ–¥ï¸", "ğŸ¢"] },
        { id: "farming", name: "ë†ì‚¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ‘", "ğŸ„", "ğŸšœ", "ğŸŒ¾"] },
        { id: "construction", name: "ê±´ì„¤", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ”¨","ğŸªš","ğŸ—ï¸","ğŸ°"] },
        { id: "cleaning", name: "ì²­ì†Œ", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ§¹", "ğŸ§¼", "ğŸ§½", "ğŸš¿"] },
        { id: "cooking", name: "ìš”ë¦¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ", "ğŸ¥ª", "ğŸ”", "ğŸ±"] },
        
        // ==========================================
        // 3. ë™ë¬¼ / ìƒë¬¼
        // ==========================================
        { id: "cat", name: "ê³ ì–‘ì´", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ§¶","ğŸ¾","ğŸˆ","ğŸ…"] },
        { id: "dog", name: "ê°•ì•„ì§€", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¦´","ğŸ•","ğŸ©","ğŸº"] },
        { id: "rabbit", name: "í† ë¼", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¥•", "ğŸ¾", "ğŸ‡", "ğŸ‘¯"] }, 
        { id: "bear", name: "ê³°", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¯","ğŸ»","ğŸ¼","ğŸ»â€â„ï¸"] },
        { id: "rodent", name: "ì„¤ì¹˜ë¥˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ§€","ğŸ","ğŸ¹","ğŸ¿ï¸"] },
        { id: "reptile", name: "íŒŒì¶©ë¥˜", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¥š","ğŸ","ğŸ¢","ğŸ¦–"] },
        { id: "dinosaur", name: "ê³µë£¡", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ¥š", "ğŸ¦•", "ğŸŒ‹", "ğŸ¦–"] }, 
        { id: "amphibian", name: "ì–‘ì„œë¥˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ’§","ğŸ¸","ğŸŠ","ğŸ‰"] },
        { id: "bird", name: "ì¡°ë¥˜", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¥š", "ğŸ£", "ğŸ“", "ğŸ¦…"] },
        { id: "horse", name: "ë§", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¥•","ğŸ¦“","ğŸ","ğŸ "] },
        { id: "monkey", name: "ì›ìˆ­ì´", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸŒ","ğŸ’","ğŸ¦","ğŸ¦§"] },
        { id: "pig", name: "ë¼ì§€", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¥”","ğŸ–","ğŸ—","ğŸ¥“"] },
        { id: "deer", name: "ì‚¬ìŠ´", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸŒ¿","ğŸ¦Œ","ğŸ„","ğŸ…"] },
        { id: "unicorn", name: "ìœ ë‹ˆì½˜", grades: ["ë§¤ì§", "ë ˆì–´", "ì—í”½"], stages: ["ğŸ¥š", "ğŸ", "ğŸ¦„", "ğŸ "] },
        { id: "slime", name: "ìŠ¬ë¼ì„", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ’§","ğŸ","ğŸ¦ ","ğŸŸ¢"] },
        
        // ==========================================
        // 4. ìŒì‹
        // ==========================================
        { id: "meal", name: "ì‹ì‚¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¥£", "ğŸ¥—", "ğŸ", "ğŸ—"] },
        { id: "japanese_food", name: "ì¼ì‹", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸš","ğŸ™","ğŸ£","ğŸ¤"] },
        { id: "noodle", name: "ë©´ìš”ë¦¬", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸŒ¾","ğŸœ","ğŸ","ğŸ¥"] },
        { id: "fastfood", name: "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¥”","ğŸŸ","ğŸŒ­","ğŸ”"] },
        { id: "dessert", name: "ë””ì €íŠ¸", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¦", "ğŸ©", "ğŸ°", "ğŸ‚"] },
        { id: "baking", name: "ë² ì´í‚¹", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¥¨", "ğŸ¥¯", "ğŸ¥", "ğŸ¥§"] },
        { id: "chocolate", name: "ì´ˆì½œë¦¿", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ«","ğŸª","ğŸ©","ğŸ‚"] },
        { id: "snack", name: "ê°„ì‹", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¬","ğŸ­","ğŸ¿","ğŸ¦"] },
        { id: "fruit", name: "ê³¼ì¼", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ‡", "ğŸ“", "ğŸ‘", "ğŸ"] },
        { id: "tropical_fruit", name: "ì—´ëŒ€ê³¼ì¼", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ’","ğŸ","ğŸ¥­","ğŸ¥¥"] },
        { id: "vegetable", name: "ì±„ì†Œ", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¥¦","ğŸ¥’","ğŸŒ½","ğŸ¥—"] },
        { id: "seafood", name: "í•´ì‚°ë¬¼", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ£","ğŸŸ","ğŸ¦","ğŸ±"] },
        { id: "beverage", name: "ìŒë£Œ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["â˜•", "ğŸ¥¤", "ğŸº", "ğŸ·"] },
        { id: "alcohol", name: "ìˆ ", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ‡", "ğŸ·","ğŸº","ğŸ¥‚"] },
        { id: "cafe", name: "ì¹´í˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ«˜","â˜•","ğŸ¥›","ğŸ¥"] },
        
        // ==========================================
        // 5. ìƒí™œ / ì‚¬ë¬¼
        // ==========================================
        { id: "life", name: "ì¸ìƒ", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ‘¶", "ğŸ‘¦", "ğŸ‘¨", "ğŸ‘´"] }, 
        { id: "school", name: "í•™êµ", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["âœï¸", "ğŸ’", "ğŸ«", "ğŸ“"] }, 
        { id: "game", name: "ê²Œì„", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ•¹ï¸", "ğŸ’¾", "ğŸ®", "ğŸ‘¾"] }, 
        { id: "virus", name: "ë°”ì´ëŸ¬ìŠ¤", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¤§", "ğŸ˜·", "ğŸ¦ ", "ğŸ’‰"] }, 
        { id: "fashion", name: "íŒ¨ì…˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ§µ", "ğŸ‘—", "ğŸ‘ ", "ğŸ’"] }, 
        { id: "photo", name: "ì‚¬ì§„", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸï¸", "ğŸ“·", "ğŸ“¸", "ğŸ–¼ï¸"] }, 
        { id: "garden", name: "ì •ì›", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ’§", "ğŸŒ±", "ğŸŒ»", "ğŸ¡"] }, 
        { id: "kingdom", name: "ì™•êµ­", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ§±", "ğŸ°", "ğŸ›¡ï¸", "ğŸ‘‘"] }, 
        { id: "party", name: "íŒŒí‹°", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸˆ", "ğŸ", "ğŸ‚", "ğŸ¥³"] }, 
        { id: "internet", name: "ì¸í„°ë„·", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ’»", "ğŸŒ", "â˜ï¸", "ğŸ“±"] }, 
        { id: "shopping", name: "ì‡¼í•‘", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ‘›", "ğŸ‘ ", "ğŸ›ï¸", "ğŸ’³"] }, 
        { id: "city", name: "ë„ì‹œ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ§±", "ğŸ ", "ğŸ¢", "ğŸ™ï¸"] },
        { id: "clothing", name: "ì˜ë¥˜", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ§¶", "ğŸ‘•", "ğŸ‘”", "ğŸ•´ï¸"] },
        { id: "ruins", name: "ìœ ì ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["â›ï¸", "ğŸ”¦", "ğŸ¦´", "ğŸº"] },
        { id: "plant", name: "ì‹ë¬¼", grades: ["ì¼ë°˜", "ë§¤ì§", "ë ˆì–´"], stages: ["ğŸŒ±", "ğŸŒ·", "ğŸŒ³", "ğŸ„"] },
        { id: "ocean", name: "ë°”ë‹¤", grades: ["ë§¤ì§", "ë ˆì–´", "ì—í”½"], stages: ["ğŸ’§", "ğŸŒŠ", "ğŸ³", "ğŸ‹"] },
        { id: "insect", name: "ê³¤ì¶©", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ›", "ğŸ", "ğŸ¦‹", "ğŸ§š"] },
        { id: "meteorology", name: "ê¸°ìƒ", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["â˜€ï¸", "ğŸŒ¤ï¸", "ğŸŒ¦ï¸", "ğŸŒˆ"] },
        { id: "weather", name: "ë‚ ì”¨", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["â˜ï¸", "â›ˆï¸", "ğŸŒªï¸", "ğŸŒˆ"] },
        { id: "rain", name: "ë¹„", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["â˜‚ï¸", "â˜”", "â˜ƒï¸", "ğŸŒˆ"] },
        { id: "winter", name: "ê²¨ìš¸", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["â„ï¸", "â˜ƒï¸", "â›·ï¸", "ğŸ”ï¸"] },
        { id: "tech", name: "ê¸°ìˆ ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ“Ÿ", "ğŸ“±", "ğŸ’»", "ğŸ›°ï¸"] },
        { id: "transport", name: "ìš´ì†¡", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸš²", "ğŸš—", "ğŸš", "ğŸš€"] },
        { id: "myth", name: "ì‹ í™”", grades: ["ì¼ë°˜", "ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ—¿", "ğŸº", "ğŸ›ï¸", "ğŸ”±"] },
        { id: "jungle", name: "ì •ê¸€", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ’", "ğŸ¦", "ğŸ¦", "ğŸ˜"] },
        { id: "music", name: "ìŒì•…", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸµ", "ğŸ¸", "ğŸ¹", "ğŸ·"] },
        { id: "sports", name: "ìŠ¤í¬ì¸ ", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["âš½", "ğŸ€", "ğŸˆ", "ğŸ†"] },
        { id: "western", name: "ì„œë¶€", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸŒµ", "ğŸ¤ ", "ğŸ", "ğŸœï¸"] },
        { id: "asia", name: "ì•„ì‹œì•„", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ‹", "ğŸ®", "â›©ï¸", "ğŸ‰"] },
        { id: "art", name: "ì˜ˆìˆ ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ¨", "ğŸ–Œï¸", "ğŸ–¼ï¸", "ğŸ›ï¸"] },
        { id: "communication", name: "í†µì‹ ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["âœ‰ï¸", "ğŸ“", "ğŸ“±", "ğŸ›°ï¸"] },
        { id: "furniture", name: "ê°€êµ¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ›‹ï¸", "ğŸ›ï¸", "ğŸª‘", "ğŸ "] },
        { id: "tool", name: "ë„êµ¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ”¨", "ğŸªš", "ğŸ§°", "ğŸ—ï¸"] },
        { id: "medical", name: "ì˜ë£Œ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ’Š", "ğŸ©º", "ğŸš‘", "ğŸ¥"] },
        { id: "camping", name: "ìº í•‘", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["â›º", "ğŸ•ï¸", "ğŸ›¶", "â›°ï¸"] },
        { id: "toy", name: "ì¥ë‚œê°", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ§¸", "ğŸª", "ğŸ®", "ğŸ‘¾"] },
        { id: "clock", name: "ì‹œê³„", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["â³","ğŸ•°ï¸","âŒš","ğŸ—“ï¸"] },
        { id: "luck", name: "í–‰ìš´", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ€","ğŸ²","ğŸ°","ğŸ±"] },
        { id: "letter", name: "í¸ì§€", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ’Œ","ğŸ€","ğŸ’","â¤ï¸"] },
        { id: "travel", name: "ì—¬í–‰", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ—ºï¸","ğŸ§­","ğŸ§³","âœˆï¸"] },
        { id: "sailing", name: "í•­í•´", grades: ["ë ˆì–´","ì—í”½"], stages: ["âš“","â›µ","ğŸš¢","ğŸï¸"] },
        { id: "fireworks", name: "ë¶ˆê½ƒ", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ”¥","ğŸ•¯ï¸","ğŸ§¨","ğŸ‡"] },
        { id: "electricity", name: "ì „ê¸°", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ”Œ","ğŸ”‹","âš¡","ğŸ’¡"] },

        // ==========================================
        // 6. ì‹ ê·œ ì¶”ê°€ëœ 50ì¢… (ì¤‘ë³µ ì²´í¬ ì™„ë£Œ)
        // ==========================================
        { id: "stationery", name: "í•„ê¸°êµ¬", grades: ["ì¼ë°˜"], stages: ["âœï¸","ğŸ–Šï¸","ğŸ–ï¸","ğŸ–Œï¸"] },
        { id: "cleaning_big", name: "ëŒ€ì²­ì†Œ", grades: ["ì¼ë°˜"], stages: ["ğŸ§¹","ğŸ§½","ğŸ§¼","ğŸ§º"] },
        { id: "mail", name: "ìš°í¸", grades: ["ì¼ë°˜"], stages: ["âœ‰ï¸","ğŸ“©","ğŸ“«","ğŸ“®"] },
        { id: "door", name: "ë¬¸", grades: ["ì¼ë°˜"], stages: ["ğŸšª","ğŸ›—","ğŸ—ï¸","ğŸ”"] },
        { id: "time_modern", name: "íƒ€ì„", grades: ["ì¼ë°˜"], stages: ["â³","âŒ›","âŒš","â°"] },
        { id: "energy", name: "ì—ë„ˆì§€", grades: ["ì¼ë°˜"], stages: ["ğŸ”Œ","ğŸ”‹","ğŸ’¡","ğŸ”¦"] },
        { id: "paper", name: "ì¢…ì´", grades: ["ì¼ë°˜"], stages: ["ğŸ“„","ğŸ“ƒ","ğŸ“‘","ğŸ“°"] },
        { id: "mart", name: "ë§ˆíŠ¸", grades: ["ì¼ë°˜"], stages: ["ğŸ›ï¸","ğŸ›’","ğŸ·ï¸","ğŸ’³"] },
        { id: "bathroom", name: "ìš•ì‹¤", grades: ["ì¼ë°˜"], stages: ["ğŸš¿","ğŸ›","ğŸš½","ğŸ§»"] },
        { id: "tools", name: "ê³µêµ¬", grades: ["ì¼ë°˜"], stages: ["ğŸ”©","ğŸ”§","ğŸ”¨","ğŸ—œï¸"] },
        { id: "soccer", name: "ì¶•êµ¬", grades: ["ë§¤ì§"], stages: ["âš½","ğŸ‘Ÿ","ğŸ¥…","ğŸ†"] },
        { id: "basketball", name: "ë†êµ¬", grades: ["ë§¤ì§"], stages: ["ğŸ€","â›¹ï¸","ğŸ‘Ÿ","ğŸ—‘ï¸"] },
        { id: "fishing", name: "ë‚šì‹œ", grades: ["ë§¤ì§"], stages: ["ğŸª±","ğŸ£","ğŸŸ","ğŸ¡"] },
        { id: "fine_art", name: "ë¯¸ìˆ ", grades: ["ë§¤ì§"], stages: ["ğŸ¨","ğŸ§‘â€ğŸ¨","ğŸ–¼ï¸","ğŸ­"] },
        { id: "concert", name: "ì½˜ì„œíŠ¸", grades: ["ë§¤ì§"], stages: ["ğŸ¼","ğŸ»","ğŸ·","ğŸ¸"] },
        { id: "movie", name: "ì˜í™”", grades: ["ë§¤ì§"], stages: ["ğŸ¬","ğŸï¸","ğŸ¿","ğŸ¥"] },
        { id: "hospital", name: "ë³‘ì›", grades: ["ë§¤ì§"], stages: ["ğŸ’Š","ğŸ’‰","ğŸ©º","ğŸ¥"] },
        { id: "experiment", name: "ì‹¤í—˜", grades: ["ë§¤ì§"], stages: ["ğŸ§«","ğŸ§ª","ğŸ§¬","ğŸ”¬"] },
        { id: "chef", name: "ìš”ë¦¬ì‚¬", grades: ["ë§¤ì§"], stages: ["ğŸ”ª","ğŸ³","ğŸ¥˜","ğŸ‘¨â€ğŸ³"] },
        { id: "police", name: "ê²½ì°°", grades: ["ë§¤ì§"], stages: ["ğŸš¨","ğŸš”","ğŸ”«","ğŸ‘®"] },
        { id: "desert", name: "ì‚¬ë§‰", grades: ["ë ˆì–´"], stages: ["ğŸœï¸","ğŸ¦‚","ğŸ¦","ğŸª"] },
        { id: "volcano", name: "í™”ì‚°", grades: ["ë ˆì–´"], stages: ["ğŸŒ‹","ğŸ”¥","ğŸ§¨","ğŸ’£"] },
        { id: "shark", name: "ìƒì–´", grades: ["ë ˆì–´"], stages: ["ğŸ’§","ğŸŸ","ğŸ¦ˆ","ğŸŒŠ"] },
        { id: "jurassic", name: "ì¥¬ë¼ê¸°", grades: ["ë ˆì–´"], stages: ["ğŸ¥š","ğŸ¦–","ğŸ¦•","ğŸ¦´"] },
        { id: "train", name: "ê¸°ì°¨", grades: ["ë ˆì–´"], stages: ["ğŸ›¤ï¸","ğŸš‚","ğŸš†","ğŸš…"] },
        { id: "construction_site", name: "ê³µì‚¬ì¥", grades: ["ë ˆì–´"], stages: ["ğŸ§±","ğŸ—ï¸","ğŸšœ","ğŸ¢"] },
        { id: "flight", name: "ë¹„í–‰", grades: ["ë ˆì–´"], stages: ["ğŸª‚","ğŸš","âœˆï¸","ğŸ›«"] },
        { id: "jungle_dense", name: "ë°€ë¦¼", grades: ["ë ˆì–´"], stages: ["ğŸŒ¿","ğŸ¦","ğŸ†","ğŸ¦œ"] },
        { id: "crystal", name: "í¬ë¦¬ìŠ¤íƒˆ", grades: ["ë ˆì–´"], stages: ["ğŸ’","ğŸ’","ğŸ‘‘","ğŸ”®"] }, 
        { id: "fortress", name: "ìš”ìƒˆ", grades: ["ë ˆì–´"], stages: ["ğŸ›¡ï¸","âš”ï¸","ğŸ°","ğŸ¯"] },
        { id: "ghost", name: "ìœ ë ¹", grades: ["ì—í”½"], stages: ["ğŸ•¯ï¸","ğŸ‘»","ğŸ§Ÿ","ğŸ’€"] },
        { id: "wizard", name: "ìœ„ìë“œ", grades: ["ì—í”½"], stages: ["âœ¨","ğŸ§™","ğŸª„","ğŸ©"] },
        { id: "mermaid", name: "ì¸ì–´", grades: ["ì—í”½"], stages: ["ğŸš","ğŸª¸","ğŸ§œâ€â™€ï¸","ğŸ”±"] },
        { id: "vampire", name: "ë±€íŒŒì´ì–´", grades: ["ì—í”½"], stages: ["ğŸ·","ğŸ¦‡","ğŸ§›","âš°ï¸"] },
        { id: "thunder", name: "ì²œë‘¥", grades: ["ì—í”½"], stages: ["â˜ï¸","â›ˆï¸","âš¡","ğŸŒªï¸"] },
        { id: "ice", name: "ì–¼ìŒ", grades: ["ì—í”½"], stages: ["â„ï¸","â˜ƒï¸","ğŸ§Š","ğŸ¥¶"] },
        { id: "alien", name: "ì™¸ê³„ì¸", grades: ["ì—í”½"], stages: ["ğŸ“¡","ğŸ›¸","ğŸ‘½","ğŸ‘¾"] },
        { id: "goblin", name: "ë„ê¹¨ë¹„", grades: ["ì—í”½"], stages: ["ğŸ‘º","ğŸ‘¹","ğŸ­","ğŸ§§"] },
        { id: "angel", name: "ì²œì‚¬", grades: ["ì—í”½"], stages: ["ğŸª½","ğŸ•Šï¸","ğŸ‘¼","ğŸŒ¥ï¸"] },
        { id: "galaxy", name: "ì€í•˜", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸš€","ğŸ§‘â€ğŸš€","ğŸŒ‘","ğŸŒŒ"] },
        { id: "planet", name: "í–‰ì„±", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸŒ","ğŸª","â˜€ï¸","â­"] },
        { id: "timeline", name: "íƒ€ì„ë¼ì¸", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ•°ï¸","ğŸ“…","ğŸ“†","â™¾ï¸"] },
        { id: "gamble", name: "ê²œë¸”", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ²","ğŸƒ","ğŸ°","ğŸ¤‘"] },
        { id: "royalty", name: "ì™•ê¶Œ", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ¤´","ğŸ‘¸","ğŸ°","ğŸ‘‘"] },
        { id: "religion", name: "ì¢…êµ", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ›","ğŸ•‰ï¸","â˜¯ï¸","â˜®ï¸"] },
        { id: "romance", name: "ë¡œë§¨ìŠ¤", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ’Œ","ğŸŒ¹","ğŸ’","ğŸ’–"] },
        { id: "digital", name: "ë””ì§€í„¸", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ’¾","ğŸ’¿","ğŸ’»","ğŸ¤–"] },
        { id: "festival", name: "ì¶•ì œ", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ‰","ğŸŠ","ğŸ‡","ğŸ†"] },
        { id: "olympus", name: "ì˜¬ë¦¼í‘¸ìŠ¤", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ“œ","ğŸ›ï¸","ğŸº","ğŸ”±"] }
    ];

    /* --- [2. ë“±ê¸‰ë³„ ì˜¬í´ë¦¬ì–´ ë³´ìƒ ì„¤ì • (50ì–µ í†µì¼)] --- */
    const gradeCompletionRewards = {
        "ì¼ë°˜": 5000000000,
        "ë§¤ì§": 5000000000,
        "ë ˆì–´": 5000000000,
        "ì—í”½": 5000000000,
        "ë ˆì „ë”ë¦¬": 5000000000
    };
    // ë³´ìƒ ìˆ˜ë ¹ ê¸°ë¡ ë°°ì—´ ì´ˆê¸°í™”
    if (!window.claimedGradeRewards) window.claimedGradeRewards = [];

    // [ì¶”ê°€ë¨] ë“±ê¸‰ ì •ë³µ(ì˜¬í´ë¦¬ì–´) ë³´ìƒ ìˆ˜ë ¹ í•¨ìˆ˜
    window.claimGradeMasteryReward = (grade) => {
        if(window.claimedGradeRewards.includes(grade)) return;
        
        const reward = gradeCompletionRewards[grade] || 0;
        window.gold += reward;
        window.claimedGradeRewards.push(grade);
        
        addLog(`ğŸ† [${grade}] ë“±ê¸‰ ì™„ì „ ì •ë³µ! ë³´ìƒ +${reward.toLocaleString()}`);
        alert(`ğŸ† ëŒ€ë‹¨í•©ë‹ˆë‹¤!\n[${grade}] ë“±ê¸‰ì˜ ëª¨ë“  ë„ê°ì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!\n\níŠ¹ë³„ ë³´ìƒ: ${reward.toLocaleString()} ê³¨ë“œ ì§€ê¸‰!`);
        
        saveGame(0);
        updateUI();
        renderBookGrid(); // ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
    };

    window.gold = 200000; window.nickname = ""; window.currentEmoji = null; 
    window.myHistory = []; window.selectedInvIdx = null;
    window.inventory = Array(10).fill(null).map((_, i) => ({ unlocked: i < 1, item: null }));
    window.book = {}; window.claimedRewards = [];
    window.bestProb = 1; // [ë­í‚¹ìš©] ì´ˆê¸° ìµœê³  ê¸°ë¡

    window.maxGold = 200000;
    window.maxGoldDate = Date.now();
    window.lastRewardDate = 0;
    window.currentBookTab = 'ì¼ë°˜'; 
    
    // [ğŸ”® íƒ€ë¡œ] ê¸€ë¡œë²Œ ë³€ìˆ˜
    window.tarotBuff = null; 
    window.todayTarotCount = 0; 
    window.tarotRerollCost = 50000000; 
    window.lastTarotDate = 0; 

    let saveTimeout = null;
    let cachedRarityRank = null;
    let cachedWealthRank = null;
    let lastRankFetch = 0;
    
    window.currentRankTab = 'rarity';
    let isJoinMode = false;
    window.currentUserUid = null;

    window.addLog = (msg) => { 
        const lb = document.getElementById('game-log'); 
        const d = document.createElement('div'); 
        d.innerText = `> ${msg}`; 
        lb.appendChild(d); 
        lb.scrollTop = lb.scrollHeight; 
    };
    window.vibrate = () => { if(navigator.vibrate) navigator.vibrate(10); };
    
    function getWeeklyStartTimestamp() {
        const now = new Date();
        const kstOffset = 9 * 60 * 60 * 1000;
        const kstNow = new Date(now.getTime() + kstOffset);
        const day = kstNow.getUTCDay(); 
        const diffToMonday = day === 0 ? 6 : day - 1;
        const startOfWeek = new Date(kstNow);
        startOfWeek.setUTCDate(kstNow.getUTCDate() - diffToMonday);
        startOfWeek.setUTCHours(0, 0, 0, 0);
        return startOfWeek.getTime() - kstOffset;
    }

    function updateResetTimer() {
        const now = new Date();
        const kstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        const day = kstNow.getUTCDay();
        const daysUntilMonday = day === 0 ? 1 : 8 - day;
        const target = new Date(kstNow);
        target.setUTCDate(kstNow.getUTCDate() + daysUntilMonday);
        target.setUTCHours(0,0,0,0);
        const diffMs = target.getTime() - kstNow.getTime();
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const remainHrs = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const el = document.getElementById('reset-timer');
        el.innerText = `ì£¼ê°„ë­í‚¹ ê°±ì‹ ê¹Œì§€ ${diffDays}ì¼ ${remainHrs}ì‹œê°„ ${diffMins}ë¶„ ë‚¨ìŒ`;
    }
    setInterval(updateResetTimer, 60000); 

    function isGameModalOpen() {
        return Array.from(document.querySelectorAll('.full-page')).some(el => 
            el.id !== 'exit-modal' && el.style.display === 'block'
        );
    }
    
    window.realExit = () => { window.logout(); };
    window.cancelExit = () => { document.getElementById('exit-modal').style.display = 'none'; };

    window.addEventListener('popstate', () => {
        const exitModal = document.getElementById('exit-modal');
        if (exitModal.style.display === 'flex') {
            exitModal.style.display = 'none';
            history.pushState({ main: true }, '', '');
            return;
        }
        if (isGameModalOpen()) {
            document.querySelectorAll('.full-page').forEach(el => {
                if(el.id !== 'exit-modal') el.style.display = 'none';
            });
            window.selectedInvIdx = null;
            if(window.renderInventory) window.renderInventory();
            return;
        }
        history.pushState({ main: true }, '', ''); 
        exitModal.style.display = 'flex';
    });

    window.addEventListener('beforeunload', () => {
        saveGame(0); 
    });

    function checkBookAlert() {
        if(!window.book) return;
        const alertDot = document.getElementById('book-alert');
        let hasReward = false;
        for (const key in window.book) {
            const level = window.book[key];
            if (level >= 4 && !window.claimedRewards.includes(key)) {
                hasReward = true;
                break;
            }
        }
        if(hasReward) alertDot.style.display = 'block';
        else alertDot.style.display = 'none';
    }

    window.closePage = (id) => { 
        if (id === 'tarot-modal' && window.tarotTimerInt) {
            clearInterval(window.tarotTimerInt);
            window.tarotTimerInt = null;
        }
        if (history.state && history.state.modal) {
            history.back();
        } else {
            document.getElementById(id).style.display = 'none'; 
            window.selectedInvIdx = null; 
            renderInventory(); 
        }
    };
    
    function updateBook(pathName, level, originalGrade) {
        if(!window.book) window.book = {};
        if(!originalGrade) return; 
        const key = `${pathName}_${originalGrade}`;
        const stageIdx = Math.min(4, Math.floor(level / 5) + 1); 
        if (!window.book[key] || window.book[key] < stageIdx) {
            window.book[key] = stageIdx;
        }
    }

    window.tarotTimerInt = null;
    async function getNetworkTime() {
        try {
            const response = await fetch(window.location.href, { method: 'HEAD', cache: 'no-store' });
            const dateStr = response.headers.get('Date');
            if (dateStr) return new Date(dateStr);
        } catch (e) { console.log("ì‹œê°„ ë™ê¸°í™” ì‹¤íŒ¨"); }
        return new Date(); 
    }

    async function checkDailyTarotReset() {
        const now = await getNetworkTime(); 
        const kstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        const todayStr = kstNow.toISOString().split('T')[0];
        
        const lastDate = new Date(window.lastTarotDate);
        const lastDateStr = new Date(lastDate.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0];

        if(todayStr !== lastDateStr) {
            window.todayTarotCount = 0; 
            window.tarotBuff = null; // [ì¶”ê°€] ë‚ ì§œ ì§€ë‚¬ìœ¼ë‹ˆ íš¨ê³¼ ì œê±°
            addLog("ğŸ“… í•˜ë£¨ê°€ ì§€ë‚¬ìŠµë‹ˆë‹¤. íƒ€ë¡œ ìš´ì„¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); 
            saveGame(0);
            updateUI(); // [ì¶”ê°€] ì¦‰ì‹œ ë°°ë„ˆ ìƒ‰ìƒ ë³€ê²½ ë°˜ì˜
            return true;
        }
        return false;
    }
        /* --- [ëˆ„ë½ëœ ì¤‘ê°„ ì½”ë“œ ì‹œì‘: íƒ€ë¡œ, ì¸ë²¤í† ë¦¬, ë„ê° ê¸°ëŠ¥] --- */

    // [íƒ€ë¡œ] ëª¨ë‹¬ ì—´ê¸°
    window.openTarotModal = async () => {
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', '');
        document.getElementById('tarot-modal').style.display = 'block';
        document.getElementById('tarot-reset-timer').innerText = "â³ ì„œë²„ ì‹œê°„ í™•ì¸ ì¤‘...";

        await checkDailyTarotReset();
        
        if(window.tarotTimerInt) clearInterval(window.tarotTimerInt);
        updateTarotTimer(); 
        window.tarotTimerInt = setInterval(updateTarotTimer, 1000);

        renderTarotTable();
        updateTarotBtnState();
        
        const cardEl = document.getElementById('tarot-card-el');
        const textEl = document.getElementById('tarot-fortune-text');
        
        if(window.tarotBuff) {
            cardEl.classList.add('is-flipped');
            const info = tarotCards.find(c => c.id === window.tarotBuff.id);
            updateTarotFace(info);
            textEl.innerText = getRandomFortuneMsg(info.grade);
            textEl.classList.add('show');
        } else {
            cardEl.classList.remove('is-flipped');
            textEl.innerText = "ì¹´ë“œë¥¼ í„°ì¹˜í•˜ì—¬ ë’¤ì§‘ìœ¼ì„¸ìš”...";
            textEl.classList.remove('show');
        }
        document.getElementById('tarot-my-gold').innerText = window.gold.toLocaleString() + " ğŸŸ¡";
    };

    function updateTarotTimer() {
        const now = new Date(); 
        const kstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        const nextMidnight = new Date(kstNow);
        nextMidnight.setUTCHours(24, 0, 0, 0); 
        const diff = nextMidnight.getTime() - kstNow.getTime();
        
        if (diff <= 0) {
            document.getElementById('tarot-reset-timer').innerText = "â° ë¦¬ì…‹ í™•ì¸ ì¤‘...";
            checkDailyTarotReset().then(() => updateTarotBtnState());
            return;
        }
        const h = Math.floor(diff / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('tarot-reset-timer').innerText = `â° ë¦¬ì…‹ê¹Œì§€: ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function renderTarotTable() {
        const tbody = document.getElementById('tarot-table-body');
        tbody.innerHTML = "";
        tarotCards.forEach(card => {
            const tr = document.createElement('tr');
            const isActive = (window.tarotBuff && window.tarotBuff.id === card.id);
            if(isActive) tr.classList.add('tarot-row-active');
            const isSecret = (card.grade === 'high' || card.grade === 'legendary') && !isActive;
            
            const iconTd = document.createElement('td'); iconTd.innerText = card.icon; iconTd.style.fontSize = "1rem";
            const nameTd = document.createElement('td'); nameTd.innerText = card.name.replace("THE ", "");
            const effectTd = document.createElement('td');
            if(isSecret) { effectTd.innerText = "???"; } 
            else {
                if(card.grade === 'fail') effectTd.innerText = "-";
                else if(card.type === 'enhance_prob') effectTd.innerHTML = `ì„±ê³µ <span style="color:#00cec9">+${card.val}%</span>`;
                else if(card.type === 'summon_discount') effectTd.innerHTML = `ë¹„ìš© <span style="color:#74b9ff">-${card.val}%</span>`;
                else if(card.type === 'sell_bonus') effectTd.innerHTML = `íŒë§¤ <span style="color:#ffd700">+${card.val}%</span>`;
                else if(card.type === 'mutation_prob') effectTd.innerHTML = `ë³€ì´ ì„±ê³µ <span style="color:#a29bfe">+${card.val}%</span>`;
            }
            tr.appendChild(iconTd); tr.appendChild(nameTd); tr.appendChild(effectTd); tbody.appendChild(tr);
        });
    }

    function updateTarotBtnState() {
        const btn = document.getElementById('btn-reroll');
        const txt = document.getElementById('reroll-btn-text');
        const costTxt = document.getElementById('reroll-cost-text');
        if(window.todayTarotCount === 0) { btn.style.display = 'none'; } 
        else {
            btn.style.display = 'block'; txt.innerText = "ğŸ”„ ìš´ëª… ë°”ê¾¸ê¸°";
            costTxt.innerText = `ë¹„ìš©: ${window.tarotRerollCost.toLocaleString()} ğŸŸ¡`;
            if(window.gold < window.tarotRerollCost) { btn.disabled = true; btn.style.opacity = "0.5"; } 
            else { btn.disabled = false; btn.style.opacity = "1"; }
        }
    }

    window.flipTarotCard = () => { if(window.todayTarotCount > 0 && window.tarotBuff) return; performTarotDraw(); };

    window.rerollTarot = () => {
        if(window.gold < window.tarotRerollCost) return;
        if(confirm(`í˜„ì¬ ìš´ëª…ì„ ë²„ë¦¬ê³  ë‹¤ì‹œ ë½‘ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?\në¹„ìš©: ${window.tarotRerollCost.toLocaleString()} ê³¨ë“œ`)) {
            window.gold -= window.tarotRerollCost;
            const cardEl = document.getElementById('tarot-card-el');
            cardEl.classList.remove('is-flipped'); 
            document.getElementById('tarot-fortune-text').classList.remove('show');
            setTimeout(() => { performTarotDraw(); }, 800); 
        }
    };

    function performTarotDraw() {
        let r = Math.random() * 100; let acc = 0; let selected = tarotCards[0];
        for(let c of tarotCards) { acc += c.prob; if(r <= acc) { selected = c; break; } }
        window.tarotBuff = selected; window.todayTarotCount++; window.lastTarotDate = Date.now();
        
        updateTarotFace(selected);
        document.getElementById('tarot-card-el').classList.add('is-flipped');
        const textEl = document.getElementById('tarot-fortune-text');
        textEl.innerText = getRandomFortuneMsg(selected.grade);
        textEl.classList.add('show');
        addLog(`ğŸ”¯ íƒ€ë¡œ ê²°ê³¼: [${selected.name}]`); window.vibrate();
        saveGame(0); updateUI(); 
        setTimeout(() => { renderTarotTable(); updateTarotBtnState(); document.getElementById('tarot-my-gold').innerText = window.gold.toLocaleString() + " ğŸŸ¡"; }, 600);
    }

    function updateTarotFace(card) {
        document.getElementById('tarot-result-icon').innerText = card.icon;
        document.getElementById('tarot-result-name').innerText = card.name;
        document.getElementById('tarot-result-desc').innerText = card.desc;
    }

    function getRandomFortuneMsg(grade) {
        const msgs = {
            "fail": ["íë¦¼... ì˜¤ëŠ˜ì€ ì¡°ì‹¬í•˜ëŠ” ê²Œ ì¢‹ê² êµ°ìš”.", "ìš•ì‹¬ì„ ë²„ë ¤ì•¼ í•  ë•Œì…ë‹ˆë‹¤.", "ì ì‹œ ì‰¬ì–´ê°€ë„ ì¢‹ìŠµë‹ˆë‹¤."],
            "low": ["ì†Œì†Œí•œ í–‰ìš´ì´ ë”°ë¦…ë‹ˆë‹¤.", "ë‚˜ì˜ì§€ ì•Šì€ íë¦„ì´ë„¤ìš”.", "ë…¸ë ¥í•˜ë©´ ë‹¿ì„ ê±°ë¦¬ì…ë‹ˆë‹¤."],
            "mid": ["ì¢‹ì€ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤!", "ë§ì„¤ì´ì§€ ë§ê³  ë„ì „í•˜ì„¸ìš”.", "ìˆœí’ì´ ë¶ˆê³  ìˆìŠµë‹ˆë‹¤."],
            "high": ["ëŒ€ë°•ì˜ ì§•ì¡°ê°€ ë³´ì…ë‹ˆë‹¤!!", "ì§€ê¸ˆì´ ë°”ë¡œ ê¸°íšŒì…ë‹ˆë‹¤!", "ìš´ëª…ì´ ë‹¹ì‹  í¸ì…ë‹ˆë‹¤."],
            "legendary": ["ì „ì„¤ì ì¸ í–‰ìš´ì…ë‹ˆë‹¤!!!", "ì„¸ìƒì´ ë‹¹ì‹ ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë•ë‹ˆë‹¤!", "ë¬´ì—‡ì„ í•´ë„ ë˜ëŠ” ë‚ !"]
        };
        const list = msgs[grade] || msgs["low"];
        return list[Math.floor(Math.random() * list.length)];
    }

    // [ì¸ë²¤í† ë¦¬]
    window.openInventory = () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', '');
        document.getElementById('inv-page').style.display = 'block';
        renderInventory(); 
    };

    window.renderInventory = () => {
        const grid = document.getElementById('inv-grid-list'); grid.innerHTML = "";
        window.inventory.forEach((slot, i) => {
            const div = document.createElement('div'); div.className = `inv-slot ${slot.unlocked ? '' : 'locked'} ${window.selectedInvIdx === i ? 'selected' : ''}`;
            if (!slot.unlocked) {
                const price = i < 5 ? "1ì–µ" : "2ì–µ";
                div.innerHTML = `ğŸ”’<br>${price}`;
            }
            else if (slot.item) { 
                const pathObj = evoPaths.find(p => p.name === slot.item.pathName) || { stages: ["â“", "â“", "â“", "â“"] };
                const currentIcon = pathObj.stages[Math.min(3, Math.floor(slot.item.level / 5))];
                div.style.borderColor = gradeInfo[slot.item.grade].color; 
                div.innerHTML = `<span class="inv-emoji">${currentIcon}</span><div class="inv-tag">+${slot.item.level}</div>`; 
            }
            div.onclick = () => handleSlotClick(i); grid.appendChild(div);
        });
    }

    window.swapWithMain = () => {
        if (window.selectedInvIdx === null) return;
        if (window.currentEmoji && window.currentEmoji.gone) { addLog("ğŸš« íŒŒê´´ëœ ì´ëª¨ì§€ëŠ” ì¸ë²¤í† ë¦¬ì— ë„£ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        const slot = window.inventory[window.selectedInvIdx];
        if (!slot || !slot.unlocked) return;
        if (!slot.item && !window.currentEmoji) return;
        const temp = window.currentEmoji; window.currentEmoji = slot.item; slot.item = temp; 
        window.selectedInvIdx = null; saveGame(1000); updateUI(); renderInventory();
    };

    window.handleSlotClick = async (idx) => {
        let slot = window.inventory[idx];
        if (!slot.unlocked) { 
            const cost = idx < 5 ? 100000000 : 200000000;
            if (window.gold >= cost && confirm(`ìŠ¬ë¡¯ ì ê¸ˆ í•´ì œ? (${idx < 5 ? "1ì–µ":"2ì–µ"} ê³¨ë“œ)`)) { 
                window.gold -= cost; slot.unlocked = true; saveGame(1000); renderInventory(); updateUI(); 
            } return; 
        }
        if (window.selectedInvIdx === null) {
            if (slot.item) { window.selectedInvIdx = idx; renderInventory(); } 
            else {
                if (window.currentEmoji && !window.currentEmoji.gone) { 
                    slot.item = window.currentEmoji; window.currentEmoji = null; 
                    addLog("ğŸ’ ì¸ë²¤í† ë¦¬ì— ë³´ê´€í•¨."); window.vibrate(); saveGame(1000); updateUI(); renderInventory(); 
                } 
            }
        } else {
            if (window.selectedInvIdx === idx) { window.swapWithMain(); } 
            else { 
                let temp = window.inventory[window.selectedInvIdx].item; 
                window.inventory[window.selectedInvIdx].item = slot.item; slot.item = temp; 
                window.selectedInvIdx = null; saveGame(1000); renderInventory(); 
            }
        }
    }
    document.getElementById('display-area').onclick = () => { if (window.selectedInvIdx !== null) { window.swapWithMain(); } };

    // [ë„ê°]
        // [ì¶”ê°€ë¨] ë„ê° íƒ­ì— ë³´ìƒ ì•Œë¦¼ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateGradeTabAlerts() {
        const grades = ["ì¼ë°˜", "ë§¤ì§", "ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"];
        // íƒ­ ë²„íŠ¼ë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const tabs = document.querySelectorAll('.book-tab-btn');
        
        grades.forEach((g, idx) => {
            let hasReward = false;
            // í•´ë‹¹ ë“±ê¸‰(g)ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  ì§„í™” íŠ¸ë¦¬ ê²€ì‚¬
            const targetPaths = evoPaths.filter(p => p.grades.includes(g));
            
            for (let path of targetPaths) {
                const key = `${path.name}_${g}`;
                const level = window.book[key] || 0;
                // 4ë‹¨ê³„(ì™„ì„±) ë„ë‹¬ í–ˆê³  && ì•„ì§ ë³´ìƒ ì•ˆ ë°›ì•˜ë‹¤ë©´
                if (level >= 4 && !window.claimedRewards.includes(key)) {
                    hasReward = true;
                    break; 
                }
            }

            // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš© (ë³´ìƒ ìˆìœ¼ë©´ ë¶‰ì€ìƒ‰ íš¨ê³¼)
            if(tabs[idx]) {
                if(hasReward) tabs[idx].classList.add('tab-reward-alert');
                else tabs[idx].classList.remove('tab-reward-alert');
            }
        });
    }

    window.openBook = () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', '');
        document.getElementById('book-page').style.display = 'block';
        
        let gradeHtml = `<tr><th>ë“±ê¸‰</th><th>ğŸ”® ì¼ë°˜</th><th>ğŸŒŸ ê³ ê¸‰</th></tr>`;
        const grades = ["ë ˆì „ë”ë¦¬", "ì—í”½", "ë ˆì–´", "ë§¤ì§", "ì¼ë°˜"];
        const normalRate = [5, 10, 15, 25, 45];
        const premiumRate = [10, 30, 60, 0, 0]; 
        grades.forEach((g, i) => { 
            const info = gradeInfo[g]; const nR = normalRate[i]; const pR = premiumRate[i];
            const pStyle = pR > nR ? `color:#ffd700; font-weight:bold;` : `color:#555;`;
            gradeHtml += `<tr><td style="color:${info.color}; font-weight:bold;">${g}</td><td>${nR}%</td><td style="${pStyle}">${pR > 0 ? pR + '%' : '-'}</td></tr>`; 
        });
        document.getElementById('grade-rate-table').innerHTML = gradeHtml;
        
        renderBookGrid();
        updateGradeTabAlerts(); // ğŸ‘ˆ [ì¶”ê°€ë¨] íƒ­ ì•Œë¦¼ ê°±ì‹ 
    };

    window.switchBookTab = (tabName) => {
        window.currentBookTab = tabName;
        const color = gradeInfo[tabName].color;
        document.querySelectorAll('.book-tab-btn').forEach(btn => {
            if(btn.innerText === tabName) { btn.classList.add('active'); btn.style.borderColor = color; btn.style.color = color; } 
            else { btn.classList.remove('active'); btn.style.borderColor = "#444"; btn.style.color = "#888"; }
        });
        renderBookGrid();
    }

    window.renderBookGrid = () => {
        const grid = document.getElementById('book-list'); 
        grid.innerHTML = "";
        
        if(!window.book) window.book = {}; 
        if(!window.claimedRewards) window.claimedRewards = [];
        if(!window.claimedGradeRewards) window.claimedGradeRewards = []; // ì•ˆì „ì¥ì¹˜

        const currentGrade = window.currentBookTab;
        const targetPaths = evoPaths.filter(p => p.grades.includes(currentGrade));
        const currentGradeInfo = gradeInfo[currentGrade];
        
        // --- [ì˜¬í´ë¦¬ì–´ ì²´í¬ ë¡œì§] ---
        let totalCount = targetPaths.length;
        let completedCount = 0;
        
        targetPaths.forEach(path => {
            const k = `${path.name}_${currentGrade}`;
            if ((window.book[k] || 0) >= 4) completedCount++;
        });

        // íŒíŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì§„í–‰ë¥  í‘œì‹œ)
        const hintEl = document.getElementById('book-hint-text');
        hintEl.innerHTML = `<span style="color:${currentGradeInfo.color}">[${currentGrade}] ì§„í–‰ë¥ : ${completedCount} / ${totalCount}</span>`;
        
        // â­ [ì˜¬í´ë¦¬ì–´ ë³´ìƒ ë²„íŠ¼ í‘œì‹œ]
        if (completedCount >= totalCount && totalCount > 0) {
            if (!window.claimedGradeRewards.includes(currentGrade)) {
                const rewardAmt = gradeCompletionRewards[currentGrade];
                const masterBtn = document.createElement('div');
                masterBtn.innerHTML = `
                    <div style="font-size:1.2rem; font-weight:bold;">ğŸ† ${currentGrade} ë§ˆìŠ¤í„°ë¦¬ ë‹¬ì„±!</div>
                    <div style="font-size:0.9rem; color:#ffd700;">í„°ì¹˜í•˜ì—¬ ${rewardAmt.toLocaleString()} ê³¨ë“œ ë°›ê¸°</div>
                `;
                masterBtn.onclick = () => claimGradeMasteryReward(currentGrade);
                
                masterBtn.style.cssText = `
                    grid-column: 1 / -1;
                    background: linear-gradient(45deg, #2c3e50, #000);
                    border: 2px solid #ffd700;
                    padding: 15px;
                    text-align: center;
                    border-radius: 10px;
                    margin-bottom: 15px;
                    cursor: pointer;
                    animation: pulse-gold 1.5s infinite;
                    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
                    color: white;
                `;
                grid.appendChild(masterBtn);
            } else {
                hintEl.innerHTML += ` <span style="color:#ffd700; margin-left:10px;">(ğŸ† ì •ë³µ ì™„ë£Œ)</span>`;
            }
        }
        // -------------------------

        // ì •ë ¬
        const gradeWeight = { "ë ˆì „ë”ë¦¬": 5, "ì—í”½": 4, "ë ˆì–´": 3, "ë§¤ì§": 2, "ì¼ë°˜": 1 };
        targetPaths.sort((a, b) => Math.max(...b.grades.map(g => gradeWeight[g])) - Math.max(...a.grades.map(g => gradeWeight[g])));

        targetPaths.forEach(path => {
            const bookKey = `${path.name}_${window.currentBookTab}`;
            const myLevel = window.book[bookKey] || 0; 
            const isDiscovered = myLevel > 0; 
            const isCompleted = myLevel >= 4; 
            const isClaimed = window.claimedRewards.includes(bookKey);
            
            const card = document.createElement('div'); 
            card.className = `book-card-mini ${isCompleted?'book-completed':''}`; 
            card.style.borderColor = currentGradeInfo.color; 
            if(!isDiscovered) card.style.opacity = "0.8"; 
            
            if(isCompleted) { 
                card.onclick = () => handleReward(path.name, window.currentBookTab); 
                if(!isClaimed) {
                    card.innerHTML += `<div class="mini-reward-dot"></div>`;
                    card.classList.add('book-card-reward-aura');
                }
            }

            let headerHtml = `<div class="book-mini-header" style="font-size:0.55rem; color:${isDiscovered ? '#fff' : '#ccc'}">${path.name}</div>`;
            let slotsHtml = `<div class="book-mini-slots">`;
            for(let i=0; i<4; i++) {
                let content = isDiscovered ? (i < myLevel ? `<span class="inv-emoji">${path.stages[i]}</span>` : `<span class="inv-emoji silhouette">${path.stages[i]}</span>`) : `<span class="hidden-mark" style="color:${currentGradeInfo.color}">?</span>`;
                slotsHtml += `<div class="book-mini-slot">${content}</div>`;
            }
            slotsHtml += `</div>`;
            card.innerHTML += headerHtml + slotsHtml; 
            grid.appendChild(card);
        });
    }


    window.handleReward = (themeName, grade) => {
        const key = `${themeName}_${grade}`;
        if(window.claimedRewards.includes(key)) { alert("ì´ë¯¸ ë³´ìƒì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤."); return; }
        
        const rewardAmount = rewardInfo[grade] || 50000000;
        window.gold += rewardAmount; window.claimedRewards.push(key);
        
        addLog(`ğŸ’° ë„ê° ë³´ìƒ ${rewardAmount.toLocaleString()} ê³¨ë“œ ì§€ê¸‰!`);
        window.vibrate(); saveGame(2000); updateUI(); 
        
        renderBookGrid();
        updateGradeTabAlerts(); // ğŸ‘ˆ [ì¶”ê°€ë¨] ë³´ìƒ ìˆ˜ë ¹ í›„ íƒ­ ì•Œë¦¼ ê°±ì‹ 
        
        alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! [${grade}] ë“±ê¸‰ ì™„ì„±!\n\nğŸ’° ${rewardAmount.toLocaleString()} ê³¨ë“œê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    }

    /* --- [ëˆ„ë½ëœ ì¤‘ê°„ ì½”ë“œ ë] --- */
    /* --- [ê°•í™” ì•„ì´í…œ ì‹œìŠ¤í…œ ë¡œì§ ì‹œì‘] --- */
    window.consumables = { protect: 0, charm_5: 0, charm_10: 0, charm_30: 0 };
    window.selectedBuff = null;

    const itemPrices = {
        'charm_5': 1000000,    // ë°±ë§Œì›
        'charm_10': 10000000,  // ì²œë§Œì›
        'charm_30': 100000000,  // 1ì–µ
        'protect': 500000000,    // 5ì–µ
    };
    const itemNames = {
        'charm_5': "ğŸ“œ ë¶€ì (+5%)", 'charm_10': "ğŸ“œ ë¶€ì (+10%)", 'charm_30': "ğŸŒŸ ë¶€ì (+30%)", 'protect': "ğŸ›¡ï¸ íŒŒê´´ë°©ì§€ê¶Œ"
    };

    // [ìˆ˜ì •ë¨] ì•„ì´í…œ í´ë¦­ í•¸ë“¤ëŸ¬ (êµ¬ë§¤ í›„ ì•ˆë‚´ ì¶”ê°€)
    window.toggleBuff = (type) => {
        // 1. ì—†ìœ¼ë©´ êµ¬ë§¤ í”„ë¡œì„¸ìŠ¤
        if (!window.consumables[type] || window.consumables[type] <= 0) {
            const price = itemPrices[type];
            if (window.gold < price) {
                alert(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: ${price.toLocaleString()} ğŸŸ¡`);
                return;
            }
            if (confirm(`${itemNames[type]}ì„(ë¥¼) êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê°€ê²©: ${price.toLocaleString()} ğŸŸ¡`)) {
                window.gold -= price;
                window.consumables[type]++;
                
                // [ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€ëœ ë¶€ë¶„]
                addLog(`ğŸ›’ ${itemNames[type]} êµ¬ë§¤ ì™„ë£Œ!`);
                alert(`âœ… êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ’¡ ì‚¬ìš©ë²•:\në²„íŠ¼ì´ ë°ì•„ì¡ŒìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œ ë²ˆ í„°ì¹˜í•˜ì—¬\n[í…Œë‘ë¦¬ê°€ ì¼œì§„ ìƒíƒœ(ì¥ì°©)]ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`);
                
                saveGame(0);
                updateBuffUI();
                updateUI();
            }
            return;
        }

        // 2. ìˆìœ¼ë©´ ì¥ì°©/í•´ì œ í† ê¸€
        if (window.selectedBuff === type) {
            window.selectedBuff = null; // ì´ë¯¸ ì„ íƒëœê±°ë©´ í•´ì œ
            addLog("ì•„ì´í…œ ì¥ì°© í•´ì œ");
        } else {
            window.selectedBuff = type; // ì¥ì°©
            addLog(`ğŸ‘‰ ${itemNames[type]} ì¥ì°©ë¨ (ê°•í™” ì‹œ ì†Œëª¨)`);
        }
        updateBuffUI();
        updateUI(); // í™•ë¥  ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ ìš©
    };


    function updateBuffUI() {
        ['charm_5', 'charm_10', 'charm_30', 'protect'].forEach(key => {
            const el = document.getElementById(`btn-buff-${key.replace('charm_','')}`);
            if(el) {
                // 1. ë³´ìœ ëŸ‰ì´ ì—†ìœ¼ë©´ íë¦¿í•˜ê²Œ(.empty) ì²˜ë¦¬
                if(!window.consumables[key] || window.consumables[key] <= 0) {
                    el.classList.add('empty');
                } else {
                    el.classList.remove('empty');
                }

                // 2. ì„ íƒëœ ì•„ì´í…œ í™œì„±í™”(.active) ì²˜ë¦¬
                if (window.selectedBuff === key) el.classList.add('active'); 
                else el.classList.remove('active');
            }
        });
    }
    /* --- [ê°•í™” ì•„ì´í…œ ì‹œìŠ¤í…œ ë¡œì§ ë] --- */


    window.updateUI = function() {
        window.gold = Number(window.gold); 
        try {
            document.getElementById('gold-display').innerText = window.gold.toLocaleString() + " ğŸŸ¡";
            document.getElementById('my-id-label').innerText = `ID: ${window.nickname || "GUEST"}`;
            document.getElementById('inv-total-gold').innerText = window.gold.toLocaleString() + " ğŸŸ¡";
            
            // [ìˆ˜ì •ë¨] íƒ€ë¡œ ë°°ë„ˆ í‘œì‹œ ë¡œì§ (ì´ˆë¡ìƒ‰ ì•Œë¦¼ ì¶”ê°€)
            const bannerWrap = document.querySelector('.tarot-banner-wrap');
            const bannerBox = document.getElementById('tarot-msg-box');
            
            // 1. ì˜¤ëŠ˜ ì•„ì§ íƒ€ë¡œë¥¼ ì•ˆ ë½‘ì•˜ì„ ë•Œ (ë¦¬ì…‹ë¨)
            if (window.todayTarotCount === 0) {
                // ì´ˆë¡ìƒ‰ ë°°ê²½ìœ¼ë¡œ ë³€ê²½ (ëˆˆì— ë„ê²Œ)
                bannerWrap.style.background = "linear-gradient(90deg, #00b894, #006266)";
                bannerWrap.style.borderBottom = "1px solid #55efc4";
                bannerBox.innerText = "âœ¨ ìƒˆë¡œìš´ ë‚ ì´ ë°ì•˜ìŠµë‹ˆë‹¤! ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ íƒ€ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”!";
                bannerBox.style.color = "#fff";
                bannerBox.style.textShadow = "0 0 5px rgba(255,255,255,0.5)";
            } 
            // 2. ì´ë¯¸ ë½‘ì•„ì„œ ë²„í”„ê°€ ìˆì„ ë•Œ
            else if (window.tarotBuff) {
                // ì›ë˜ ë³´ë¼ìƒ‰ ë°°ê²½ ë³µêµ¬
                bannerWrap.style.background = "linear-gradient(90deg, #2c0e33, #000000)";
                bannerWrap.style.borderBottom = "1px solid #9c27b0";
                
                const cardInfo = tarotCards.find(c => c.id === window.tarotBuff.id);
                let buffText = `${cardInfo.icon} ${cardInfo.name} : ${cardInfo.desc} ì ìš© ì¤‘!`;
                if(cardInfo.grade === 'fail') buffText = "ğŸ¤¡ THE FOOL : ì˜¤ëŠ˜ì€ ê·¸ëƒ¥ ì¦ê¸°ì„¸ìš”! (íš¨ê³¼ ì—†ìŒ)";
                
                bannerBox.innerText = buffText;
                bannerBox.style.color = "#e056fd";
                bannerBox.style.textShadow = "0 0 5px rgba(224, 86, 253, 0.5)";
            }


            // [ìˆ˜ì •ë¨] íƒ€ë¡œ ë¹„ìš© ê³„ì‚° ë¡œì§ (ë¬´ë£Œ 1íšŒ ì œì™¸, ì²« ë¦¬ë¡¤ 500ë§Œì›ë¶€í„°)
            
            // 1. ìˆœìˆ˜ ë¦¬ë¡¤ íšŸìˆ˜ ê³„ì‚° (í˜„ì¬ ì¹´ìš´íŠ¸ - ë¬´ë£Œ 1íšŒ)
            // ë¬´ë£Œë§Œ ë½‘ì€ ìƒíƒœ(1) -> ë¦¬ë¡¤ íšŸìˆ˜ 0 -> 2^0 = 1 -> ê¸°ë³¸ ë¹„ìš© ì ìš©
            let rerollCount = Math.max(0, window.todayTarotCount - 1);
            
            // 2. ê¸°ë³¸ ë¹„ìš© ì„¤ì • (500ë§Œì›)
            let baseCost = 5000000; 

            // 3. ë¹„ìš© ê³„ì‚°: 500ë§Œì› * 2ì˜ nìŠ¹
            window.tarotRerollCost = baseCost * Math.pow(2, rerollCount);

            if (window.gold > window.maxGold) {
                window.maxGold = window.gold;
                window.maxGoldDate = Date.now();
                saveGame(2000); 
            }

            const mainBtns = document.getElementById('dynamic-btn-area');
            let html = "";
            const hasItem = window.currentEmoji !== null;
            let isDead = false;
            let isPoor = window.gold < 10000;

            if (hasItem) {
                if(typeof window.currentEmoji.grade === 'undefined') { window.currentEmoji = null; updateUI(); return; }
                let pathObj = evoPaths.find(p => p.name === window.currentEmoji.pathName) || { stages: ["â“", "â“", "â“", "â“"] };
                isDead = window.currentEmoji.gone;
                const info = gradeInfo[window.currentEmoji.grade] || gradeInfo["ì¼ë°˜"]; 
                const lvl = window.currentEmoji.level;
                
                document.getElementById('overlay-grade').innerText = window.currentEmoji.grade; 
                document.getElementById('overlay-grade').style.color = info.color;
                document.getElementById('overlay-name-level').innerText = `+${lvl}`; 
                // â­ [ìˆ˜ì •ë¨] ë„ê° ë°°ì§€: ì‹¬í”Œí•œ ë„íŠ¸ & ì˜¬í´ë¦¬ì–´ ê¸°ì¤€ íŒì •
                const bookKey = `${window.currentEmoji.pathName}_${window.currentEmoji.grade}`;
                const mySavedLevel = window.book[bookKey] || 0; 
                
                // [íŒì • ë³€ê²½] 4ë‹¨ê³„(ìµœì¢… ì§„í™”)ê¹Œì§€ ëª¨ë‘ ë“±ë¡ë˜ì–´ì•¼ 'ì™„ì„±(ì´ˆë¡)'ìœ¼ë¡œ ì¸ì •
                // í•˜ë‚˜ë¼ë„ ë¶€ì¡±í•˜ë©´ 'ë¯¸ì™„ì„±(ì£¼í™©)'
                const isMastered = mySavedLevel >= 4;

                const badgeEl = document.getElementById('book-status-badge');
                if (badgeEl) {
                    // ìŠ¤íƒ€ì¼ ê³µí†µ (ì‘ì€ ì›í˜• ë„íŠ¸)
                    const dotStyle = "width:8px; height:8px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,0.5);";
                    
                    if (isMastered) {
                        // ğŸŸ¢ ì´ˆë¡ ë„íŠ¸ (ì™„ì„±ë¨)
                        badgeEl.innerHTML = `<div title="ë„ê° ì™„ì„±ë¨ (ë§ˆìŠ¤í„°)" style="${dotStyle} background-color:#2ecc71; box-shadow:0 0 6px #2ecc71;"></div>`;
                    } else {
                        // ğŸŸ  ì£¼í™© ë„íŠ¸ + ê¹œë¹¡ì„ (ë¯¸ì™„ì„± / ìˆ˜ì§‘ í•„ìš”)
                        badgeEl.innerHTML = `<div title="ë„ê° ë¯¸ì™„ì„± (ìˆ˜ì§‘ í•„ìš”)" style="${dotStyle} background-color:#e67e22; box-shadow:0 0 6px #e67e22; animation:blink 1s infinite;"></div>`;
                    }
                }
                // â­ [ìˆ˜ì • ë]


                const stageIdx = Math.min(3, Math.floor(lvl / 5));
                const currentIcon = pathObj.stages[stageIdx] || "â“";

                // [ìˆ˜ì •] íŒŒê´´ ìƒíƒœì¼ ë•Œ: ê¸°ë¡ ë¶ˆê°€ ì•ˆë‚´ + ì¹˜ìš°ê¸° ë²„íŠ¼ë§Œ í‘œì‹œ
                if (isDead) {
                    document.getElementById('deco-l').innerText = "ğŸ’€"; 
                    document.getElementById('deco-r').innerText = "ğŸ’€";
                    document.getElementById('main-emoji').innerText = currentIcon;
                    document.getElementById('overlay-name-level').innerText = "íŒŒê´´ë¨";
                    
                    html = `
                    <div class="btn-stack">
                        <button class="btn-action" disabled style="background:#2d1414; color:#ff6b6b; border:1px solid #e74c3c; grid-column: span 2; opacity: 1; height: 60px;">
                            <span style="font-size:1.1rem; font-weight:900;">ğŸ’€ íŒŒê´´ë¨</span>
                            <small style="font-size:0.5rem; color:#ffaaaa;">(ë­í‚¹ë„ì „ ë¶ˆê°€)</small>
                        </button>
                        
                        <button class="btn-action btn-cleanup" onclick="cleanup()" style="grid-column: span 2; margin-top:0px;">
                            <span style="font-size:1.0rem;">ğŸ§¹ ì”í•´ ì¹˜ìš°ê¸°</span>
                            <small>(0ì›)</small>
                        </button>
                    </div>`;
                } 
                else {
                    let cost = Math.floor(2000 * Math.pow(1.8, lvl));
                    const canEvolve = window.gold >= cost;
                    const canAllIn = !canEvolve && window.gold >= (cost / 2);
                    const canMutate = (window.currentEmoji.gene && !window.currentEmoji.mutated && lvl >= 5 && window.gold >= 500000);
                    
                    let geneBtnStyle = canMutate ? "" : "disabled";
                    if(canMutate && window.tarotBuff?.type === 'mutation_prob') { geneBtnStyle += ` style="border: 2px solid #a29bfe; box-shadow: 0 0 10px #a29bfe;"`; }

                    let b = (lvl < 5) ? 0.5 : Math.min(20, (lvl - 4) * 2); 
                    let m = Math.min(50, lvl * (7 / info.mod)); 
                    let s = Math.max(10, 100 - b - m); 

                    let s_bonus = 0;
                    if(window.tarotBuff?.type === 'enhance_prob') {
                        s_bonus = window.tarotBuff.val;
                        if(m >= s_bonus) { m -= s_bonus; s += s_bonus; } else { s += m; m = 0; }
                    }
                    
                    let sellBonus = (window.tarotBuff?.type === 'sell_bonus') ? (1 + window.tarotBuff.val/100) : 1.0;
                    let finalVal = Math.floor(1000 * info.weight * 10 * info.sellMod * Math.pow(1.6, lvl) * (window.currentEmoji.mutated ? 1.5 : 1.0) * sellBonus);
                    if(lvl >= 10) {
                        if(window.currentEmoji.grade === "ì¼ë°˜") finalVal *= 5; 
                        else if(window.currentEmoji.grade === "ë§¤ì§") finalVal *= 3; 
                    }
                    if(finalVal > 9007199254740991) finalVal = 9007199254740991; 
                    window.currentEmoji.value = finalVal;
                    
                    const valEl = document.getElementById('st-value');
                    valEl.innerText = window.currentEmoji.value.toLocaleString();
                    if(sellBonus > 1.0) { valEl.style.color = "#ffd700"; valEl.innerHTML += ` <small style='color:#e056fd'>(+${window.tarotBuff.val}%)</small>`; } 
                    else { valEl.style.color = "#fff"; }
                    
                    let allInBadge = window.currentEmoji.allInHistory === 'success' ? " <span style='font-size:0.6rem; color:#ff4757; font-weight:bold;'>[ğŸ”¥ALL-IN]</span>" : "";
                    document.getElementById('st-grade').innerHTML = window.currentEmoji.grade + allInBadge;
                    document.getElementById('st-grade').style.color = info.color;
                    
                    let geneText = window.currentEmoji.mutated ? "ğŸ§¬ ë³€ì´ë¨" : (window.currentEmoji.gene ? "ğŸ§¬ ë³´ìœ " : "-");
                    document.getElementById('st-gene').innerText = geneText;

                    /* ğŸ‘‡ [ì´ë¯¸ì§€ ì‹œìŠ¤í…œ êµì²´ ì‹œì‘] */
                    const dL = document.getElementById('deco-l'), dR = document.getElementById('deco-r');
                    
                    // 1. í˜„ì¬ ì§„í™” íŠ¸ë¦¬ì˜ ID ì°¾ê¸°
                    const pathData = evoPaths.find(p => p.name === window.currentEmoji.pathName);
                    
                    // 2. ë‹¨ê³„ ê³„ì‚° (1~4ë‹¨ê³„)
                    const stageNum = Math.min(4, Math.floor(lvl / 5) + 1);

                    // 3. ë©”ì¸ í™”ë©´ í‘œì‹œ (ì´ë¯¸ì§€ vs ì´ëª¨ì§€)
                    if (pathData && pathData.id) {
                        // ì´ë¯¸ì§€ íŒŒì¼ëª…: "ID (ë‹¨ê³„).png" (ì˜ˆ: dragon (1).png)
                        const imgPath = `images/${pathData.id} (${stageNum}).png`;
                        
                        document.getElementById('main-emoji').innerHTML = `
                            <div style="position: relative; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center;">
                                <div style="position: absolute; bottom: 5px; width: 60%; height: 10px; background: rgba(0,0,0,0.3); border-radius: 50%; filter: blur(4px);"></div>
                                
                                <img src="${imgPath}" 
                                     onerror="this.parentElement.style.display='none'; document.getElementById('backup-emoji').style.display='block';" 
                                     alt="${currentIcon}"
                                     style="
                                        width: 100%; 
                                        height: 100%; 
                                        object-fit: contain; 
                                        filter: drop-shadow(0 0 5px rgba(255,255,255,0.4)); 
                                        animation: float 3s ease-in-out infinite;
                                     "
                                >
                            </div>
                            <div id="backup-emoji" style="display:none; font-size: 4.2rem; animation: float 3s ease-in-out infinite;">
                                ${currentIcon}
                            </div>
                        `;
                    } else {
                        // IDê°€ ì—†ëŠ” ì¢…ì¡±ì€ ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ì´ëª¨ì§€ í‘œì‹œ
                        document.getElementById('main-emoji').innerHTML = `
                            <div style="font-size: 4.2rem; animation: float 3s ease-in-out infinite;">${currentIcon}</div>
                        `;
                    }

                    // ì–‘ì˜† ì¥ì‹ ì´ëª¨ì§€ (ë¶ˆê½ƒ ë“±) ì²˜ë¦¬
                    if (lvl >= 15) dL.innerText = dR.innerText = "ğŸ†"; 
                    else if (lvl >= 10) dL.innerText = dR.innerText = "ğŸ”¥"; 
                    else dL.innerText = dR.innerText = "";
                    /* ğŸ‘† [ì´ë¯¸ì§€ ì‹œìŠ¤í…œ êµì²´ ë] */

                                        // [ì•„ì´í…œ] ë¶€ì  ì¥ì°© ì‹œ í™•ë¥  ë¯¸ë¦¬ë³´ê¸° ì ìš©
                    if (window.selectedBuff && window.selectedBuff.startsWith('charm')) {
                        let cVal = (window.selectedBuff === 'charm_5') ? 5 : (window.selectedBuff === 'charm_10' ? 10 : 30);
                        let conv = Math.min(m, cVal);
                        s += conv; m -= conv;
                    }

                    // [í•µì‹¬ ìˆ˜ì • 1] 20ë ˆë²¨ ì œí•œ ë²„íŠ¼ ì²˜ë¦¬
                    let evolveBtnHtml = "";
                    const MAX_LEVEL = 20;

                    if (lvl >= MAX_LEVEL) {
                        evolveBtnHtml = `
                        <button class="btn-action" disabled style="background:linear-gradient(135deg, #ffd700, #b8860b); color:#000; grid-column: span 2; opacity: 1; cursor: not-allowed; border: 1px solid #fff;">
                            <span style="font-size:1.1rem;">ğŸ‘‘ MAX LEVEL ğŸ‘‘</span>
                            <small style="color:#222; font-weight:900;">ì „ì„¤ì˜ ì •ì ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤</small>
                        </button>`;
                    } 
                    else if (canAllIn) {
                        evolveBtnHtml = `
                        <button class="btn-action btn-allin" onclick="openAllInModal(${cost}, ${window.gold})">
                            <span style="font-size:1.1rem;">ğŸ”¥ ALL-IN</span>
                            <small style="color:white; opacity:0.9;">(ì „ì¬ì‚° ${window.gold.toLocaleString()}ğŸŸ¡)</small>
                        </button>`;
                    } else {
                        evolveBtnHtml = `
                        <button class="btn-action btn-evolve" onclick="evolve()" ${canEvolve ? '' : 'disabled'}>
                            <span>ê°•í™”</span>
                            <small style="font-size:0.6rem; opacity:0.8; ${canEvolve ? '' : 'color:#ff7675'}">${cost.toLocaleString()}ğŸŸ¡</small>
                        </button>`;
                    }

                    html = `
                    <div class="btn-stack">
                        ${evolveBtnHtml}
                        <button class="btn-action btn-premium-summ" disabled style="opacity:0.3; filter:grayscale(1);">ğŸŒŸ ê³ ê¸‰ ì†Œí™˜<br>(ìŠ¬ë¡¯ ê½‰ ì°¸)</button>
                        <button class="btn-action btn-normal-summ" disabled style="opacity:0.3; filter:grayscale(1);">ğŸ”® ì¼ë°˜ ì†Œí™˜<br>(ìŠ¬ë¡¯ ê½‰ ì°¸)</button>
                        <button class="btn-action btn-gene" onclick="mutateGene()" ${geneBtnStyle}>ğŸ§¬ ë³€ì´ (500k)</button>
                        <button class="btn-action btn-sell" onclick="sellItem()">
                            <span style="font-size:1.0rem;">ğŸ’° íŒë§¤</span>
                            <small style="font-size:0.5rem; opacity:0.8; font-weight:normal;">(ë­í‚¹ ë„ì „)</small>
                        </button>
                    </div>`;

                    
                    document.getElementById('seg-s').style.width = s + "%"; 
                    document.getElementById('seg-m').style.width = m + "%"; 
                    document.getElementById('seg-b').style.width = b + "%";
                    
                    const valSText = document.getElementById('val-s-text');
                    if(s_bonus > 0) valSText.innerHTML = `ì„±ê³µ ${s.toFixed(2)}% <span style='color:#00cec9; animation:blink 1s infinite;'>(+${s_bonus}%)</span>`;
                    else valSText.innerText = `ì„±ê³µ ${s.toFixed(2)}%`;
                    document.getElementById('val-b').innerText = b.toFixed(2) + "%";
                    
                    const tier = getTier(window.currentEmoji.rarity);
                    const rp = getRareScore(parseFloat(window.currentEmoji.rarity));
                    if(tier.color === "EX") {
                        document.getElementById('st-rarity').innerHTML = `<span class="tier-ex-gradient">EX</span> <small style="font-size:0.6rem; color:#aaa;">(RP: ${rp.toLocaleString()}ì )</small>`;
                    } else {
                        document.getElementById('st-rarity').innerHTML = `${tier.text} <small style="font-size:0.6rem; opacity:0.7">(RP: ${rp.toLocaleString()}ì )</small>`; 
                        document.getElementById('st-rarity').style.color = tier.color; 
                    }
                }
            } 
            else if (isPoor) {
                resetDisplay();
                html = `
                <div class="btn-stack">
                    <button class="btn-action btn-labor" onclick="labor()">
                        <span style="font-size:1.2rem;">â›ï¸</span>
                        <span>ì—´ì‹¬íˆ ì¼í•˜ê¸°</span>
                        <small style="color:#ffd700;">(+200ì›)</small>
                    </button>
                    <button class="btn-action" disabled style="background:#222; color:#555;">(ì†Œí™˜ ë¶ˆê°€)</button>
                    <button class="btn-action" disabled style="background:#222; color:#555;">(ì†Œí™˜ ë¶ˆê°€)</button>
                    <button class="btn-action" disabled style="background:#222; color:#555;">(ë³€ì´ ë¶ˆê°€)</button>
                    <button class="btn-action" disabled style="background:#222; color:#555;">(íŒë§¤ ë¶ˆê°€)</button>
                </div>`;
            }
            else {
                resetDisplay();
                let discountRate = (window.tarotBuff?.type === 'summon_discount') ? (window.tarotBuff.val / 100) : 0;
                let normCost = 10000 * (1 - discountRate);
                let premCost = 1000000 * (1 - discountRate);
                const canNormal = window.gold >= normCost;
                const canPremium = window.gold >= premCost;
                let normBtnContent = "", premBtnContent = "";
                if(discountRate > 0) {
                    normBtnContent = `ğŸ”® ì¼ë°˜ ì†Œí™˜<div style="line-height:1; margin-top:2px; display:flex; flex-direction:column; align-items:center;"><span style="text-decoration:line-through; font-size:0.5rem; opacity:0.7; color:#333;">1ë§Œ</span><span style="font-size:0.65rem; color:#0022aa; font-weight:900;">${(normCost/10000).toFixed(1)}ë§Œ</span></div>`;
                    premBtnContent = `ğŸŒŸ ê³ ê¸‰ ì†Œí™˜<div style="line-height:1; margin-top:2px; display:flex; flex-direction:column; align-items:center;"><span style="text-decoration:line-through; font-size:0.5rem; opacity:0.7; color:#333;">100ë§Œ</span><span style="font-size:0.65rem; color:#0022aa; font-weight:900;">${(premCost/10000).toFixed(0)}ë§Œ</span></div>`;
                } else {
                    normBtnContent = `ğŸ”® ì¼ë°˜ ì†Œí™˜<br><span style="font-size:0.6rem;">(1ë§Œ)</span>`;
                    premBtnContent = `ğŸŒŸ ê³ ê¸‰ ì†Œí™˜<br><span style="font-size:0.6rem;">(100ë§Œ)</span>`;
                }
                html = `
                <div class="btn-stack">
                    <button class="btn-action btn-evolve" disabled><span>ê°•í™”</span><small>-</small></button>
                    <button class="btn-action btn-premium-summ" onclick="fetchNew('premium')" ${canPremium ? '' : 'disabled'}>${premBtnContent}</button>
                    <button class="btn-action btn-normal-summ" onclick="fetchNew('normal')" ${canNormal ? '' : 'disabled'}>${normBtnContent}</button>
                    <button class="btn-action btn-gene" disabled>ğŸ§¬ ë³€ì´</button>
                    <button class="btn-action btn-sell" disabled style="opacity:0.3;">ğŸ’° íŒë§¤</button>
                </div>`;
            }
            mainBtns.innerHTML = html;
            if(hasItem && !isDead) { updateBook(window.currentEmoji.pathName, window.currentEmoji.level, window.currentEmoji.originalGrade); }
            checkBookAlert();
            updateInvStatusBar();
        } catch(e) { console.error("Critical UpdateUI Error:", e); }
    };

    function resetDisplay() {
        document.getElementById('overlay-name-level').innerText = "ì†Œí™˜ ëŒ€ê¸° ì¤‘"; 
        document.getElementById('main-emoji').innerText = "â“";
        document.getElementById('overlay-grade').innerText = "-"; 
        document.getElementById('deco-l').innerText = document.getElementById('deco-r').innerText = "";
        document.querySelectorAll('.gauge-seg').forEach(el => el.style.width = "0%"); 
        ["st-value", "st-grade", "st-rarity"].forEach(id => document.getElementById(id).innerText = "-");
        
        // â­ [ì¶”ê°€ë¨] ì†Œí™˜ ì „ì—ëŠ” ë„ê° ë°°ì§€ ìˆ¨ê¸°ê¸°
        const badgeEl = document.getElementById('book-status-badge');
        if(badgeEl) badgeEl.innerHTML = ""; 

        if(window.tarotBuff && window.tarotBuff.type === 'mutation_prob') {
            document.getElementById('st-gene').innerHTML = `<span style="color:#a29bfe; animation:blink 1s infinite;">ğŸ§¬ +${window.tarotBuff.val}%</span>`;
        } else { document.getElementById('st-gene').innerText = "-"; }
        document.getElementById('val-s-text').innerText = "ì„±ê³µ 0%";
    }

    function updateInvStatusBar() {
        if(window.currentEmoji && !window.currentEmoji.gone) {
             const info = gradeInfo[window.currentEmoji.grade];
             if(info) {
                 const pathObj = evoPaths.find(p => p.name === window.currentEmoji.pathName) || { stages:["â“","â“","â“","â“"] };
                 const stageIdx = Math.min(3, Math.floor(window.currentEmoji.level / 5));
                 document.getElementById('inv-current-emoji').innerText = pathObj.stages[stageIdx];
                 document.getElementById('inv-current-name').innerHTML = `<span style="color:${info.color}">${window.currentEmoji.grade}</span> +${window.currentEmoji.level}`;
             }
        } else {
             document.getElementById('inv-current-emoji').innerText = "ğŸ”’";
             document.getElementById('inv-current-name').innerText = "ì—†ìŒ";
        }
        if(window.myHistory.length > 0) {
             const best = window.myHistory[0];
             document.getElementById('my-best-icon').innerText = best.emoji;
             document.getElementById('my-best-info').innerText = `${best.grade} +${best.lvl}`;
             document.getElementById('my-best-info').style.color = gradeInfo[best.grade].color;
        }
    }

    window.labor = () => {
        if(window.gold >= 10000) return;
        window.gold += 200;
        window.vibrate();
        if(window.gold >= 10000) { addLog("â›ï¸ 10,000ì› ë‹¬ì„±!"); updateUI(); } 
        else { document.getElementById('gold-display').innerText = window.gold.toLocaleString() + " ğŸŸ¡"; }
    };

    window.cleanup = () => { window.currentEmoji = null; addLog("ğŸ§¹ ì”í•´ë¥¼ ì¹˜ì› ìŠµë‹ˆë‹¤."); saveGame(1000); updateUI(); }

    window.fetchNew = (type) => { 
        if (window.currentEmoji) return; 
        let baseCost = (type === 'premium') ? 1000000 : 10000;
        let discountRate = (window.tarotBuff?.type === 'summon_discount') ? (window.tarotBuff.val / 100) : 0;
        let finalCost = Math.floor(baseCost * (1 - discountRate));

        if (window.gold < finalCost) { addLog(`ì”ì•¡ ë¶€ì¡±! (${finalCost.toLocaleString()} í•„ìš”)`); return; }
        window.gold -= finalCost; 
        
        let g = "ì¼ë°˜"; let r = Math.random() * 100;
        if (type === 'premium') {
            if (r < 10) g = "ë ˆì „ë”ë¦¬"; else if (r < 40) g = "ì—í”½"; else g = "ë ˆì–´";
        } else {
            if (r < 5) g = "ë ˆì „ë”ë¦¬"; else if (r < 15) g = "ì—í”½"; else if (r < 30) g = "ë ˆì–´"; else if (r < 55) g = "ë§¤ì§"; else g = "ì¼ë°˜";
        }
        const paths = evoPaths.filter(p => p.grades.includes(g)); 
        const p = paths[Math.floor(Math.random() * paths.length)]; 
        let variance = (Math.random() * 0.1) + 0.95; 
        let finalRarity = (gradeInfo[g].prob * variance).toFixed(8);

        window.currentEmoji = { 
            pathName: p.name, stages: p.stages, grade: g, originalGrade: g, level: 0, 
            gene: Math.random() < 0.35, mutated: false, survival: 100, gone: false, 
            rarity: finalRarity, mutationHistory: null, allInHistory: null 
        }; 
        
        const typeName = type === 'premium' ? "ğŸŒŸ ê³ ê¸‰" : "ğŸ”® ì¼ë°˜";
        addLog(`${typeName} ì†Œí™˜! [${g}] (ë¹„ìš©: ${finalCost.toLocaleString()})`); 
        updateUI(); saveGame(2000); 
    };

    window.evolve = () => {
        if (!window.currentEmoji) return;
        let cost = Math.floor(2000 * Math.pow(1.8, window.currentEmoji.level)); 
        
        // ì•„ì´í…œ ì²´í¬ (ì„ íƒí–ˆëŠ”ë° ì—†ìœ¼ë©´ í•´ì œ)
        if (window.selectedBuff && window.consumables[window.selectedBuff] <= 0) {
            window.selectedBuff = null; updateBuffUI();
        }

        if (window.gold < cost) { addLog("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
        window.gold -= cost;
        
        if(window.currentEmoji.level >= 10 && navigator.vibrate) { navigator.vibrate([50, 50, 50]); }

        const emojiEl = document.getElementById('main-emoji');
        emojiEl.className = ''; void emojiEl.offsetWidth;

        let lvl = window.currentEmoji.level, info = gradeInfo[window.currentEmoji.grade];
        
        // 1. ê¸°ë³¸ í™•ë¥ 
        let b = (lvl < 5) ? 0.5 : Math.min(20, (lvl - 4) * 2); 
        let m = Math.min(50, lvl * (7 / info.mod)); 
        let s = Math.max(10, 100 - b - m); 
        
        // 2. íƒ€ë¡œ ë²„í”„
        if(window.tarotBuff?.type === 'enhance_prob') {
            let bonus = window.tarotBuff.val;
            if (m >= bonus) { s += bonus; m -= bonus; } else { s += m; m = 0; } 
        }

        // 3. ì•„ì´í…œ(ë¶€ì ) ì ìš© - íŒŒê´´í™•ë¥ (b)ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
        let usedItem = null; 
        if (window.selectedBuff && window.selectedBuff.startsWith('charm')) {
            let charmVal = (window.selectedBuff === 'charm_5') ? 5 : (window.selectedBuff === 'charm_10' ? 10 : 30);
            let conversion = Math.min(m, charmVal); // ìœ ì§€í™•ë¥ ì—ì„œ ê¹ì•„ì„œ ì„±ê³µìœ¼ë¡œ
            s += conversion; m -= conversion;
            usedItem = window.selectedBuff;
        }

        let rand = Math.random() * 100;
        
        if (rand < s) { 
            // [ì„±ê³µ]
            if (usedItem) { window.consumables[usedItem]--; addLog(`âœ¨ ë¶€ì  íš¨ê³¼ ì ìš©ë¨!`); }
            
            window.currentEmoji.level++; 
            let improveFactor = (s - (window.tarotBuff?.type==='enhance_prob' ? window.tarotBuff.val : 0)) / 100;
            if(Math.random() < 0.1) { improveFactor *= 0.8; addLog(`âš¡ ëŒ€ì„±ê³µ! (í¬ê·€ë„ ëŒ€í­ ìƒìŠ¹)`); }
            
            let nextRarity = parseFloat(window.currentEmoji.rarity) * improveFactor;
            if (nextRarity < 1e-100) nextRarity = 1e-100; 
            window.currentEmoji.rarity = nextRarity.toFixed(20); 
            
            if (window.currentEmoji.level >= 20) {
                addLog(`ğŸ‘‘ ì¶•í•˜í•©ë‹ˆë‹¤! ìµœê³  ë ˆë²¨(20)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!`);
                alert(`ğŸ‰ ìœ„ëŒ€í•œ ì—…ì  ë‹¬ì„±! ğŸ‰\n\në ˆë²¨ 20ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!`);
            } else { addLog(`âœ¨ ê°•í™” ì„±ê³µ! +${window.currentEmoji.level}`); }
            emojiEl.classList.add('anim-success');

        } else if (rand < s + m) { 
            // [ìœ ì§€]
            if (usedItem) { window.consumables[usedItem]--; addLog(`ğŸ’¨ ë¶€ì ì„ ì¼ì§€ë§Œ ìœ ì§€ë¨...`); }
            addLog("ğŸ’¨ ìƒíƒœ ìœ ì§€"); emojiEl.classList.add('anim-stay');

        } else { 
            // [íŒŒê´´]
            if (window.selectedBuff === 'protect') {
                window.consumables['protect']--; 
                addLog(`ğŸ›¡ï¸ íŒŒê´´ ë°©ì§€ê¶Œ ë°œë™! (íŒŒê´´ ë©´í•¨)`);
                emojiEl.classList.add('anim-stay'); // íŒŒê´´ ëŒ€ì‹  ìœ ì§€ ëª¨ì…˜
                window.selectedBuff = null; // ì‚¬ìš© í›„ í•´ì œ
            } else {
                if (usedItem) { window.consumables[usedItem]--; } 
                addLog(`ğŸ’€ ê°•í™” ì‹¤íŒ¨... íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.`); 
                window.currentEmoji.gone = true; 
                emojiEl.classList.add('anim-fail');
            }
        }
        
        if (usedItem) window.selectedBuff = null; // ë¶€ì ì€ 1íšŒìš©ì´ë¯€ë¡œ í•´ì œ
        updateBuffUI(); updateUI(); saveGame(2000); 
    };


    window.openAllInModal = (cost, currentGold) => {
        document.getElementById('allin-cost-disp').innerText = cost.toLocaleString() + " ğŸŸ¡";
        document.getElementById('allin-gold-disp').innerText = currentGold.toLocaleString() + " ğŸŸ¡";
        document.getElementById('allin-modal').style.display = 'flex';
    };

    window.confirmAllIn = () => {
        document.getElementById('allin-modal').style.display = 'none';
        if (!window.currentEmoji) return;
        
        addLog(`ğŸ”¥ ALL-IN ë°œë™! ${window.gold.toLocaleString()}ì› ì†Œì§„.`);
        window.gold = 0;

        const emojiEl = document.getElementById('main-emoji');
        emojiEl.className = ''; void emojiEl.offsetWidth; 
        
        let lvl = window.currentEmoji.level, info = gradeInfo[window.currentEmoji.grade];
        let b = (lvl < 5) ? 0.5 : Math.min(20, (lvl - 4) * 2);
        let m = Math.min(50, lvl * (7 / info.mod));
        let s = Math.max(10, 100 - b - m); 
        
        if(window.tarotBuff?.type === 'enhance_prob') {
            let bonus = window.tarotBuff.val;
            if (m >= bonus) { s += bonus; m -= bonus; } else { s += m; m = 0; }
        }
        
        let rand = Math.random() * 100;
        if (rand < s) {
            window.currentEmoji.level++; 
            let nextRarity = parseFloat(window.currentEmoji.rarity) * (s/100);
            window.currentEmoji.rarity = nextRarity.toFixed(20);
            window.currentEmoji.allInHistory = "success";
            
            if (window.currentEmoji.level >= 20) {
                addLog(`ğŸ‘‘ ì˜¬ì¸ ëŒ€ì„±ê³µ! ìµœê³  ë ˆë²¨(20) ë„ë‹¬!`);
                alert(`ğŸ”¥ ì˜¬ì¸ ì„±ê³µ! ì „ì„¤ì˜ íƒ„ìƒ! ğŸ”¥\n\në ˆë²¨ 20ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!`);
            } else {
                addLog(`ğŸ”¥ ì˜¬ì¸ ì„±ê³µ! +${window.currentEmoji.level}`); 
            }
            emojiEl.classList.add('anim-success');
        } else if (rand < s + m) {
            addLog("ğŸ’¨ ì˜¬ì¸ ê²°ê³¼: ìƒíƒœ ìœ ì§€ (ë‹¤í–‰ì´ë‹¤...)"); emojiEl.classList.add('anim-stay');
        } else { 
            addLog(`ğŸ’€ ì˜¬ì¸ ì‹¤íŒ¨... íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.`); window.currentEmoji.gone = true; emojiEl.classList.add('anim-fail');
        } 
        updateUI(); saveGame(2000); 
    };

    window.mutateGene = () => {
        if (!window.currentEmoji || window.gold < 500000) return; 
        window.gold -= 500000;
        
        const emojiEl = document.getElementById('main-emoji');
        emojiEl.className = ''; void emojiEl.offsetWidth;

        const gradeOrder = ["ì¼ë°˜", "ë§¤ì§", "ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"];
        const currentIdx = gradeOrder.indexOf(window.currentEmoji.grade);
        
        let successRate = 0.6;
        if(window.tarotBuff?.type === 'mutation_prob') { successRate += (window.tarotBuff.val / 100); }

        if (currentIdx < 4 && Math.random() < successRate) { 
            window.currentEmoji.grade = gradeOrder[currentIdx+1]; 
            window.currentEmoji.mutated = true; 
            window.currentEmoji.mutationHistory = "success"; 
            let nextRarity = parseFloat(window.currentEmoji.rarity) * 0.5;
            window.currentEmoji.rarity = nextRarity.toFixed(20);
            addLog(`ğŸ”® ë³€ì´ ì„±ê³µ! [${window.currentEmoji.grade}]`); emojiEl.classList.add('anim-success');
        } else { 
            window.currentEmoji.gene = false; 
            window.currentEmoji.mutationHistory = "fail"; 
            let nextRarity = parseFloat(window.currentEmoji.rarity) * 0.9;
            window.currentEmoji.rarity = nextRarity.toFixed(20);
            addLog(`ğŸ”® ë³€ì´ ì‹¤íŒ¨..`); emojiEl.classList.add('anim-fail');
        } 
        updateUI(); saveGame(2000); 
    };

    // [í•µì‹¬ ìˆ˜ì • 3] ë­í‚¹ ìµœì í™” íŒë§¤ ë¡œì§ (50ê°œ ì œí•œ & ì •ë ¬)
    // [ìˆ˜ì •ëœ íŒë§¤ í•¨ìˆ˜: RPë¥¼ í™•ì • ì €ì¥]
    // [2. ìˆ˜ì •ë¨] ìŠ¤ë§ˆíŠ¸ ì €ì¥ (ì „ì„¤ + í˜„ì—­ ëª¨ë‘ ìƒì¡´)
    window.sellItem = async function() { 
        if (!window.currentEmoji || window.currentEmoji.gone) return;
        
        let pathObj = evoPaths.find(p => p.name === window.currentEmoji.pathName) || { stages: ["â“","â“","â“","â“"] };
        const currentIcon = pathObj.stages[Math.min(3, Math.floor(window.currentEmoji.level / 5))];

        let sellBonus = (window.tarotBuff?.type === 'sell_bonus') ? (1 + window.tarotBuff.val/100) : 1.0;
        let finalVal = Math.floor(window.currentEmoji.value); 

        // RP ì ìˆ˜ ê³„ì‚°
        let currentProb = parseFloat(window.currentEmoji.rarity);
        let finalRP = getRareScore(currentProb);

        let rec = { 
            owner: window.nickname, 
            emoji: currentIcon, 
            prob: currentProb,
            rp: finalRP,
            val: finalVal, 
            grade: window.currentEmoji.grade, 
            lvl: window.currentEmoji.level, 
            date: Date.now(), 
            mutated: window.currentEmoji.mutated, 
            mutationHistory: window.currentEmoji.mutationHistory, 
            allInHistory: window.currentEmoji.allInHistory 
        };
        
        // 1. ê¸°ë¡ ì¶”ê°€
        if(!window.myHistory) window.myHistory = [];
        window.myHistory.push(rec); 
        
        // 2. ì ìˆ˜(RP) ë†’ì€ ìˆœ ì •ë ¬
        window.myHistory.sort((a, b) => {
            let rpA = a.rp !== undefined ? a.rp : getRareScore(a.prob);
            let rpB = b.rp !== undefined ? b.rp : getRareScore(b.prob);
            return rpB - rpA; 
        }); 

        // 3. ìŠ¤ë§ˆíŠ¸ í•„í„°ë§ (ì „ì²´ 50ìœ„ ì´ë‚´ OR ì´ë²ˆ ì£¼ ê¸°ë¡ì€ ì‚´ë ¤ë‘ )
        const weeklyStart = getWeeklyStartTimestamp(); 
        window.myHistory = window.myHistory.filter((item, index) => {
            if (index < 50) return true; // ëª…ì˜ˆì˜ ì „ë‹¹ (Top 50)
            if (item.date >= weeklyStart) return true; // ì´ë²ˆ ì£¼ í˜„ì—­
            return false; // ë‚˜ë¨¸ì§€ëŠ” ì‚­ì œ
        });

        // ë°ì´í„° í­ì¦ ë°©ì§€ (ìµœëŒ€ 200ê°œ ì œí•œ)
        if (window.myHistory.length > 200) window.myHistory = window.myHistory.slice(0, 200);

        // ìµœê³  ê¸°ë¡ ê°±ì‹ 
        let myBestRP = getRareScore(window.bestProb || 100);
        if (finalRP > myBestRP) { window.bestProb = currentProb; }

        window.gold += finalVal;
        addLog(`ğŸ’° íŒë§¤: +${finalVal.toLocaleString()} (RP: ${finalRP})`); 
        window.currentEmoji = null; 
        
        saveGame(0); updateUI(); 
    };


    function formatDateSimple(ts) {
        if(!ts) return "-";
        const d = new Date(ts);
        return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
    }

    // [í•µì‹¬ ìˆ˜ì • 4] ê¸€ë¡œë²Œ ë­í‚¹ í˜¸ì¶œ (50ëª… ì œí•œ)
    // [ìˆ˜ì •ëœ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜]
    // [3. ìˆ˜ì •ë¨] ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° (ì„œë²„ ë°ì´í„° + ë‚´ ë¡œì»¬ ë°ì´í„° ì¦‰ì‹œ ë°˜ì˜)
    async function syncGlobal(tabType) { 
        if(!db) { document.getElementById('rank-list').innerHTML = "<div style='padding:20px; text-align:center;'>DB ì—°ê²° ì‹¤íŒ¨</div>"; return; }
        document.getElementById('rank-list').innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>ë­í‚¹ ì§‘ê³„ ì¤‘...</div>";
        
        const weeklyLimit = getWeeklyStartTimestamp();

        try {
            // 1. ì„œë²„ì˜ ëª¨ë“  ìœ ì € ê°€ì ¸ì˜¤ê¸°
            const q = query(collection(db, "users")); 
            const snap = await getDocs(q); 
            
            let all = [];

            // 2. ì„œë²„ ë°ì´í„° í•©ì¹˜ê¸° (ë‹¨, 'ë‚˜'ì˜ ë°ì´í„°ëŠ” ì œì™¸ - ë‚´ í° ë°ì´í„°ê°€ ë” ìµœì‹ ì´ë‹ˆê¹Œ)
            snap.forEach(d => { 
                const data = d.data();
                if (data.nickname === window.nickname) return; // ë‚´ ì„œë²„ ë°ì´í„° ìŠ¤í‚µ

                if(data.h && Array.isArray(data.h)) {
                    const weeklyRecords = data.h.filter(item => {
                        if (!item.date) return false;
                        return item.date >= weeklyLimit;
                    });
                    all = all.concat(weeklyRecords); 
                }
            }); 

            // 3. 'ë‚˜'ì˜ ë¡œì»¬ ë°ì´í„° ê°•ì œ ì£¼ì… (ì¦‰ì‹œ ë°˜ì˜)
            if (window.myHistory && Array.isArray(window.myHistory)) {
                const myWeeklyRecords = window.myHistory.filter(item => {
                    if (!item.date) return false;
                    return item.date >= weeklyLimit;
                });
                myWeeklyRecords.forEach(r => r.owner = window.nickname);
                all = all.concat(myWeeklyRecords);
            }

            if (tabType === 'rarity') {
                // 4. í¬ê·€ë„ ë­í‚¹ ì •ë ¬
                cachedRarityRank = all.sort((a, b) => {
                    const scoreA = a.rp !== undefined ? a.rp : getRareScore(a.prob);
                    const scoreB = b.rp !== undefined ? b.rp : getRareScore(b.prob);
                    if (scoreA !== scoreB) return scoreB - scoreA;
                    return b.date - a.date;
                }).slice(0, 50);

                lastRankFetch = Date.now();
                
                const rankListEl = document.getElementById('rank-list');
                if (rankListEl && rankListEl.offsetParent !== null) { 
                    rankListEl.innerHTML = renderRanking(cachedRarityRank, 'rarity'); 
                }
                
                if(cachedRarityRank.length > 0) { 
                    document.getElementById('world-best-info').innerText = `ğŸ† 1ìœ„: ${cachedRarityRank[0].owner}`; 
                    document.getElementById('world-best-icon').innerText = cachedRarityRank[0].emoji; 
                } else {
                    document.getElementById('world-best-info').innerText = "ì´ë²ˆ ì£¼ ê¸°ë¡ ì—†ìŒ";
                    document.getElementById('world-best-icon').innerText = "ğŸ‘‘";
                }

            } else if (tabType === 'wealth') {
                // 5. ìì‚° ë­í‚¹ (ë™ì¼ ë¡œì§: ì„œë²„ ë°ì´í„°ë“¤ + ë‚´ í˜„ì¬ ìì‚°)
                let wealthList = [];
                snap.forEach(d => {
                    const data = d.data();
                    if (data.nickname === window.nickname) return;
                    wealthList.push({ owner: data.nickname, val: data.max_gold || data.g || 0, date: data.max_gold_date || Date.now() });
                });

                wealthList.push({ owner: window.nickname, val: window.maxGold, date: window.maxGoldDate });
                wealthList.sort((a, b) => b.val - a.val);
                
                const rankListEl = document.getElementById('rank-list');
                if (rankListEl.offsetParent !== null) { 
                    rankListEl.innerHTML = renderRanking(wealthList.slice(0, 50), 'wealth'); 
                }
            }
        } catch(e) { 
            console.error(e); 
            document.getElementById('rank-list').innerHTML = "ë­í‚¹ ë¡œë”© ì‹¤íŒ¨"; 
        } 
    }

    function renderRanking(list, type) {
        if (!list || list.length === 0) return "<div style='text-align:center; padding:20px; color:#555;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        return list.map((c, i) => {
            const rk = i + 1; const glw = (rk===1)?'rank-glow-1':(rk===2)?'rank-glow-2':(rk===3)?'rank-glow-3':'';
            const dateStr = formatDateSimple(c.date);
            if (type === 'wealth') {
                return `<div class="rank-card-wealth ${glw}"><div class="rank-col-rank">#${rk}</div><div class="rank-col-info" style="border-right:1px solid #222; justify-content:center; align-items:center;"><div class="rank-user">${c.owner}</div></div><div class="rank-col-info" style="align-items:flex-end; padding-right:15px;"><div class="rank-date" style="top:5px; right:5px;">${dateStr}</div><div style="font-size:0.55rem; color:#888; margin-top:5px;">ìµœê³  ìì‚°</div><div class="rank-gold" style="font-size:0.8rem; font-weight:bold; color:#ffd700;">${c.val.toLocaleString()} ğŸŸ¡</div></div></div>`;
            } else {
                const col = gradeInfo[c.grade]?.color; const tier = getTier(c.prob);
                const rp = getRareScore(c.prob);
                let badgeHtml = (tier.color==="EX") ? `<span class="tier-badge tier-badge-ex"><span class="tier-ex-gradient">EX</span></span>` : `<span class="tier-badge" style="color:${tier.color}; border-color:${tier.color}">${tier.text}</span>`;
                let probText = `<span style="font-size:0.6rem; font-weight:bold; color:${tier.color==="EX"?"#a29bfe":tier.color};">RP : ${rp.toLocaleString()}</span>`;
                let geneHtml = c.mutationHistory==='success'?" <span style='font-size:0.6rem; color:#00cec9; font-weight:bold;'>[ğŸ§¬ì„±ê³µ]</span>":(c.mutationHistory==='fail'?" <span style='font-size:0.6rem; color:#ff4757; font-weight:bold;'>[ğŸ§¬ì‹¤íŒ¨]</span>":"");
                let allInHtml = c.allInHistory==='success'?" <span style='font-size:0.6rem; color:#ff4757; font-weight:bold;'>[ğŸ”¥ALL-IN]</span>":"";
                return `<div class="rank-card-styled ${glw}"><div class="rank-col-rank">#${rk}</div><div class="rank-col-icon">${c.emoji}</div><div class="rank-col-info"><div class="rank-date">${dateStr}</div><div class="rank-user">${c.owner}</div><div class="rank-detail" style="color:${col}">${c.grade} +${c.lvl}${geneHtml}${allInHtml}</div><div class="rank-meta-row">${badgeHtml}<span class="rank-prob-thin">${probText}</span></div><div class="rank-gold">${c.val.toLocaleString()} ğŸŸ¡</div></div></div>`;
            }
        }).join('');
    }
    
    window.switchRankTab = (tab) => {
        window.currentRankTab = tab;
        document.querySelectorAll('.rank-tab').forEach(b => b.classList.remove('active'));
        if(tab === 'rarity') document.querySelectorAll('.rank-tab')[0].classList.add('active');
        else document.querySelectorAll('.rank-tab')[1].classList.add('active');
        syncGlobal(tab);
    }
    
    window.openMyHistory = () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', '');
        document.getElementById('rank-page').style.display = 'block';
        document.getElementById('rank-title').innerText = "ğŸ“œ ë‚˜ì˜ ëª…ì˜ˆì˜ ì „ë‹¹"; 
        document.getElementById('reset-timer').style.display = 'none';
        document.getElementById('rank-tabs-container').style.display = 'none';
        document.getElementById('my-wealth-banner').style.display = 'flex';
        document.getElementById('my-wealth-val').innerText = window.maxGold.toLocaleString() + " ğŸŸ¡";
        document.getElementById('my-wealth-date').innerText = formatDateSimple(window.maxGoldDate);
        document.getElementById('rank-list').innerHTML = renderRanking(window.myHistory, 'rarity'); 
    };
    
    window.openGlobalRanking = async () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', '');
        document.getElementById('rank-page').style.display = 'block';
        document.getElementById('rank-title').innerText = "ğŸŒ ê¸€ë¡œë²Œ ëª…ì˜ˆì˜ ì „ë‹¹"; 
        document.getElementById('reset-timer').style.display = 'inline-block';
        document.getElementById('rank-tabs-container').style.display = 'flex';
        document.getElementById('my-wealth-banner').style.display = 'none';
        updateResetTimer(); 
        await syncGlobal(window.currentRankTab); 
    };
    
    async function saveGame(delay = 2000) { 
        if(window.currentUserUid) {
            let bestProb = 100;
            if(window.myHistory.length > 0) bestProb = Math.min(...window.myHistory.map(h => parseFloat(h.prob)));
            
            const dataToSave = { 
                nickname: window.nickname, 
                g: window.gold, c: window.currentEmoji, h: window.myHistory, i: window.inventory,
                b: window.book, r: window.claimedRewards,
                max_gold: window.maxGold, max_gold_date: window.maxGoldDate,
                last_active: Date.now(), 
                best_prob: window.bestProb || 1, 
                last_reward_date: window.lastRewardDate,
                tarot_buff: window.tarotBuff,
                today_tarot_count: window.todayTarotCount,
                last_tarot_date: window.lastTarotDate,
                consumables: window.consumables, // ğŸ‘ˆ ì—¬ê¸°ì— ì½¤ë§ˆ(,) ê¼­ ì°ìœ¼ì„¸ìš”!
                
                // â­ [ì¶”ê°€] 50ì–µ ë³´ìƒ ë°›ì€ ê¸°ë¡ ì €ì¥
                claimedGradeRewards: window.claimedGradeRewards || []
            };

            
            localStorage.setItem('catSave_' + window.nickname, JSON.stringify(dataToSave)); 
            if(db) { 
                if(saveTimeout) clearTimeout(saveTimeout);
                const saveFunc = async () => { try { await setDoc(doc(db, "users", window.currentUserUid), dataToSave, { merge: true }); } catch(e) {} };
                if (delay === 0) saveFunc(); else saveTimeout = setTimeout(saveFunc, delay);
            }
        }
    }

    async function checkNicknameDuplicate(nick) {
        if(!db) return false;
        try { const q = query(collection(db, "users"), where("nickname", "==", nick)); const snap = await getDocs(q); return !snap.empty; } catch(e) { return false; }
    }

    window.googleLogin = async () => {
        const provider = new GoogleAuthProvider();
        document.getElementById('auth-msg').innerText = "Google ë¡œê·¸ì¸ ì‹œë„ ì¤‘...";
        try { await signInWithPopup(auth, provider); } catch (e) { document.getElementById('auth-msg').innerText = "ì‹¤íŒ¨: " + e.message; }
    }

    window.toggleJoinMode = () => {
        isJoinMode = !isJoinMode;
        document.getElementById('inp-nick').style.display = isJoinMode ? 'block' : 'none';
        document.getElementById('btn-auth-action').innerText = isJoinMode ? 'ê°€ì… ì™„ë£Œ' : 'ë¡œê·¸ì¸';
        document.getElementById('btn-mode-switch').innerText = isJoinMode ? 'ë¡œê·¸ì¸ ëª¨ë“œ' : 'íšŒì›ê°€ì…';
    };

    window.processAuth = async () => {
        const email = document.getElementById('inp-email').value;
        const pw = document.getElementById('inp-pw').value;
        const nick = document.getElementById('inp-nick').value.trim();
        const msg = document.getElementById('auth-msg');

        if(!email || !pw) { msg.innerText = "ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."; return; }
        try {
            if(isJoinMode) {
                if(!nick || nick.length < 2) { msg.innerText = "ë‹‰ë„¤ì„ í™•ì¸ í•„ìš”"; return; }
                if(await checkNicknameDuplicate(nick)) { msg.innerText = "ì¤‘ë³µëœ ë‹‰ë„¤ì„"; return; }
                const cred = await createUserWithEmailAndPassword(auth, email, pw);
                await setDoc(doc(db, "users", cred.user.uid), { 
                    nickname: nick, g: 200000, h: [], c: null, i: window.inventory, b: {}, r: [],
                    max_gold: 200000, max_gold_date: Date.now(), last_active: Date.now(), best_prob: 100, last_reward_date: 0
                });
                msg.innerText = "ê°€ì… ì„±ê³µ!";
            } else { await signInWithEmailAndPassword(auth, email, pw); }
        } catch(e) { msg.innerText = "ì˜¤ë¥˜: " + e.code; }
    };

    window.changeNickname = async () => {
        const newNick = prompt("ë³€ê²½í•  ë‹‰ë„¤ì„:");
        if(!newNick || newNick.trim().length < 2) return;
        const target = newNick.trim();
        if(await checkNicknameDuplicate(target)) { alert("ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."); return; }
        window.nickname = target; window.myHistory.forEach(h => h.owner = target);
        updateUI(); await saveGame(0);
        if(window.currentUserUid) await updateDoc(doc(db, "users", window.currentUserUid), { nickname: target });
        alert("ë³€ê²½ ì™„ë£Œ!");
    };
    // [ì¶”ê°€ 1] ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ì‹œì‘ í•¨ìˆ˜
    window.startGuestMode = () => {
        document.getElementById('nick-modal').style.display = 'none';
        
        // ê²ŒìŠ¤íŠ¸ ì´ˆê¸°ê°’ ì„¤ì • (ëœë¤ ë‹‰ë„¤ì„)
        window.nickname = "GUEST_" + Math.floor(Math.random() * 9000 + 1000);
        window.gold = 200000;
        window.maxGold = 200000;
        window.currentEmoji = null;
        window.myHistory = [];
        window.inventory = Array(10).fill(null).map((_, i) => ({ unlocked: i < 1, item: null }));
        window.book = {};
        window.claimedRewards = [];
        window.claimedGradeRewards = [];
        window.consumables = { protect: 0, charm_5: 0, charm_10: 0, charm_30: 0 };
        
        // ê²ŒìŠ¤íŠ¸ì„ì„ í‘œì‹œ (UID ë¹„ì›€)
        window.currentUserUid = null; 
        
        // 'ì €ì¥' ë²„íŠ¼ ë³´ì—¬ì£¼ê¸°
        const linkBtn = document.getElementById('btn-link-google');
        if(linkBtn) linkBtn.style.display = 'inline-block';
        
        addLog("ğŸ‘» ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
        addLog("âš ï¸ ì£¼ì˜: ì•±ì„ ì‚­ì œí•˜ê±°ë‚˜ ìºì‹œë¥¼ ì§€ìš°ë©´ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.");
        updateUI();
    };

    // [ì¶”ê°€ 2] ì•ˆì „ì¥ì¹˜ê°€ í¬í•¨ëœ ê³„ì • ì—°ë™(ì €ì¥) í•¨ìˆ˜
    window.linkGoogleAccount = async () => {
        if(!confirm("í˜„ì¬ í”Œë ˆì´ ì¤‘ì¸ ë°ì´í„°ë¥¼ êµ¬ê¸€ ê³„ì •ì— ì˜êµ¬ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const provider = new GoogleAuthProvider();
        try {
            // ì—°ë™ ì‹œì‘ í”Œë˜ê·¸ (onAuthStateChanged ìë™ ì‹¤í–‰ ë°©ì§€)
            window.isLinking = true; 

            // êµ¬ê¸€ ë¡œê·¸ì¸ íŒì—…
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            
            // ì„œë²„ ë°ì´í„° í™•ì¸ (ì¶©ëŒ ë°©ì§€)
            const userRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userRef);

            // í˜„ì¬ ë‚´ ë°ì´í„° íŒ¨í‚¤ì§• (ì´ê²Œ ì„œë²„ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤)
            const currentData = { 
                nickname: window.nickname, 
                g: window.gold, c: window.currentEmoji, h: window.myHistory, i: window.inventory,
                b: window.book, r: window.claimedRewards,
                claimedGradeRewards: window.claimedGradeRewards || [],
                max_gold: window.maxGold, max_gold_date: window.maxGoldDate,
                last_active: Date.now(), 
                best_prob: window.bestProb || 1, 
                last_reward_date: window.lastRewardDate,
                tarot_buff: window.tarotBuff,
                today_tarot_count: window.todayTarotCount,
                last_tarot_date: window.lastTarotDate,
                consumables: window.consumables
            };

            if (docSnap.exists()) {
                // âš ï¸ ì¶©ëŒ ê°ì§€: ì„œë²„ì— ì´ë¯¸ ë°ì´í„°ê°€ ìˆìŒ!
                const serverData = docSnap.data();
                const serverGold = serverData.g || 0;
                const serverNick = serverData.nickname || "ì•Œ ìˆ˜ ì—†ìŒ";

                const msg = `âš ï¸ ì´ë¯¸ ì €ì¥ëœ ë°ì´í„°ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
                            `[â˜ï¸ ì„œë²„ ë°ì´í„°]\në‹‰ë„¤ì„: ${serverNick}\nê³¨ë“œ: ${serverGold.toLocaleString()} ğŸŸ¡\n\n` +
                            `[ğŸ“± í˜„ì¬ ë°ì´í„°]\në‹‰ë„¤ì„: ${window.nickname}\nê³¨ë“œ: ${window.gold.toLocaleString()} ğŸŸ¡\n\n` +
                            `ğŸ‘‰ [í™•ì¸]: í˜„ì¬ ë°ì´í„°ë¡œ ë®ì–´ì”ë‹ˆë‹¤. (ì„œë²„ ë°ì´í„° ì‚­ì œ)\n` +
                            `ğŸ‘‰ [ì·¨ì†Œ]: ì„œë²„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (í˜„ì¬ ë°ì´í„° ì‚­ì œ)`;

                if (confirm(msg)) {
                    // í™•ì¸ -> ë®ì–´ì“°ê¸° (Guest Win)
                    await setDoc(userRef, currentData, { merge: true });
                    alert(`âœ… ì €ì¥ ì™„ë£Œ!\ní˜„ì¬ ë°ì´í„°ê°€ [${user.email}] ê³„ì •ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    finishLinking(user.uid);
                } else {
                    // ì·¨ì†Œ -> ë¶ˆëŸ¬ì˜¤ê¸° (Server Win)
                    alert("â˜ï¸ ì„œë²„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ ê²Œì„ì„ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.");
                    window.isLinking = false; 
                    location.reload(); 
                }
            } else {
                // âœ… ì•ˆì „: ì‹ ê·œ ì—°ë™
                await setDoc(userRef, currentData, { merge: true });
                alert(`âœ… ê³„ì • ì—°ë™ ì™„ë£Œ!\n[${user.email}] ê³„ì •ì— ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.`);
                finishLinking(user.uid);
            }

        } catch (e) {
            window.isLinking = false;
            console.error(e);
            if(e.code !== 'auth/popup-closed-by-user') {
                alert("ì—°ë™ ì‹¤íŒ¨: " + e.message);
            }
        }
    };

    function finishLinking(uid) {
        window.currentUserUid = uid;
        window.isLinking = false;
        document.getElementById('btn-link-google').style.display = 'none'; // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€
        updateUI();
    }

    onAuthStateChanged(auth, async (user) => {
        // [ìˆ˜ì • 1] ê³„ì • ì—°ë™(ì´ì‚¬) ì¤‘ì´ë©´ ìë™ ë¡œë“œ ì¤‘ë‹¨ (ì¶©ëŒ ë°©ì§€)
        if (window.isLinking) return;

        if (user) {
            // --- ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ---
            window.currentUserUid = user.uid;
            document.getElementById('nick-modal').style.display = 'none';
            
            // ë¡œê·¸ì¸ ìƒíƒœë‹ˆê¹Œ 'ì €ì¥' ë²„íŠ¼ ìˆ¨ê¹€
            const linkBtn = document.getElementById('btn-link-google');
            if(linkBtn) linkBtn.style.display = 'none'; 

            const snap = await getDoc(doc(db, "users", user.uid));
            if (snap.exists()) {
                const d = snap.data();
                window.nickname = d.nickname; window.gold = d.g; window.currentEmoji = d.c;
                window.myHistory = d.h || []; window.book = d.b || {}; window.claimedRewards = d.r || [];
                window.inventory = d.i || window.inventory;
                window.lastRewardDate = d.last_reward_date || 0;
                window.tarotBuff = d.tarot_buff || null;
                window.todayTarotCount = d.today_tarot_count || 0;
                window.lastTarotDate = d.last_tarot_date || 0;
                
                // 50ì–µ ë³´ìƒ & ì•„ì´í…œ ë°ì´í„° ë¡œë“œ
                window.consumables = d.consumables || { protect: 0, charm_5: 0, charm_10: 0, charm_30: 0 };
                window.claimedGradeRewards = d.claimedGradeRewards || [];
                
                updateBuffUI();

                window.bestProb = d.best_prob || 1;

                if(window.inventory.length < 10) { for(let k=0; k<10-window.inventory.length; k++) { window.inventory.push({ unlocked: false, item: null }); } }
                window.maxGold = d.max_gold || d.g || 200000; window.maxGoldDate = d.max_gold_date || Date.now();
                
                const today = new Date().toDateString(); const lastDate = new Date(window.lastRewardDate).toDateString();
                if(today !== lastDate) {
                    window.gold += 5000000; window.lastRewardDate = Date.now();
                    alert("ğŸ“… ì¼ì¼ ì§€ì›ê¸ˆì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!\n+5,000,000 ğŸŸ¡"); saveGame(0);
                }
                await checkDailyTarotReset(); 
                updateUI(); setTimeout(() => syncGlobal('rarity'), 500); 
            } else {
                // ì‹ ê·œ êµ¬ê¸€ ìœ ì € (ë°ì´í„° ì—†ìŒ)
                window.nickname = "User_" + user.uid.slice(0,4);
                window.gold = 200000; window.maxGold = 200000;
                // ì´ˆê¸°ê°’ ì„¤ì • ë“±...
                saveGame(0); updateUI();
            }
        } else { 
            // --- ë¡œê·¸ì•„ì›ƒ ìƒíƒœ (ê²ŒìŠ¤íŠ¸ ëŒ€ê¸°) ---
            // ëª¨ë‹¬ ë„ìš°ê¸°
            document.getElementById('nick-modal').style.display = 'flex'; 
        }
    });


    // [ìˆ˜ì •ë¨] ì•ˆì „ì¥ì¹˜ê°€ ì¶”ê°€ëœ ë¡œê·¸ì•„ì›ƒ/ì¢…ë£Œ í•¨ìˆ˜
    window.logout = () => {
        // 1. ê²ŒìŠ¤íŠ¸ ìœ ì €ì¸ì§€ í™•ì¸ (UIDê°€ ì—†ìœ¼ë©´ ê²ŒìŠ¤íŠ¸)
        if (!window.currentUserUid) {
            const msg = `ğŸš¨ ë°ì´í„° ì‚­ì œ ê²½ê³ ! ğŸš¨\n\n` +
                        `í˜„ì¬ [ê²ŒìŠ¤íŠ¸ ëª¨ë“œ]ë¡œ í”Œë ˆì´ ì¤‘ì…ë‹ˆë‹¤.\n` +
                        `ê³„ì •ì„ ì—°ë™í•˜ì§€ ì•Šê³  ì¢…ë£Œí•˜ë©´\n` +
                        `ì§€ê¸ˆê¹Œì§€ ëª¨ì€ ê³¨ë“œì™€ ì´ëª¨ì§€ê°€ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤!\n\n` +
                        `ë°ì´í„°ë¥¼ ì§€í‚¤ë ¤ë©´ [ì·¨ì†Œ]ë¥¼ ëˆ„ë¥´ê³ \n` +
                        `ìƒë‹¨ì˜ ë¶‰ì€ìƒ‰ [ğŸ’¾ ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.\n\n` +
                        `ì •ë§ë¡œ ì „ë¶€ ì§€ìš°ê³  ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (confirm(msg)) {
                // í™•ì¸(Yes)ì„ ëˆ„ë¥´ë©´ -> ë°ì´í„° í¬ê¸°í•˜ê³  ì¬ì‹œì‘
                location.reload(); 
            } else {
                // ì·¨ì†Œ(No)ë¥¼ ëˆ„ë¥´ë©´ -> ì•„ë¬´ ì¼ë„ ì•ˆ í•¨ (ìœ ì € ë³´í˜¸)
                return;
            }
        } 
        // 2. êµ¬ê¸€ ë¡œê·¸ì¸ ìœ ì €ì¸ ê²½ìš°
        else {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                signOut(auth).then(() => location.reload());
            }
        }
    };

    async function init() {
        history.replaceState(null, '', location.href);
        history.pushState({ main: true }, '', '');
        updateResetTimer(); updateUI();
    }
    init();
</script>
</body>
</html>

