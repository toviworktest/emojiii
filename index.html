<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê³ ì–‘ì´ ì§„í™” ì‹œë®¬ë ˆì´í„° PRO</title>
    <style>
        :root {
            --common: #b2bec3; --uncommon: #00cec9; --rare: #a29bfe; --legendary: #fab1a0; --mythic: #ff7675;
            --success-color: #2ecc71; --stay-color: #f1c40f; --destroy-color: #e74c3c;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: #0d0d0d; color: #eee; margin: 0; padding: 10px; overflow-x: hidden; }
        .game-container { width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
        
        /* ë ˆì´ì•„ì›ƒ êµ¬ì„± */
        .top-section { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 10px; }
        .left-column { display: flex; flex-direction: column; gap: 10px; }
        
        .cat-view { 
            height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border: 2px solid #333; border-radius: 12px 12px 0 0; background: radial-gradient(circle, #222 0%, #000 100%); position: relative;
            transition: 0.3s;
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 20% { transform: translate(-3px, 0px) rotate(-1deg); }
            40% { transform: translate(3px, 2px) rotate(1deg); } 60% { transform: translate(-1px, -1px) rotate(0deg); }
            80% { transform: translate(3px, 1px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(0deg); }
        }
        .anim-shake { animation: shake 0.5s; }
        @keyframes success-glow {
            0% { box-shadow: 0 0 5px var(--success-color); } 50% { box-shadow: 0 0 25px var(--success-color); } 100% { box-shadow: 0 0 5px var(--success-color); }
        }
        .anim-success { animation: success-glow 0.8s; border-color: var(--success-color) !important; }

        .nyang-bar { background: #222; border: 2px solid #333; border-top: none; padding: 10px; text-align: center; border-radius: 0 0 12px 12px; color: #ffd700; font-weight: bold; font-size: 1.1rem; }
        
        /* â­ ë¹¨ê°„ ìŠ¤ì¼€ì¹˜ ë¡œê·¸ ì˜ì—­ */
        .in-game-log { height: 160px; background: #0a0a0a; border: 2px solid #e74c3c; border-radius: 12px; padding: 10px; font-size: 0.75rem; overflow-y: auto; color: #aaa; line-height: 1.5; }
        
        .status-window { background: #1a1a1a; padding: 8px; border: 1px solid #333; border-radius: 8px; font-size: 0.7rem; display: flex; flex-direction: column; gap: 4px; }
        .status-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 2px 0; }
        
        .unified-gauge-container { margin: 8px 0; background: #111; padding: 8px; border-radius: 8px; border: 1px solid #333; }
        .unified-gauge { width: 100%; height: 16px; background: #333; border-radius: 8px; display: flex; overflow: hidden; }
        .gauge-segment { height: 100%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        .btn-stack { display: flex; flex-direction: column; gap: 6px; }
        button { padding: 12px 5px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .btn-buy { background: #2ecc71; color: white; }
        .btn-adopt { background: #f1c40f; color: #333; }
        .btn-evolve { background: #6c5ce7; color: white; }
        .btn-gene { background: #444; color: #888; }
        .btn-gene.active { background: #d63031; color: white; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        button:disabled { opacity: 0.2; filter: grayscale(1); cursor: not-allowed; }
        
        /* 1ìœ„ ì „ìš© ìŠ¬ë¡¯ */
        .rank-one-slot { border: 2px solid #ffd700 !important; background: linear-gradient(145deg, #1e272e, #000); border-radius: 12px; height: 130px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; text-align: center; margin-top: 5px; }

        #hall-of-fame-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0d0d0d; z-index: 1000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .rank-item { background: #1a1a1a; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #333; }
    </style>
</head>
<body>

<div class="game-container">
    <div class="top-section">
        <div class="left-column">
            <div class="cat-evolution-card">
                <div class="cat-view" id="cat-display-area">
                    <div id="grade-badge" style="position:absolute; top:12px; right:12px; font-size:0.7rem;">ëŒ€ê¸°</div>
                    <div id="cat-level" style="font-size:3.5rem; font-weight:900;">?</div>
                    <div id="cat-name" style="font-size: 0.9rem; margin-top: 5px; font-weight: bold;">ì…ì–‘ ëŒ€ê¸° ì¤‘</div>
                </div>
                <div class="nyang-bar" id="gold-display">0 ëƒ¥</div>
            </div>
            <div class="in-game-log" id="game-log"></div>
        </div>

        <div class="control-panel">
            <div class="status-window">
                <div class="status-row"><span>ë¶„ì–‘ê°€</span><span id="st-value">-</span></div>
                <div class="status-row"><span>ë“±ê¸‰</span><span id="st-grade">-</span></div>
                <div class="status-row"><span>ë³€ì´ìœ ì „ì</span><span id="st-gene">-</span></div>
                <div class="status-row" style="color:#ffd700; font-weight:bold; margin-top:5px;">
                    <span>ì¡´ì¬ í™•ë¥ </span><span id="st-rarity">-</span>
                </div>
            </div>
            
            <div class="unified-gauge-container">
                <div class="unified-gauge">
                    <div id="seg-s" class="gauge-segment" style="background:var(--success-color); width:0%"></div>
                    <div id="seg-m" class="gauge-segment" style="background:var(--stay-color); width:0%"></div>
                    <div id="seg-b" class="gauge-segment" style="background:var(--destroy-color); width:0%"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.55rem; margin-top:5px; font-weight:bold;">
                    <span style="color:var(--success-color)">ì„±ê³µ <span id="val-s">0%</span></span>
                    <span style="color:var(--stay-color)">ìœ ì§€ <span id="val-m">0%</span></span>
                    <span style="color:var(--destroy-color)">ê°€ì¶œ <span id="val-b">0%</span></span>
                </div>
            </div>

            <div class="btn-stack">
                <button id="btn-gene" class="btn-gene" onclick="mutateGene()">ìœ ì „ì ë³€ì´ (500,000)</button>
                <button id="btn-evolve" class="btn-evolve" onclick="evolve()">ì§„í™”</button>
                <button id="btn-buy" class="btn-buy" onclick="fetchNewCat()">ë°ë ¤ì˜¤ê¸° (1,000)</button>
                <button id="btn-adopt" class="btn-adopt" onclick="adoptOut()">ë¶„ì–‘ ë³´ë‚´ê¸°</button>
                <button style="background:#333; color:#aaa; margin-top:5px; font-size:0.7rem;" onclick="resetGame()">ğŸ³ï¸ ë°ì´í„° ë¦¬ì…‹</button>
            </div>
        </div>
    </div>
    
    <div class="rank-one-slot" id="rank-one-btn" onclick="openHallOfFame()">
        <span style="color:#444">ê¸°ë¡ëœ ì „ì„¤ì´ ì—†ìŠµë‹ˆë‹¤.</span>
    </div>
</div>

<div id="hall-of-fame-page">
    <h2 style="color:#ffd700; text-align:center;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (TOP 20)</h2>
    <div id="rank-list-container"></div>
    <button style="width:100%; padding:15px; margin-top:15px; background:#444; color:white; border:none; border-radius:8px;" onclick="closeHallOfFame()">ëŒì•„ê°€ê¸°</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // â­ íŒŒì´ì–´ë² ì´ìŠ¤ API ì„¤ì • $\star$
    const firebaseConfig = {
       apiKey: "AIzaSyA-QVwu7jpUUeLH3jtqYHChfwOW3FHY3pc",
  authDomain: "gkyoungee.firebaseapp.com",
  projectId: "gkyoungee",
  storageBucket: "gkyoungee.firebasestorage.app",
  messagingSenderId: "903817816298",
  appId: "1:903817816298:web:a607dd06d9729bc7a60f93"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let myId = localStorage.getItem('catGameId') || 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('catGameId', myId);

    window.gold = parseFloat(localStorage.getItem('gold')) || 10000;
    window.currentCat = JSON.parse(localStorage.getItem('currentCat')) || null;
    window.catHistory = JSON.parse(localStorage.getItem('catHistory')) || [];

    const gradeInfo = {
        "ê¸¸ê³ ì–‘ì´": { color: "#b2bec3", mod: 1.0, rank: 0, names: ["ì¹˜ì¦ˆëƒ¥", "ê³ ë“±ì–´ëƒ¥"], baseProb: 61.5, upBonus: 1.2, penalty: 0.5 },
        "ì§‘ê³ ì–‘ì´": { color: "#00cec9", mod: 0.85, rank: 1, names: ["ìƒ´", "í˜ë¥´ì‹œì•ˆ"], baseProb: 25.0, upBonus: 1.5, penalty: 0.6 },
        "í’ˆì¢…ë¬˜": { color: "#a29bfe", mod: 0.7, rank: 2, names: ["ë±…ê°ˆ", "ëŸ¬ì‹œì•ˆë¸”ë£¨"], baseProb: 10.0, upBonus: 2.0, penalty: 0.7 },
        "ì˜ë¬¼": { color: "#fdcb6e", mod: 0.5, rank: 3, names: ["ë©”ì¸ì¿¤", "ë ‰ëŒ"], baseProb: 3.0, upBonus: 2.5, penalty: 0.8 },
        "ì‹ ìˆ˜": { color: "#ff7675", mod: 0.3, rank: 4, names: ["ë² ë¥´ë§Œ", "ë…¸ë¥´ì›¨ì´ìˆ²"], baseProb: 0.5, upBonus: 3.5, penalty: 0.9 }
    };

    window.addLog = (msg, color = "#aaa") => {
        const logBox = document.getElementById('game-log');
        logBox.innerHTML = `<div style="color:${color}; margin-bottom:4px;">> ${msg}</div>` + logBox.innerHTML;
    };

    window.updateUI = function() {
        document.getElementById('gold-display').innerText = window.gold.toLocaleString() + " ëƒ¥";
        const buyBtn = document.getElementById('btn-buy');
        const evolveBtn = document.getElementById('btn-evolve');
        const geneBtn = document.getElementById('btn-gene');
        const adoptBtn = document.getElementById('btn-adopt');

        if (window.currentCat) {
            const info = gradeInfo[window.currentCat.grade];
            const lvl = window.currentCat.level;
            let b = (lvl < 5) ? 0 : Math.min(20, (lvl - 4) * 2); 
            let m = Math.min(50, lvl * (7 / info.mod)); 
            let s = Math.max(10, 100 - b - m); 

            window.currentCat.existenceProbability = (info.baseProb * (window.currentCat.survivalRate / 100)).toFixed(8);
            
            // â­ [ì§€ìˆ˜ í•˜í–¥ ì ìš©] íŒë§¤ê°€ ê³µì‹: 1.55 ì§€ìˆ˜ ì‚¬ìš©
            let mult = window.currentCat.isGeneticMutation ? info.upBonus : 1.0;
            const price = Math.floor(1000 * (info.rank + 1) * 10 * Math.pow(1.55, lvl) * mult);
            window.currentCat.marketValue = price;

            // â­ [ë°¸ëŸ°ìŠ¤ ì¡°ì •] ì§„í™” ë¹„ìš© ê³µì‹: 1.75 ì§€ìˆ˜ ì‚¬ìš© (ìˆ˜ìµë³´ë‹¤ ë¹„ìš©ì´ ë¹ ë¥´ê²Œ ì¦ê°€)
            const cost = Math.floor(2000 * Math.pow(1.75, lvl));
            evolveBtn.innerText = `ì§„í™” (${cost.toLocaleString()} ëƒ¥)`;
            evolveBtn.disabled = window.gold < cost;

            document.getElementById('cat-level').innerText = "+" + lvl;
            document.getElementById('cat-level').style.color = info.color;
            document.getElementById('cat-name').innerText = window.currentCat.name;
            document.getElementById('grade-badge').innerText = window.currentCat.grade;
            document.getElementById('grade-badge').style.color = info.color;
            document.getElementById('st-value').innerText = price.toLocaleString();
            document.getElementById('st-grade').innerText = window.currentCat.grade;
            document.getElementById('st-gene').innerText = window.currentCat.isGeneticMutation ? "ë°œí˜„ë¨" : (window.currentCat.geneActive ? "ë³´ìœ " : "ì—†ìŒ");
            document.getElementById('st-rarity').innerText = window.currentCat.existenceProbability + "%";
            
            document.getElementById('seg-s').style.width = s + "%";
            document.getElementById('seg-m').style.width = m + "%";
            document.getElementById('seg-b').style.width = b + "%";
            document.getElementById('val-s').innerText = Math.floor(s) + "%";
            document.getElementById('val-m').innerText = Math.floor(m) + "%";
            document.getElementById('val-b').innerText = Math.floor(b) + "%";

            buyBtn.disabled = true;
            adoptBtn.disabled = false;

            geneBtn.disabled = !(window.currentCat.geneActive && !window.currentCat.isGeneticMutation && lvl >= 5 && window.gold >= 500000);
            if (!geneBtn.disabled) geneBtn.classList.add('active'); else geneBtn.classList.remove('active');
        } else {
            document.getElementById('cat-level').innerText = "?";
            document.getElementById('cat-level').style.color = "#eee";
            document.getElementById('cat-name').innerText = "ì…ì–‘ ëŒ€ê¸° ì¤‘";
            evolveBtn.innerText = "ì§„í™”";
            buyBtn.disabled = false; evolveBtn.disabled = true; adoptBtn.disabled = true; geneBtn.disabled = true;
            document.querySelectorAll('.gauge-segment').forEach(el => el.style.width = "0%");
        }
        updateRankOneUI();
    };

    window.fetchNewCat = () => {
        if (window.gold < 1000) return;
        window.gold -= 1000;
        const r = Math.random() * 100;
        let g = "ê¸¸ê³ ì–‘ì´";
        if (r < 0.5) g = "ì‹ ìˆ˜"; else if (r < 3.5) g = "ì˜ë¬¼"; else if (r < 13.5) g = "í’ˆì¢…ë¬˜"; else if (r < 38.5) g = "ì§‘ê³ ì–‘ì´";
        window.currentCat = { name: gradeInfo[g].names[Math.floor(Math.random()*2)], grade: g, level: 0, geneActive: Math.random() < 0.35, isGeneticMutation: false, survivalRate: 100 };
        window.addLog(`ğŸ¾ [${g}] ê³ ì–‘ì´ë¥¼ ë°ë ¤ì™”ìŠµë‹ˆë‹¤.`);
        updateUI(); saveGame();
    };

    window.mutateGene = () => {
        if (!window.currentCat || window.gold < 500000) return;
        window.gold -= 500000;
        const grades = Object.keys(gradeInfo);
        const idx = grades.indexOf(window.currentCat.grade);
        if (idx < grades.length - 1 && Math.random() < 0.6) {
            window.currentCat.grade = grades[idx+1];
            window.currentCat.isGeneticMutation = true;
            window.currentCat.survivalRate *= 0.6;
            window.addLog(`ğŸ”® ë³€ì´ ì„±ê³µ! [${window.currentCat.grade}] ë“±ê¸‰ ìƒìŠ¹`, "#fab1a0");
            playAnimation('success');
        } else {
            window.currentCat.isGeneticMutation = false;
            window.currentCat.geneActive = false;
            window.currentCat.survivalRate *= 0.4;
            window.addLog(`ğŸ”® ë³€ì´ ì‹¤íŒ¨... ìœ ì „ì ì†ìƒ`, "#e74c3c");
            playAnimation('shake');
        }
        updateUI(); saveGame();
    };

    window.evolve = () => {
        const cost = Math.floor(2000 * Math.pow(1.75, window.currentCat.level));
        if (window.gold < cost) return;
        window.gold -= cost;
        const lvl = window.currentCat.level;
        const info = gradeInfo[window.currentCat.grade];
        let b = (lvl < 5) ? 0 : Math.min(20, (lvl - 4) * 2); 
        let m = Math.min(50, lvl * (7 / info.mod)); 
        let s = Math.max(10, 100 - b - m); 
        const r = Math.random() * 100;
        if (r <= s + m) {
            if (r <= s) { 
                window.currentCat.level++; 
                window.addLog(`âœ¨ ì§„í™” ì„±ê³µ! +${window.currentCat.level}`, "#2ecc71"); 
                playAnimation('success');
            } else { 
                window.addLog("ğŸ’¨ ë“±ê¸‰ ìœ ì§€", "#f1c40f"); 
                playAnimation('shake');
            }
            window.currentCat.survivalRate *= ((s + m) / 100);
        } else {
            window.addLog(`ğŸ˜­ +${window.currentCat.level} ê³ ì–‘ì´ê°€ ê°€ì¶œí–ˆìŠµë‹ˆë‹¤.`, "#e74c3c");
            window.currentCat = null;
        }
        updateUI(); saveGame();
    };

    function playAnimation(type) {
        const el = document.getElementById('cat-display-area');
        const cls = type === 'success' ? 'anim-success' : 'anim-shake';
        el.classList.remove('anim-success', 'anim-shake');
        void el.offsetWidth;
        el.classList.add(cls);
        setTimeout(() => el.classList.remove(cls), 800);
    }

    window.adoptOut = function() {
        if (!window.currentCat) return;
        const record = {
            existenceProbability: parseFloat(window.currentCat.existenceProbability),
            marketValue: window.currentCat.marketValue,
            isGeneticMutation: window.currentCat.isGeneticMutation,
            grade: window.currentCat.grade,
            enhancementCount: window.currentCat.level,
            timestamp: Date.now()
        };
        window.catHistory.push(record);
        window.catHistory.sort((a, b) => a.existenceProbability - b.existenceProbability);
        window.catHistory = window.catHistory.slice(0, 20);

        window.gold += record.marketValue;
        window.addLog(`ğŸ’° ë¶„ì–‘ ì™„ë£Œ! +${record.marketValue.toLocaleString()} ëƒ¥ íšë“`, "#ffd700");
        window.currentCat = null;
        updateUI(); saveGame();
    };

    window.resetGame = function() {
        if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  10,000ëƒ¥ë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ê¹Œìš”?")) {
            localStorage.clear();
            location.reload();
        }
    };

    function updateRankOneUI() {
        const btn = document.getElementById('rank-one-btn');
        if (window.catHistory.length === 0) return;
        const top = window.catHistory[0];
        btn.innerHTML = `
            <div style="font-size:0.6rem; color:#ffd700; margin-bottom:5px;">ğŸ† CURRENT LEGEND #1</div>
            <div style="color:${gradeInfo[top.grade].color}; font-size:2.2rem; font-weight:900;">+${top.enhancementCount}</div>
            <div style="font-weight:bold; font-size:1rem; color:#fff;">${top.grade}</div>
            <div style="color:#ffd700; font-size:0.75rem; font-weight:bold;">í™•ë¥ : ${top.existenceProbability}%</div>
            <div style="color:#888; font-size:0.6rem;">ê°€ì¹˜: ${top.marketValue.toLocaleString()} ëƒ¥</div>
        `;
    }

    window.openHallOfFame = () => {
        const container = document.getElementById('rank-list-container');
        document.getElementById('hall-of-fame-page').style.display = 'block';
        container.innerHTML = window.catHistory.map((c, i) => `
            <div class="rank-item" style="border-left-color:${gradeInfo[c.grade].color}">
                <div>
                    <span style="color:#ffd700; font-weight:bold;">Rank ${i+1}</span>
                    <span style="color:${gradeInfo[c.grade].color}; font-weight:900; margin-left:10px;">+${c.enhancementCount} ${c.grade}</span>
                    <div style="font-size:0.6rem; color:#666;">ê°€ì¹˜: ${c.marketValue.toLocaleString()} | ë³€ì´: ${c.isGeneticMutation ? 'O' : 'X'}</div>
                </div>
                <div style="text-align:right; color:#ffd700; font-weight:bold;">${c.existenceProbability}%</div>
            </div>
        `).join('') || "<p style='text-align:center;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    };

    window.closeHallOfFame = () => document.getElementById('hall-of-fame-page').style.display = 'none';

    async function saveGame() {
        localStorage.setItem('gold', window.gold);
        localStorage.setItem('catHistory', JSON.stringify(window.catHistory));
        localStorage.setItem('currentCat', JSON.stringify(window.currentCat));
        try { await setDoc(doc(db, "users", myId), { gold: window.gold, currentCat: window.currentCat, catHistory: window.catHistory }); } catch(e) {}
    }

    async function loadGame() {
        try {
            const snap = await getDoc(doc(db, "users", myId));
            if (snap.exists()) {
                const d = snap.data();
                window.gold = d.gold !== undefined ? d.gold : window.gold;
                window.catHistory = d.catHistory || window.catHistory;
                window.currentCat = d.currentCat || window.currentCat;
            }
        } catch(e) {}
        updateUI();
    }
    loadGame();
</script>
</body>
</html>

