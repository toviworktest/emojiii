<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì´ëª¨ì§€ ì§„í™” : 100 Collection</title>
    <style>
        :root {
            --common: #b2bec3; --magic: #00cec9; --rare: #a29bfe; --epic: #fab1a0; --legendary: #ff7675;
            --success: #2ecc71; --stay: #f1c40f; --destroy: #e74c3c; --bg: #0d0d0d; --panel: #111; --border: #333;
            --purple-btn: #9c27b0;
        }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; background-color: var(--bg); color: #eee; margin: 0; padding: 10px; overflow-x: hidden; }
        .game-container { width: 100%; max-width: 560px; margin: 0 auto; display: flex; flex-direction: column; gap: 8px; }
        
        /* ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        .main-split { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: stretch; }
        .left-col, .right-col { display: flex; flex-direction: column; gap: 8px; }

        .canvas-area { height: 180px; background: #1a1a1a; border: 2px solid var(--border); border-radius: 12px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .canvas-overlay { position: absolute; top: 0; left: 0; width: 100%; padding: 8px 10px; box-sizing: border-box; background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%); display: flex; justify-content: space-between; align-items: center; z-index: 5; }
        #overlay-grade { font-size: 0.65rem; font-weight: bold; }
        #overlay-name-level { font-size: 0.8rem; font-weight: 900; }
        .emoji-wrap { display: flex; align-items: center; gap: 10px; font-size: 4.2rem; }
        .deco-icon { font-size: 1.5rem; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .in-game-log { height: 180px; background: #050505; border: 1px solid #e74c3c44; border-radius: 10px; padding: 10px; font-size: 0.75rem; overflow-y: auto; color: #aaa; line-height: 1.5; scroll-behavior: smooth; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        .info-cell { background: var(--panel); padding: 8px; display: flex; flex-direction: column; gap: 2px; }
        .info-label { font-size: 0.55rem; color: #666; }
        .info-value { font-weight: bold; color: #fff; font-size: 0.75rem; }

        .gauge-mini { background: var(--panel); padding: 8px; border-radius: 10px; border: 1px solid var(--border); }
        .gauge-bar { width: 100%; height: 8px; background: #222; border-radius: 4px; display: flex; overflow: hidden; margin: 4px 0; }
        .gauge-seg { height: 100%; transition: width 0.3s; }
        .gauge-text { display: flex; justify-content: space-between; font-size: 0.45rem; font-weight: bold; }

        .wealth-box { background: #222; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #ffd70044; color: #ffd700; font-weight: 900; font-size: 1.2rem; }

        .btn-stack { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        button { padding: 10px 5px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.1s; position: relative; overflow: hidden; }
        button:disabled { opacity: 0.15; filter: grayscale(1); cursor: not-allowed; }
        .btn-evolve { background: #6c5ce7; color: white; grid-column: span 2; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        .btn-buy { background: var(--success); color: white; }
        .btn-sell { background: var(--stay); color: #333; }
        .btn-gene { background: #333; color: #777; font-size: 0.7rem; grid-column: span 2; }
        .btn-nav { background: #2d3436; color: white; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50px; }
        
        /* ë­í‚¹ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .world-rank-btn { 
            background: #000; border: 2px solid var(--purple-btn); padding: 12px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            color: white; cursor: pointer; margin-top: 5px; transition: 0.3s; box-shadow: 0 0 10px rgba(156, 39, 176, 0.2); 
        }
        .world-rank-left { text-align: left; }
        .world-rank-label { color: var(--purple-btn); font-size: 0.65rem; font-weight: 900; letter-spacing: 1px; margin-bottom: 2px; }
        .world-rank-val { font-size: 0.8rem; font-weight: bold; color: #ddd; }
        .world-rank-icon { font-size: 2rem; margin-left: 10px; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .my-rank-btn { background: #1a1a1a; border: 1px solid #444; color: #aaa; }

        /* ëª¨ë‹¬ ë° ë¡œê·¸ì¸ í¼ ìŠ¤íƒ€ì¼ */
        .full-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .inv-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; aspect-ratio: 1/1; margin: 20px 0; }
        .inv-slot { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; aspect-ratio: 1/1; }
        .inv-slot.locked { background: #0a0a0a; color: #444; border-style: dashed; font-size: 0.5rem; text-align: center; }
        .inv-slot.selected { border: 2px solid #fff; box-shadow: 0 0 10px #fff; z-index: 10; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0px #fff; } 50% { box-shadow: 0 0 8px #fff; } 100% { box-shadow: 0 0 0px #fff; } }

        .inv-emoji { font-size: 1.7rem; }
        .inv-tag { position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 0.45rem; color: #888; font-weight: bold; }
        
        /* ì¸ë²¤í† ë¦¬ í—¤ë” */
        .inv-status-bar { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; cursor: pointer; transition: 0.2s; }
        .inv-status-bar:active { transform: scale(0.98); background: #333; }
        .inv-current-info { display: flex; align-items: center; gap: 10px; }
        .inv-current-icon { font-size: 2rem; }
        .inv-hint { font-size: 0.7rem; color: #666; text-align: center; margin-bottom: 10px; background: #111; padding: 8px; border-radius: 6px; }

        #nick-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background:#1a1a1a; padding:25px; border-radius:15px; border:2px solid #e74c3c; text-align:center; width:85%; max-width:340px; }
        .login-input { width:100%; padding:12px; background:#000; border:1px solid #444; color:white; border-radius:8px; margin: 5px 0; box-sizing:border-box; font-size: 1rem; }
        .login-btn { width:48%; padding:12px; border:none; border-radius:8px; font-weight:bold; margin-top: 10px; font-size: 0.9rem; cursor: pointer; }
        .btn-join { background: #00cec9; color: #000; }
        .btn-login { background: #e74c3c; color: white; }
        
        .glow-legendary { animation: text-glow 1.5s infinite alternate; }
        @keyframes text-glow { from { text-shadow: 0 0 5px #ff7675; } to { text-shadow: 0 0 20px #ff7675; } }
        
        /* ë­í‚¹ ìŠ¤íƒ€ì¼ */
        .rank-card-slim { display: grid; grid-template-columns: 45px 45px 1fr; gap: 5px; background: #111; border-radius: 10px; margin-bottom: 8px; border: 1px solid #222; align-items: stretch; overflow: hidden; }
        .rank-block { display: flex; align-items: center; justify-content: center; background: #1a1a1a; font-weight: 900; font-size: 0.8rem; aspect-ratio: 1/1; }
        .rank-info-block { padding: 8px 12px; display: flex; flex-direction: column; justify-content: center; font-size: 0.7rem; }
        .rank-glow-1 { box-shadow: 0 0 20px gold; border-color: gold !important; }
        
        /* ë„ê° ìŠ¤íƒ€ì¼ */
        .rate-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; background: #1a1a1a; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .rate-table th, .rate-table td { padding: 10px; text-align: center; border-bottom: 1px solid #333; }
        .rate-table th { background: #222; color: #aaa; }
        .book-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .book-item { background: #1a1a1a; padding: 12px; border-radius: 12px; border: 1px solid #333; margin-bottom: 5px; }
        .book-item span { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.1rem; margin-top: 5px; color: #ddd; }
        
        /* íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div id="nick-modal">
    <div class="login-box">
        <h2 style="color:#ffd700; margin-top:0;">SYSTEM LOGIN</h2>
        <p style="color:#f1c40f; font-size:0.8rem; margin:10px 0; font-weight:bold; background:#332b00; padding:8px; border-radius:5px;">
            âš  ë³´ì•ˆ ì£¼ì˜: ê¸ˆìœµ/ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© ê¸ˆì§€
        </p>
        <input type="text" id="inp-nick" class="login-input" placeholder="ë‹‰ë„¤ì„ (ID)" maxlength="12">
        <input type="password" id="inp-pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="20">
        <div style="display:flex; justify-content:space-between;">
            <button class="login-btn btn-join" onclick="handleAuth('signup')">ìƒˆë¡œ ì‹œì‘ (ê°€ì…)</button>
            <button class="login-btn btn-login" onclick="handleAuth('login')">ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œê·¸ì¸)</button>
        </div>
        <div id="auth-msg" style="color:#ff7675; font-size:0.75rem; margin-top:10px; height:15px;"></div>
    </div>
</div>

<div class="game-container">
    <div class="main-split">
        <div class="left-col">
            <div class="canvas-area" id="display-area" title="ì•„ì´í…œ êº¼ë‚´ê¸°/ë„£ê¸°">
                <div class="canvas-overlay">
                    <span id="overlay-grade">-</span>
                    <span id="overlay-name-level">ì¤€ë¹„ë¨</span>
                </div>
                <div class="emoji-wrap">
                    <span id="deco-l" class="deco-icon"></span>
                    <span id="main-emoji">ğŸ”’</span>
                    <span id="deco-r" class="deco-icon"></span>
                </div>
            </div>
            <div id="game-log" class="in-game-log"></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div id="my-id-label" style="font-size:0.6rem; color:#444; padding-left:5px;">ID: -</div>
                <button onclick="logout()" style="background:#333; color:#aaa; font-size:0.6rem; padding:2px 8px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="right-col">
            <div class="info-grid">
                <div class="info-cell"><span class="info-label">ê°€ì¹˜</span><span class="info-value" id="st-value">-</span></div>
                <div class="info-cell"><span class="info-label">ë“±ê¸‰</span><span class="info-value" id="st-grade">-</span></div>
                <div class="info-cell"><span class="info-label">ìœ ì „ì</span><span class="info-value" id="st-gene">-</span></div>
                <div class="info-cell"><span class="info-label" style="color:#ffd700;">í¬ê·€ë„</span><span class="info-value" id="st-rarity" style="color:#ffd700;">-</span></div>
            </div>
            <div class="gauge-mini">
                <div class="gauge-text"><span style="color:var(--success)">ì„±ê³µ <span id="val-s">0%</span></span><span style="color:var(--destroy)">íŒŒê´´ <span id="val-b">0%</span></span></div>
                <div class="gauge-bar"><div id="seg-s" class="gauge-seg" style="background:var(--success); width:0%"></div><div id="seg-m" class="gauge-seg" style="background:var(--stay); width:0%"></div><div id="seg-b" class="gauge-seg" style="background:var(--destroy); width:0%"></div></div>
            </div>
            <div class="wealth-box" id="gold-display">0 ğŸŸ¡</div>
            <div class="btn-stack">
                <button id="btn-evolve" class="btn-evolve" onclick="evolve()"><span>ê°•í™”</span><small id="evolve-cost">-</small></button>
                <button id="btn-buy" class="btn-buy" onclick="fetchNew()">ğŸ“¦ ì†Œí™˜ (1k)</button>
                <button id="btn-sell" class="btn-sell" onclick="sellItem()">ğŸ’° íŒë§¤</button>
                <button id="btn-gene" class="btn-gene" onclick="mutateGene()">ğŸ§¬ ë³€ì´ (500k)</button>
                
                <button class="btn-nav" onclick="openInventory()">ğŸ’ ì¸ë²¤í† ë¦¬</button>
                
                <button class="btn-nav my-rank-btn" id="btn-my-rank" onclick="openMyHistory()">
                    <span>ğŸ“œ ë‚˜ì˜ ì „ë‹¹</span>
                    <span id="my-rank-icon" style="font-size:1.2rem; margin-top:2px;"></span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="world-rank-btn" onclick="openGlobalRanking()">
        <div class="world-rank-left">
            <div class="world-rank-label">ğŸ† GLOBAL NO.1</div>
            <div id="world-best-info" class="world-rank-val">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </div>
        <div id="world-best-icon" class="world-rank-icon">ğŸ‘‘</div>
    </div>

    <div style="display:flex; justify-content:space-between; padding:0 10px;">
        <button onclick="openBook()" style="background:none; color:#555; font-size:0.65rem;">ğŸ“• ë„ê°/í™•ë¥  (100ì¢…)</button>
        <button onclick="resetGame()" style="background:none; color:#222; font-size:0.65rem;">ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
</div>

<div id="inv-page" class="full-page">
    <h2 style="color:#fff; text-align:center; margin-bottom:10px;">ğŸ’ ê°œì¸ ì¸ë²¤í† ë¦¬</h2>
    <div class="inv-status-bar" onclick="swapWithMain()" title="í´ë¦­ ì‹œ ì„ íƒí•œ ì•„ì´í…œê³¼ êµì²´">
        <div class="inv-current-info">
            <div id="inv-current-emoji" class="inv-current-icon">ğŸ”’</div>
            <div style="display:flex; flex-direction:column; justify-content:center;">
                <span style="font-size:0.6rem; color:#aaa;">í˜„ì¬ ì¥ì°© ì¤‘ (í´ë¦­ êµì²´)</span>
                <span id="inv-current-name" style="font-weight:bold; font-size:0.9rem; color:#fff;">ì—†ìŒ</span>
            </div>
        </div>
        <div id="inv-total-gold" style="font-size:1.2rem; font-weight:bold; color:#ffd700;">0 ğŸŸ¡</div>
    </div>
    <div class="inv-hint">ğŸ’¡ íŒ: ì•„ì´í…œ ì„ íƒ í›„ 'ì¬í´ë¦­'í•˜ê±°ë‚˜ ìœ„ 'ì¥ì°© ì¤‘' ë°”ë¥¼ ëˆ„ë¥´ë©´ êµì²´ë©ë‹ˆë‹¤.</div>
    <div id="inv-grid-list" class="inv-grid"></div>
    <button style="width:100%; padding:15px; background:#333; color:white; border-radius:10px; margin-top:15px;" onclick="closePage('inv-page')">ì°½ ë‹«ê¸°</button>
</div>

<div id="book-page" class="full-page">
    <h2 style="color:#ffd700; text-align:center;">ğŸ“• ì‹œìŠ¤í…œ ë„ê°</h2>
    <div style="font-size:0.8rem; color:#888; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">ğŸ“Š ë“±ê¸‰ë³„ ì¶œí˜„ í™•ë¥ </div>
    <div id="rate-table-container"></div>
    <div style="font-size:0.8rem; color:#888; border-bottom:1px solid #333; padding-bottom:5px; margin:20px 0 10px;">ğŸ§¬ ì§„í™” íŠ¸ë¦¬ (100 Collection)</div>
    <div id="book-list" class="book-grid"></div>
    <br><button style="width:100%; padding:15px; background:#333; color:white; border-radius:10px;" onclick="closePage('book-page')">ë‹«ê¸°</button>
</div>

<div id="rank-page" class="full-page"><h2 id="rank-title" style="color:#ffd700; text-align:center;">ì „ë‹¹</h2><div id="rank-list"></div><button style="width:100%; padding:15px; background:#333; color:white; border-radius:10px;" onclick="closePage('rank-page')">ë‹«ê¸°</button></div>

<div id="exit-modal" class="full-page" style="z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.85);">
    <div class="login-box" style="border-color:#e74c3c; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <h2 style="color:#e74c3c; margin-top:0; font-size:1.5rem;">âš ï¸ WARNING</h2>
        <p style="color:#ddd; margin:20px 0; line-height:1.6; font-size:0.9rem;">
            ì •ë§ë¡œ ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            <span style="color:#4cd137; font-size:0.8rem; font-weight:bold;">
                (í˜„ì¬ ë‚´ìš©ì€ ì„œë²„ì— ìë™ ì €ì¥ë˜ë©°,<br>ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ë©´ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤)
            </span>
        </p>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="login-btn" onclick="realExit()" style="background:#e74c3c; color:white; width:50%;">ì¢…ë£Œ</button>
            <button class="login-btn" onclick="cancelExit()" style="background:#444; color:white; width:50%;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // â­ Firebase Config (API Key)
    const firebaseConfig = {
        apiKey: "AIzaSyA-QVwu7jpUUeLH3jtqYHChfwOW3FHY3pc", 
        authDomain: "gkyoungee.firebaseapp.com",
        projectId: "gkyoungee",
        storageBucket: "gkyoungee.firebasestorage.app",
        messagingSenderId: "903817816298",
        appId: "1:903817816298:web:a607dd06d9729bc7a60f93"
    };

    let app, db;
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e) { console.log("Firebase Init Fail"); }

    const gradeInfo = { "ì¼ë°˜": { color: "#b2bec3", mod: 1.0, rank: 0, prob: 45.0, weight: 1.0 }, "ë§¤ì§": { color: "#00cec9", mod: 0.85, rank: 1, prob: 25.0, weight: 2.0 }, "ë ˆì–´": { color: "#a29bfe", mod: 0.7, rank: 2, prob: 15.0, weight: 3.0 }, "ì—í”½": { color: "#fab1a0", mod: 0.5, rank: 3, prob: 10.0, weight: 4.0 }, "ë ˆì „ë”ë¦¬": { color: "#ff7675", mod: 0.3, rank: 4, prob: 5.0, weight: 15.0 } };
    
    // 100ì¢… ì§„í™” íŠ¸ë¦¬
    const evoPaths = [
        { name: "ë³´ì„", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ“¿", "ğŸ’", "ğŸ‘‘", "âœ¨"] }, { name: "ê¸°ìƒ", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["â˜€ï¸", "ğŸŒ¤ï¸", "ğŸŒ¦ï¸", "ğŸŒˆ"] }, { name: "ë„ì‹œ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ§±", "ğŸ ", "ğŸ¢", "ğŸ™ï¸"] }, { name: "ì˜ë¥˜", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ§¶", "ğŸ‘•", "ğŸ‘”", "ğŸ•´ï¸"] }, { name: "ì‹¬í•´", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸš", "ğŸ¦€", "ğŸ™", "ğŸ¦ˆ"] },
        { name: "ì‚¬ë¬´", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ“", "ğŸ“‚", "ğŸ–¥ï¸", "ğŸ¢"] }, { name: "ì‹ì‚¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¥£", "ğŸ¥—", "ğŸ", "ğŸ—"] }, { name: "ë¯¸ë˜", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ”‹", "âš¡", "ğŸ¤–", "ğŸ›¸"] }, { name: "ì—°ê¸ˆìˆ ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ§ª", "âš—ï¸", "ğŸ”®", "ğŸ§™"] }, { name: "ìœ ì ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["â›ï¸", "ğŸ”¦", "ğŸ¦´", "ğŸº"] },
        { name: "ë†ì‚¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ‘", "ğŸ„", "ğŸšœ", "ğŸŒ¾"] }, { name: "ì‹œê°„", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ•°ï¸", "â°", "âŒ›", "â³"] }, { name: "ì¡°ë¥˜", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¥š", "ğŸ£", "ğŸ“", "ğŸ¦…"] }, { name: "ìœ ë‹ˆì½˜", grades: ["ë§¤ì§", "ë ˆì–´", "ì—í”½"], stages: ["ğŸ¥š", "ğŸ", "ğŸ¦„", "ğŸ "] }, { name: "ë“œë˜ê³¤", grades: ["ì¼ë°˜", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ¥š", "ğŸ¦", "ğŸŠ", "ğŸ²"] },
        { name: "ì‹ë¬¼", grades: ["ì¼ë°˜", "ë§¤ì§", "ë ˆì–´"], stages: ["ğŸŒ±", "ğŸŒ·", "ğŸŒ³", "ğŸ„"] }, { name: "ìš”ë¦¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ", "ğŸ¥ª", "ğŸ”", "ğŸ±"] }, { name: "ë°”ë‹¤", grades: ["ë§¤ì§", "ë ˆì–´", "ì—í”½"], stages: ["ğŸ’§", "ğŸŒŠ", "ğŸ³", "ğŸ‹"] }, { name: "ì²œì²´", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸŒ‘", "ğŸŒ™", "â˜€ï¸", "ğŸŒŒ"] }, { name: "ì¥ë¹„", grades: ["ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["â›ï¸", "âš”ï¸", "ğŸ›¡ï¸", "ğŸ‘‘"] },
        { name: "ê³¤ì¶©", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ›", "ğŸ", "ğŸ¦‹", "ğŸ§š"] }, { name: "ì§€ì‹", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ“œ", "ğŸ“–", "ğŸ“", "ğŸ‘ï¸"] }, { name: "ë‚ ì”¨", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["â˜ï¸", "â›ˆï¸", "ğŸŒªï¸", "ğŸŒˆ"] }, { name: "ê²¨ìš¸", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["â„ï¸", "â˜ƒï¸", "â›·ï¸", "ğŸ”ï¸"] }, { name: "ê¸°ìˆ ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ“Ÿ", "ğŸ“±", "ğŸ’»", "ğŸ›°ï¸"] },
        { name: "ì¬í™”", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸª™", "ğŸ’µ", "ğŸ’°", "ğŸ’"] }, { name: "ë§ˆë²•", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸª„", "ğŸ©", "ğŸ”®", "ğŸ§™"] }, { name: "ìš´ì†¡", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸš²", "ğŸš—", "ğŸš", "ğŸš€"] }, { name: "ë””ì €íŠ¸", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¦", "ğŸ©", "ğŸ°", "ğŸ‚"] }, { name: "ì‹ í™”", grades: ["ì¼ë°˜", "ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ—¿", "ğŸº", "ğŸ›ï¸", "ğŸ”±"] },
        { name: "ì‚¬ë‘", grades: ["ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["â¤ï¸", "ğŸ’–", "ğŸ’˜", "ğŸ’"] }, { name: "í• ë¡œìœˆ", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸƒ", "ğŸ‘»", "ğŸ§›", "ğŸ°"] }, { name: "ì •ê¸€", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ’", "ğŸ¦", "ğŸ¦", "ğŸ˜"] }, { name: "ìŒì•…", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸµ", "ğŸ¸", "ğŸ¹", "ğŸ·"] }, { name: "ê³¼ì¼", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ‡", "ğŸ“", "ğŸ‘", "ğŸ"] },
        { name: "ìŠ¤í¬ì¸ ", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["âš½", "ğŸ€", "ğŸˆ", "ğŸ†"] }, { name: "í­ë°œ", grades: ["ë ˆì–´", "ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ§¨", "ğŸ’¥", "ğŸ”¥", "ğŸŒ‹"] }, { name: "ì„œë¶€", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸŒµ", "ğŸ¤ ", "ğŸ", "ğŸœï¸"] }, { name: "ì•„ì‹œì•„", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ‹", "ğŸ®", "â›©ï¸", "ğŸ‰"] }, { name: "ì˜ˆìˆ ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ¨", "ğŸ–Œï¸", "ğŸ–¼ï¸", "ğŸ›ï¸"] },
        { name: "í†µì‹ ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["âœ‰ï¸", "ğŸ“", "ğŸ“±", "ğŸ›°ï¸"] }, { name: "ì²­ì†Œ", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ§¹", "ğŸ§¼", "ğŸ§½", "ğŸš¿"] }, { name: "ê°€êµ¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ›‹ï¸", "ğŸ›ï¸", "ğŸª‘", "ğŸ "] }, { name: "ë„êµ¬", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ”¨", "ğŸªš", "ğŸ§°", "ğŸ—ï¸"] }, { name: "ì˜ë£Œ", grades: ["ë ˆì–´", "ì—í”½"], stages: ["ğŸ’Š", "ğŸ©º", "ğŸš‘", "ğŸ¥"] },
        { name: "ë² ì´í‚¹", grades: ["ì¼ë°˜", "ë§¤ì§"], stages: ["ğŸ¥¨", "ğŸ¥¯", "ğŸ¥", "ğŸ¥§"] }, { name: "ìŒë£Œ", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["â˜•", "ğŸ¥¤", "ğŸº", "ğŸ·"] }, { name: "ìº í•‘", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["â›º", "ğŸ•ï¸", "ğŸ›¶", "â›°ï¸"] }, { name: "ê³µí¬", grades: ["ì—í”½", "ë ˆì „ë”ë¦¬"], stages: ["ğŸ•¯ï¸", "ğŸ•¸ï¸", "ğŸ§Ÿ", "ğŸ’€"] }, { name: "ì¥ë‚œê°", grades: ["ë§¤ì§", "ë ˆì–´"], stages: ["ğŸ§¸", "ğŸª", "ğŸ®", "ğŸ‘¾"] },
        { name: "ì „ì‚¬", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ—¡ï¸","âš”ï¸","ğŸ›¡ï¸","ğŸ¤´"] }, { name: "ê¶ìˆ˜", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¯","ğŸ¹","ğŸ¦…","ğŸ§š"] }, { name: "ì„±ì§ì", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ•¯ï¸","ğŸ“–","â›ª","ğŸ‘¼"] }, { name: "ë„ì ", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ’°","ğŸ—ï¸","ğŸ­","ğŸ¥·"] }, { name: "ìŠ¬ë¼ì„", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ’§","ğŸ","ğŸ¦ ","ğŸŸ¢"] },
        { name: "ë§ˆì™•", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ¦‡","ğŸ•¸ï¸","ğŸ˜ˆ","ğŸ‘¿"] }, { name: "ê³¨ë ˜", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸª¨","ğŸ§±","ğŸ—¿","ğŸ¤–"] }, { name: "ì •ë ¹", grades: ["ë ˆì–´","ì—í”½"], stages: ["âœ¨","ğŸƒ","ğŸŒ¬ï¸","ğŸ§šâ€â™€ï¸"] }, { name: "ë„¤í¬ë¡œ", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ¦´","ğŸ’€","âš°ï¸","ğŸ§Ÿ"] }, { name: "ì‹ ì„±", grades: ["ë ˆì „ë”ë¦¬"], stages: ["ğŸ¥š","ğŸ•Šï¸","â˜ï¸","ğŸŒ"] },
        { name: "ê³ ì–‘ì´", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ§¶","ğŸ¾","ğŸˆ","ğŸ…"] }, { name: "ê°•ì•„ì§€", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¦´","ğŸ•","ğŸ©","ğŸº"] }, { name: "ê³°", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¯","ğŸ»","ğŸ¼","ğŸ»â€â„ï¸"] }, { name: "ì„¤ì¹˜ë¥˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ§€","ğŸ","ğŸ¹","ğŸ¿ï¸"] }, { name: "íŒŒì¶©ë¥˜", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¥š","ğŸ","ğŸ¢","ğŸ¦–"] },
        { name: "ì–‘ì„œë¥˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ’§","ğŸ¸","ğŸŠ","ğŸ‰"] }, { name: "ë§", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¥•","ğŸ¦“","ğŸ","ğŸ "] }, { name: "ì›ìˆ­ì´", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸŒ","ğŸ’","ğŸ¦","ğŸ¦§"] }, { name: "ë¼ì§€", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¥”","ğŸ–","ğŸ—","ğŸ¥“"] }, { name: "ì‚¬ìŠ´", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸŒ¿","ğŸ¦Œ","ğŸ„","ğŸ…"] },
        { name: "ì¼ì‹", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸš","ğŸ™","ğŸ£","ğŸ¤"] }, { name: "ë©´ìš”ë¦¬", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸŒ¾","ğŸœ","ğŸ","ğŸ¥"] }, { name: "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¥”","ğŸŸ","ğŸŒ­","ğŸ”"] }, { name: "ì¹´í˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ«˜","â˜•","ğŸ¥›","ğŸ¥"] }, { name: "ìˆ ", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ‡","ğŸ·","ğŸº","ğŸ¥‚"] },
        { name: "ì´ˆì½œë¦¿", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ«","ğŸª","ğŸ©","ğŸ‚"] }, { name: "ì—´ëŒ€ê³¼ì¼", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ’","ğŸ","ğŸ¥­","ğŸ¥¥"] }, { name: "ì±„ì†Œ", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¥¦","ğŸ¥’","ğŸŒ½","ğŸ¥—"] }, { name: "í•´ì‚°ë¬¼", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ£","ğŸŸ","ğŸ¦","ğŸ±"] }, { name: "ê°„ì‹", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ¬","ğŸ­","ğŸ¿","ğŸ¦"] },
        { name: "ìŒì•…ê°€", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¼","ğŸ§","ğŸ¤","ğŸ¹"] }, { name: "í™”ê°€", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["âœï¸","ğŸ–Œï¸","ğŸ¨","ğŸ–¼ï¸"] }, { name: "ê³¼í•™ì", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ’¡","ğŸ”¬","ğŸ”­","ğŸ§¬"] }, { name: "ìš´ë™ì„ ìˆ˜", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ‘Ÿ","âš½","ğŸ€","ğŸ†"] }, { name: "ì˜í™”", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ¬","ğŸŸï¸","ğŸ¥","ğŸï¸"] },
        { name: "êµ°ì¸", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸª–","ğŸ”«","ğŸ’£","ğŸ–ï¸"] }, { name: "ì˜ì‚¬", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ˜·","ğŸ©º","ğŸ’‰","ğŸ¥"] }, { name: "ê°œë°œì", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ‘“","ğŸ’»","ğŸ’¾","ğŸ–¥ï¸"] }, { name: "ë¶€ì", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸª™","ğŸ’µ","ğŸ’³","ğŸ’"] }, { name: "ê±´ì„¤", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["ğŸ”¨","ğŸªš","ğŸ—ï¸","ğŸ°"] },
        { name: "ì‹œê³„", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["â³","ğŸ•°ï¸","âŒš","ğŸ—“ï¸"] }, { name: "ë¹„", grades: ["ì¼ë°˜","ë§¤ì§"], stages: ["â˜‚ï¸","â˜”","â˜ƒï¸","ğŸŒˆ"] }, { name: "í–‰ìš´", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ€","ğŸ²","ğŸ°","ğŸ±"] }, { name: "í¸ì§€", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ’Œ","ğŸ€","ğŸ’","â¤ï¸"] }, { name: "ì—¬í–‰", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ—ºï¸","ğŸ§­","ğŸ§³","âœˆï¸"] },
        { name: "í•­í•´", grades: ["ë ˆì–´","ì—í”½"], stages: ["âš“","â›µ","ğŸš¢","ğŸï¸"] }, { name: "ìš°ì£¼2", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ›°ï¸","ğŸš€","ğŸ›¸","ğŸ‘½"] }, { name: "ë¶ˆê½ƒ", grades: ["ë§¤ì§","ë ˆì–´"], stages: ["ğŸ”¥","ğŸ•¯ï¸","ğŸ§¨","ğŸ‡"] }, { name: "ì „ê¸°", grades: ["ë ˆì–´","ì—í”½"], stages: ["ğŸ”Œ","ğŸ”‹","âš¡","ğŸ’¡"] }, { name: "í‰ê¸°", grades: ["ì—í”½","ë ˆì „ë”ë¦¬"], stages: ["ğŸ”ª","ğŸ©¸","âš°ï¸","ğŸ‘»"] }
    ];

    // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
    window.gold = 10000; window.nickname = ""; window.currentEmoji = null; 
    window.myHistory = []; window.selectedInvIdx = null;
    window.inventory = Array(25).fill(null).map((_, i) => ({ unlocked: i < 3, item: null }));

    // ìœ í‹¸ í•¨ìˆ˜
    window.addLog = (msg) => { const lb = document.getElementById('game-log'); const d = document.createElement('div'); d.innerText = `> ${msg}`; lb.appendChild(d); lb.scrollTop = lb.scrollHeight; };
    window.vibrate = () => { if(navigator.vibrate) navigator.vibrate(10); };
    
    // ëª¨ë‹¬ ìƒíƒœ ì²´í¬ í•¨ìˆ˜
    function isGameModalOpen() {
        return Array.from(document.querySelectorAll('.full-page')).some(el => 
            el.id !== 'exit-modal' && el.style.display === 'block'
        );
    }
    
    // â­ ì¢…ë£Œ ë° ë’¤ë¡œê°€ê¸° ë¡œì§ (ìˆ˜ì •ë¨: ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™)
    window.realExit = () => {
        // ì¢…ë£Œ = ë¡œê·¸ì•„ì›ƒìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°
        localStorage.removeItem('lastUser'); 
        location.reload(); 
    };

    window.cancelExit = () => {
        // ë‹¨ìˆœíˆ íŒì—…ë§Œ ìˆ¨ê¹€ (StateëŠ” ìœ ì§€í•˜ì—¬ ì•ˆì „ì¥ì¹˜ ì—­í•  ì§€ì†)
        document.getElementById('exit-modal').style.display = 'none';
    };

    // history ì²˜ë¦¬ í•µì‹¬ ë¡œì§
    window.addEventListener('popstate', () => {
        const exitModal = document.getElementById('exit-modal');

        // 1. ì¢…ë£Œ íŒì—…ì´ ë– ìˆëŠ” ìƒíƒœì—ì„œ ë’¤ë¡œê°€ê¸° ëˆ„ë¦„ (ì·¨ì†Œ ì˜ë„)
        if (exitModal.style.display === 'flex') {
            exitModal.style.display = 'none';
            // â— í•µì‹¬: ë°©ê¸ˆ ì†Œë¹„í•œ ì•ˆì „ì¥ì¹˜ë¥¼ ë‹¤ì‹œ ì±„ì›Œë„£ìŒ (ë¬´í•œ ë°©ì–´)
            history.pushState({ main: true }, '', '');
            return;
        }

        // 2. ê²Œì„ ë‚´ ëª¨ë‹¬(ì¸ë²¤í† ë¦¬ ë“±) ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        if (isGameModalOpen()) {
            document.querySelectorAll('.full-page').forEach(el => {
                if(el.id !== 'exit-modal') el.style.display = 'none';
            });
            window.selectedInvIdx = null;
            if(window.renderInventory) window.renderInventory();
            return;
        }

        // 3. ë©”ì¸ í™”ë©´ì´ë©´ ì¢…ë£Œ íŒì—… ë„ìš°ê¸°
        // â— í•µì‹¬: íŒì—…ì„ ë„ìš°ëŠ” ìˆœê°„ ë‹¤ì‹œ stateë¥¼ pushí•˜ì—¬ "ëª» ë‚˜ê°€ê²Œ ê°€ë‘ "
        history.pushState({ main: true }, '', ''); 
        exitModal.style.display = 'flex';
    });
    
    // ëª¨ë‹¬ ë‹«ê¸° ê³µí†µ í•¨ìˆ˜ (í™”ë©´ ë‚´ Xë²„íŠ¼ ë“±)
    window.closePage = (id) => { 
        if (history.state && history.state.modal) {
            history.back();
        } else {
            document.getElementById(id).style.display = 'none'; 
            window.selectedInvIdx = null; 
            renderInventory(); 
        }
    };
    
    // UI ì—…ë°ì´íŠ¸
    window.updateUI = function() {
        document.getElementById('gold-display').innerText = window.gold.toLocaleString() + " ğŸŸ¡";
        document.getElementById('my-id-label').innerText = `ID: ${window.nickname || "GUEST"}`;
        
        // ì¸ë²¤í† ë¦¬ ìƒíƒœë°” ì—…ë°ì´íŠ¸
        document.getElementById('inv-total-gold').innerText = window.gold.toLocaleString() + " ğŸŸ¡";
        if(window.currentEmoji && !window.currentEmoji.gone) {
             const info = gradeInfo[window.currentEmoji.grade];
             document.getElementById('inv-current-emoji').innerText = window.currentEmoji.stages[Math.min(3, Math.floor(window.currentEmoji.level / 5))];
             document.getElementById('inv-current-name').innerHTML = `<span style="color:${info.color}">${window.currentEmoji.grade}</span> +${window.currentEmoji.level}`;
        } else {
             document.getElementById('inv-current-emoji').innerText = "ğŸ”’";
             document.getElementById('inv-current-name').innerText = "ì—†ìŒ";
        }
        
        // ë‚´ ë­í‚¹ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        if(window.myHistory.length > 0) {
             const best = window.myHistory[0];
             document.getElementById('my-rank-icon').innerText = best.emoji;
        } else {
             document.getElementById('my-rank-icon').innerText = "";
        }

        const evoBtn = document.getElementById('btn-evolve'), buyBtn = document.getElementById('btn-buy'), sellBtn = document.getElementById('btn-sell'), geneBtn = document.getElementById('btn-gene');

        if (window.currentEmoji) {
            const info = gradeInfo[window.currentEmoji.grade], lvl = window.currentEmoji.level;
            let b = (lvl < 5) ? 0 : Math.min(20, (lvl - 4) * 2), m = Math.min(50, lvl * (7 / info.mod)), s = Math.max(10, 100 - b - m); 
            window.currentEmoji.value = Math.floor(1000 * info.weight * 10 * Math.pow(1.6, lvl) * (window.currentEmoji.mutated ? 1.5 : 1.0));
            let cost = Math.floor(2000 * Math.pow(1.8, lvl));

            document.getElementById('overlay-grade').innerText = window.currentEmoji.grade; document.getElementById('overlay-grade').style.color = info.color;
            document.getElementById('overlay-name-level').innerText = `+${lvl}`; 
            document.getElementById('overlay-grade').className = document.getElementById('overlay-name-level').className = (window.currentEmoji.grade === "ë ˆì „ë”ë¦¬") ? "glow-legendary" : "";
            
            const mainEmoji = document.getElementById('main-emoji'), dL = document.getElementById('deco-l'), dR = document.getElementById('deco-r');
            mainEmoji.innerText = window.currentEmoji.stages[Math.min(3, Math.floor(lvl / 5))];
            
            if (window.currentEmoji.gone) {
                dL.innerText = dR.innerText = "ğŸ’€"; evoBtn.disabled = sellBtn.disabled = geneBtn.disabled = true; buyBtn.disabled = false;
                document.getElementById('evolve-cost').innerText = "-";
            } else {
                if (lvl >= 15) dL.innerText = dR.innerText = "ğŸ†"; else if (lvl >= 10) dL.innerText = dR.innerText = "ğŸ”¥"; else dL.innerText = dR.innerText = "";
                buyBtn.disabled = true; sellBtn.disabled = false; evoBtn.disabled = window.gold < cost;
                document.getElementById('evolve-cost').innerText = `${cost.toLocaleString()}ğŸŸ¡`;
                geneBtn.disabled = !(window.currentEmoji.gene && !window.currentEmoji.mutated && lvl >= 5 && window.gold >= 500000);
            }
            document.getElementById('st-value').innerText = window.currentEmoji.value.toLocaleString(); document.getElementById('st-grade').innerText = window.currentEmoji.grade;
            document.getElementById('st-gene').innerText = window.currentEmoji.mutated ? "ë°œí˜„" : (window.currentEmoji.gene ? "ë³´ìœ " : "ì—†ìŒ"); document.getElementById('st-rarity').innerText = window.currentEmoji.rarity + "%";
            document.getElementById('seg-s').style.width = s + "%"; document.getElementById('seg-m').style.width = m + "%"; document.getElementById('seg-b').style.width = b + "%";
            document.getElementById('val-s').innerText = Math.floor(s) + "%"; document.getElementById('val-b').innerText = Math.floor(b) + "%";
        } else {
            document.getElementById('overlay-name-level').innerText = "ì†Œí™˜ ëŒ€ê¸° ì¤‘"; document.getElementById('main-emoji').innerText = "â“";
            document.getElementById('overlay-grade').innerText = "-"; document.getElementById('deco-l').innerText = document.getElementById('deco-r').innerText = "";
            document.getElementById('evolve-cost').innerText = "-"; buyBtn.disabled = false; evoBtn.disabled = sellBtn.disabled = geneBtn.disabled = true;
            document.querySelectorAll('.gauge-seg').forEach(el => el.style.width = "0%"); ["st-value", "st-grade", "st-rarity"].forEach(id => document.getElementById(id).innerText = "-");
        }
        syncGlobal();
    };

    // --- ê²Œì„ ë¡œì§ ---
    window.fetchNew = () => { if (window.gold < 1000) return; window.gold -= 1000; let r = Math.random() * 100; let g = (r < 5.0) ? "ë ˆì „ë”ë¦¬" : (r < 15.0) ? "ì—í”½" : (r < 30.0) ? "ë ˆì–´" : (r < 55.0) ? "ë§¤ì§" : "ì¼ë°˜"; const paths = evoPaths.filter(p => p.grades.includes(g)); const p = paths[Math.floor(Math.random() * paths.length)]; window.currentEmoji = { pathName: p.name, stages: p.stages, grade: g, level: 0, gene: Math.random() < 0.35, mutated: false, survival: 100, gone: false, rarity: gradeInfo[g].prob.toFixed(8) }; addLog(`âœ¨ [${g}] ì†Œí™˜ ì™„ë£Œ!`); updateUI(); saveGame(); };

    window.evolve = () => {
        let cost = Math.floor(2000 * Math.pow(1.8, window.currentEmoji.level)); if (window.gold < cost) return; window.gold -= cost;
        let lvl = window.currentEmoji.level, info = gradeInfo[window.currentEmoji.grade];
        let b = (lvl < 5) ? 0 : Math.min(20, (lvl - 4) * 2), m = Math.min(50, lvl * (7 / info.mod)), s = Math.max(10, 100 - b - m); 
        if (Math.random() * 100 < s + m) {
            if (Math.random() * 100 < s / (s+m) * 100) { window.currentEmoji.level++; window.currentEmoji.rarity = (parseFloat(window.currentEmoji.rarity) * (s/100)).toFixed(8); addLog(`âœ¨ ê°•í™” ì„±ê³µ! +${window.currentEmoji.level}`); }
            else { addLog("ğŸ’¨ ìƒíƒœ ìœ ì§€"); }
        } else { addLog(`ğŸ˜­ ê°•í™” ì‹¤íŒ¨ (ë°ë“œ)`); window.currentEmoji.gone = true; } updateUI(); saveGame();
    };

    window.mutateGene = () => {
        if (!window.currentEmoji || window.gold < 500000) return; window.gold -= 500000;
        let gs = Object.keys(gradeInfo), i = gs.indexOf(window.currentEmoji.grade);
        if (i < gs.length - 1 && Math.random() < 0.6) { window.currentEmoji.grade = gs[i+1]; window.currentEmoji.mutated = true; window.currentEmoji.rarity = (parseFloat(window.currentEmoji.rarity) * 0.1).toFixed(8); addLog(`ğŸ”® ë³€ì´ ì„±ê³µ! [${window.currentEmoji.grade}]`); }
        else { window.currentEmoji.gene = false; addLog(`ğŸ”® ë³€ì´ ì‹¤íŒ¨!`); } updateUI(); saveGame();
    };

    window.sellItem = async function() { 
        if (!window.currentEmoji || window.currentEmoji.gone) return;
        let rec = { owner: window.nickname, emoji: window.currentEmoji.stages[Math.min(3, Math.floor(window.currentEmoji.level / 5))], prob: parseFloat(window.currentEmoji.rarity), val: window.currentEmoji.value, grade: window.currentEmoji.grade, lvl: window.currentEmoji.level, date: Date.now() };
        window.myHistory.push(rec); window.myHistory.sort((a, b) => a.prob - b.prob); window.myHistory = window.myHistory.slice(0, 20);
        window.gold += rec.val; addLog(`ğŸ’° íŒë§¤: +${rec.val.toLocaleString()}`); window.currentEmoji = null; updateUI(); await saveGame();
    };

    // --- ì¸ë²¤í† ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
    window.openInventory = () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', ''); 
        const page = document.getElementById('inv-page');
        page.style.display = 'block'; page.scrollTop = 0;
        updateUI(); renderInventory(); 
    };

    function renderInventory() {
        const grid = document.getElementById('inv-grid-list'); grid.innerHTML = "";
        window.inventory.forEach((slot, i) => {
            const div = document.createElement('div'); div.className = `inv-slot ${slot.unlocked ? '' : 'locked'} ${window.selectedInvIdx === i ? 'selected' : ''}`;
            if (!slot.unlocked) div.innerHTML = "ğŸ”’<br>50ë§Œ";
            else if (slot.item) { div.style.borderColor = gradeInfo[slot.item.grade].color; div.innerHTML = `<span class="inv-emoji">${slot.item.stages[Math.min(3, Math.floor(slot.item.level / 5))]}</span><div class="inv-tag">+${slot.item.level}</div>`; }
            div.onclick = () => handleSlotClick(i); grid.appendChild(div);
        });
    }

    window.swapWithMain = () => {
        if (window.selectedInvIdx === null) return;
        if (window.currentEmoji && window.currentEmoji.gone) { addLog("ğŸ’€ íŒŒê´´ëœ ì´ëª¨ì§€ëŠ” ì¸ë²¤í† ë¦¬ì— ë„£ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        const slot = window.inventory[window.selectedInvIdx];
        if (!slot || !slot.unlocked) return;

        const temp = window.currentEmoji;
        window.currentEmoji = slot.item;
        slot.item = temp; 
        
        const newItemName = window.currentEmoji ? window.currentEmoji.stages[0] : "ì—†ìŒ";
        const oldItemName = slot.item ? slot.item.stages[0] : "ë¹ˆì¹¸";
        addLog(`ğŸ”„ [${newItemName}] â†” [${oldItemName}] êµì²´/ì¥ì°© ì™„ë£Œ.`);
        
        window.vibrate();
        window.selectedInvIdx = null; 
        updateUI(); saveGame(); renderInventory();
    };

    async function handleSlotClick(idx) {
        let slot = window.inventory[idx];
        if (!slot.unlocked) { 
            if (window.gold >= 500000 && confirm("ìŠ¬ë¡¯ ì ê¸ˆ í•´ì œ?")) { window.gold -= 500000; slot.unlocked = true; saveGame(); renderInventory(); updateUI(); } 
            return; 
        }
        if (window.selectedInvIdx === null) {
            if (slot.item) { window.selectedInvIdx = idx; renderInventory(); } 
            else {
                if (window.currentEmoji && !window.currentEmoji.gone) { slot.item = window.currentEmoji; window.currentEmoji = null; addLog("ğŸ’ ì¸ë²¤í† ë¦¬ì— ë³´ê´€í•¨."); window.vibrate(); updateUI(); saveGame(); renderInventory(); } 
                else if(window.currentEmoji && window.currentEmoji.gone) { addLog("ğŸ’€ íŒŒê´´ëœ ì´ëª¨ì§€ëŠ” ë³´ê´€ ë¶ˆê°€."); }
            }
        } else {
            if (window.selectedInvIdx === idx) { window.swapWithMain(); } 
            else { let temp = window.inventory[window.selectedInvIdx].item; window.inventory[window.selectedInvIdx].item = slot.item; slot.item = temp; window.selectedInvIdx = null; renderInventory(); saveGame(); }
        }
    }

    document.getElementById('display-area').onclick = () => { if (window.selectedInvIdx !== null) { window.swapWithMain(); } };

    // --- ë„ê° ë° ë­í‚¹ ì—´ê¸° (History ì ìš©) ---
    window.openBook = () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', '');
        const page = document.getElementById('book-page');
        page.style.display = 'block'; page.scrollTop = 0;
        
        let tableHtml = `<table class="rate-table"><thead><tr><th>ë“±ê¸‰</th><th>ì¶œí˜„ í™•ë¥ </th><th>ìƒ‰ìƒ</th></tr></thead><tbody>`;
        const grades = ["ë ˆì „ë”ë¦¬", "ì—í”½", "ë ˆì–´", "ë§¤ì§", "ì¼ë°˜"];
        grades.forEach(g => { const info = gradeInfo[g]; tableHtml += `<tr><td style="color:${info.color}; font-weight:bold;">${g}</td><td>${info.prob}%</td><td><div style="width:12px; height:12px; background:${info.color}; margin:0 auto; border-radius:50%;"></div></td></tr>`; });
        tableHtml += `</tbody></table>`;
        document.getElementById('rate-table-container').innerHTML = tableHtml;
        document.getElementById('book-list').innerHTML = evoPaths.map(p => `<div class="book-item"><b>${p.name}</b><br><span>${p.stages.join('â†’')}</span></div>`).join(''); 
    };

    // --- ë­í‚¹ ë° ì €ì¥ ---
    async function syncGlobal() { 
        if(!db) return;
        try { 
            let snap = await getDocs(collection(db, "users")); let all = []; 
            snap.forEach(d => { if(d.data().h) all = all.concat(d.data().h); }); 
            const bests = all.filter(c => c && c.prob).sort((a, b) => a.prob - b.prob); 
            const worldBtnVal = document.getElementById('world-best-info');
            const worldBtnIcon = document.getElementById('world-best-icon');
            if (bests.length > 0) { let t = bests[0]; worldBtnVal.innerHTML = `<span style="color:#fff">${t.owner}</span> <span style="font-size:0.7rem; color:#aaa">(${t.grade})</span>`; worldBtnIcon.innerText = t.emoji; } else { worldBtnVal.innerText = "ê¸°ë¡ ì—†ìŒ"; worldBtnIcon.innerText = "ğŸ‘‘"; }
        } catch(e) {} 
    }

    function renderRanking(list) {
        return list.map((c, i) => {
            const rk = i + 1; const col = gradeInfo[c.grade]?.color; let glw = rk === 1 ? 'rank-glow-1' : '';
            return `<div class="rank-card-slim ${glw}"><div class="rank-block">#${rk}</div><div class="rank-block" style="font-size:1.6rem;">${c.emoji}</div><div class="rank-info-block"><div style="font-weight:900;">${c.owner}</div><div style="color:${col}; font-size:0.6rem;">${c.grade} +${c.lvl} | ${c.prob}%</div><div style="font-size:0.55rem; color:#ffd700;">${c.val.toLocaleString()} ğŸŸ¡</div></div></div>`;
        }).join('') || "<div style='text-align:center; padding:20px; color:#555;'>ê¸°ë¡ ì—†ìŒ</div>";
    }
    
    window.openMyHistory = () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', ''); 
        const page = document.getElementById('rank-page');
        page.style.display = 'block'; page.scrollTop = 0;
        document.getElementById('rank-title').innerText = "ğŸ“œ ë‚˜ì˜ ëª…ì˜ˆì˜ ì „ë‹¹"; document.getElementById('rank-list').innerHTML = renderRanking(window.myHistory); 
    };
    
    window.openGlobalRanking = async () => { 
        if(isGameModalOpen()) return;
        history.pushState({ modal: true }, '', '');
        const page = document.getElementById('rank-page');
        page.style.display = 'block'; page.scrollTop = 0;
        document.getElementById('rank-title').innerText = "ğŸŒ ê¸€ë¡œë²Œ ëª…ì˜ˆì˜ ì „ë‹¹"; document.getElementById('rank-list').innerHTML = "ë°ì´í„° ë¡œë”© ì¤‘..."; 
        if(!db) { document.getElementById('rank-list').innerText = "ì„œë²„ ì—°ê²° ì•ˆë¨"; return; }
        let snap = await getDocs(collection(db, "users")); let all = []; snap.forEach(d => { if(d.data().h) all = all.concat(d.data().h); }); let bsts = all.filter(c => c && c.prob).sort((a, b) => a.prob - b.prob).slice(0, 50); document.getElementById('rank-list').innerHTML = renderRanking(bsts); 
    };
    
    async function saveGame() { 
        if(window.nickname) localStorage.setItem('catSave_' + window.nickname, JSON.stringify({ g: window.gold, c: window.currentEmoji, h: window.myHistory, i: window.inventory })); 
        if(db && window.nickname) {
            try { await setDoc(doc(db, "users", window.nickname), { g: window.gold, c: window.currentEmoji, h: window.myHistory, i: window.inventory, pw: window.password }, { merge: true }); } catch(e) {} 
        }
    }

    window.handleAuth = async (mode) => {
        const idInput = document.getElementById('inp-nick');
        const pwInput = document.getElementById('inp-pw');
        const msg = document.getElementById('auth-msg');
        const id = idInput.value.trim();
        const pw = pwInput.value.trim();
        if(id.length < 2 || pw.length < 4) { msg.innerText = "IDëŠ” 2ì, ë¹„ë²ˆì€ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."; return; }
        const localKey = `catSave_${id}`; 

        if(mode === 'signup') {
            if(localStorage.getItem(localKey)) { msg.innerText = "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤ (ë¡œì»¬)."; return; }
            if(db) {
                try {
                    const snap = await getDoc(doc(db, "users", id));
                    if(snap.exists()) { msg.innerText = "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤ (ì„œë²„)."; return; }
                    await setDoc(doc(db, "users", id), { pw: pw, g: 10000, h: [], c: null, i: window.inventory });
                } catch(e) { console.log(e); }
            }
            loginSuccess(id, pw, { g: 10000, h: [], c: null, i: window.inventory });
        } else {
            let loadedData = null;
            if(db) {
                try {
                    const snap = await getDoc(doc(db, "users", id));
                    if(snap.exists() && snap.data().pw === pw) loadedData = snap.data();
                } catch(e) {}
            }
            if(!loadedData) { const local = localStorage.getItem(localKey); if(local) loadedData = JSON.parse(local); }

            if(loadedData) { loginSuccess(id, pw, loadedData); } else { msg.innerText = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” IDì´ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."; }
        }
    };

    function loginSuccess(nick, pw, data) {
        window.nickname = nick; window.password = pw; 
        window.gold = data.g || 10000; window.myHistory = data.h || []; window.currentEmoji = data.c || null; window.inventory = data.i || window.inventory;
        localStorage.setItem('lastUser', JSON.stringify({ nick: nick, pw: pw }));
        localStorage.setItem('catSave_' + nick, JSON.stringify(data));
        document.getElementById('nick-modal').style.display = 'none';
        addLog(`í™˜ì˜í•©ë‹ˆë‹¤, ë§ˆìŠ¤í„° ${nick}ë‹˜!`); updateUI();
    }

    window.logout = () => { localStorage.removeItem('lastUser'); location.reload(); };
    window.resetGame = () => {
        if(confirm("ì •ë§ë¡œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
            window.gold = 10000; window.currentEmoji = null; window.myHistory = []; 
            window.inventory = Array(25).fill(null).map((_, i) => ({ unlocked: i < 3, item: null }));
            saveGame(); updateUI(); addLog("ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    };

    async function init() {
        // ìƒˆë¡œê³ ì¹¨ ì‹œ ê¼¬ì¸ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” í›„ ë©”ì¸ ìƒíƒœ ì£¼ì… (ì•ˆì „ì¥ì¹˜ ì‹œì‘)
        history.replaceState(null, '', location.href);
        history.pushState({ main: true }, '', '');

        const last = localStorage.getItem('lastUser');
        if (last) {
            const user = JSON.parse(last);
            document.getElementById('inp-nick').value = user.nick;
            document.getElementById('inp-pw').value = user.pw;
        }
        updateUI();
    }
    init();
</script>
</body>
</html>

