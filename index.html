<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê³ ì–‘ì´ ì§„í™” ì‹œë®¬ë ˆì´í„° PRO - ê¸€ë¡œë²Œ ì—ë””ì…˜</title>
    <style>
        :root {
            --common: #b2bec3; --uncommon: #00cec9; --rare: #a29bfe; --legendary: #fab1a0; --mythic: #ff7675;
            --success-color: #2ecc71; --stay-color: #f1c40f; --destroy-color: #e74c3c;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: #0d0d0d; color: #eee; margin: 0; padding: 10px; overflow-x: hidden; }
        .game-container { width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
        
        .top-section { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 10px; }
        .left-column { display: flex; flex-direction: column; gap: 10px; }
        .cat-view { height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px solid #333; border-radius: 12px 12px 0 0; background: radial-gradient(circle, #222 0%, #000 100%); position: relative; transition: 0.3s; }
        .nyang-bar { background: #222; border: 2px solid #333; border-top: none; padding: 10px; text-align: center; border-radius: 0 0 12px 12px; color: #ffd700; font-weight: bold; font-size: 1.1rem; }
        .in-game-log { height: 140px; background: #0a0a0a; border: 2px solid #e74c3c; border-radius: 12px; padding: 10px; font-size: 0.75rem; overflow-y: auto; color: #aaa; line-height: 1.5; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-stack { display: flex; flex-direction: column; gap: 6px; }
        button { padding: 12px 5px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .btn-buy { background: #2ecc71; color: white; }
        .btn-adopt { background: #f1c40f; color: #333; }
        .btn-evolve { background: #6c5ce7; color: white; }
        .btn-gene { background: #444; color: #888; }
        .btn-gene.active { background: #d63031; color: white; animation: pulse 1.5s infinite; }
        button:disabled { opacity: 0.2; filter: grayscale(1); cursor: not-allowed; }

        /* ë­í‚¹ ìŠ¬ë¡¯ */
        .rank-slot { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .world-best-slot { border: 2px solid #ffd700 !important; background: linear-gradient(145deg, #1e272e, #000); box-shadow: 0 0 15px rgba(255,215,0,0.2); margin-top: 5px; }
        .full-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0d0d0d; z-index: 2000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .rank-item { background: #1a1a1a; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #333; }

        #nick-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: none; align-items: center; justify-content: center; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes success-glow { 0% { box-shadow: 0 0 5px #2ecc71; } 50% { box-shadow: 0 0 25px #2ecc71; } 100% { box-shadow: 0 0 5px #2ecc71; } }
        .anim-success { animation: success-glow 0.8s; border-color: #2ecc71 !important; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 20% { transform: translate(-3px, 0px) rotate(-1deg); } 40% { transform: translate(3px, 2px) rotate(1deg); } 100% { transform: translate(1px, -2px) rotate(0deg); } }
        .anim-shake { animation: shake 0.5s; }
    </style>
</head>
<body>

<div id="nick-modal">
    <div style="background:#1a1a1a; padding:30px; border-radius:15px; border:2px solid #e74c3c; text-align:center; width:80%; max-width:320px;">
        <h2 style="color:#ffd700; margin-top:0;">ì‹ ê·œ ì§‘ì‚¬ ë“±ë¡</h2>
        <input type="text" id="user-nickname" style="width:100%; padding:12px; background:#000; border:1px solid #444; color:white; border-radius:5px; text-align:center; margin:15px 0; box-sizing:border-box;" placeholder="ë³„ëª… ì…ë ¥ (2~8ì)" maxlength="8">
        <p id="nick-error" style="color:#e74c3c; font-size:0.75rem; margin-top:-10px; display:none;">ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.</p>
        <button onclick="checkNicknameAndStart()" style="width:100%; padding:12px; background:#e74c3c; color:white; border:none; border-radius:5px; font-weight:bold;">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
    </div>
</div>

<div class="game-container">
    <div class="top-section">
        <div class="left-column">
            <div class="cat-evolution-card">
                <div class="cat-view" id="cat-display-area">
                    <div id="grade-badge" style="position:absolute; top:12px; right:12px; font-size:0.7rem;">ëŒ€ê¸°</div>
                    <div id="cat-level" style="font-size:3.5rem; font-weight:900;">?</div>
                    <div id="cat-name" style="font-size: 0.9rem; margin-top: 5px; font-weight: bold;">ì…ì–‘ ëŒ€ê¸° ì¤‘</div>
                </div>
                <div class="nyang-bar" id="gold-display">0 ëƒ¥</div>
            </div>
            <div class="in-game-log" id="game-log"></div>
        </div>

        <div class="control-panel">
            <div class="btn-stack">
                <button id="btn-evolve" class="btn-evolve" onclick="evolve()">ì§„í™”</button>
                <button id="btn-buy" class="btn-buy" onclick="fetchNewCat()">ë°ë ¤ì˜¤ê¸° (1,000)</button>
                <button id="btn-adopt" class="btn-adopt" onclick="adoptOut()">ë¶„ì–‘ ë³´ë‚´ê¸°</button>
                <div class="rank-slot" onclick="openMyHistory()" style="margin-top:5px; padding:10px; font-size:0.8rem;">ğŸ“œ ë‚˜ì˜ ëª…ì˜ˆì˜ ì „ë‹¹</div>
                <button style="background:#333; color:#666; font-size:0.6rem; margin-top:5px;" onclick="resetGame()">ë°ì´í„° ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>
    
    <div class="rank-slot world-best-slot" onclick="openGlobalRanking()">
        <div style="font-size:0.6rem; color:#ffd700; margin-bottom:5px;">ğŸ† GLOBAL WORLD RANK #1</div>
        <div id="world-best-info" style="color:#555; font-size:0.8rem;">ì„œë²„ ë™ê¸°í™” ì¤‘...</div>
    </div>
</div>

<div id="my-history-page" class="full-page">
    <h2 style="color:#fff; text-align:center;">ğŸ“œ ë‚˜ì˜ ë¶„ì–‘ ê¸°ë¡</h2>
    <div id="my-history-list"></div>
    <button style="width:100%; padding:15px; margin-top:15px; background:#444; color:white; border:none; border-radius:8px;" onclick="closePage('my-history-page')">ëŒì•„ê°€ê¸°</button>
</div>

<div id="global-rank-page" class="full-page">
    <h2 style="color:#ffd700; text-align:center;">ğŸŒ ì „ ì„¸ê³„ ëª…ì˜ˆì˜ ì „ë‹¹ (Top 20)</h2>
    <div id="global-rank-list"></div>
    <button style="width:100%; padding:15px; margin-top:15px; background:#444; color:white; border:none; border-radius:8px;" onclick="closePage('global-rank-page')">ëŒì•„ê°€ê¸°</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // â­ íŒŒì´ì–´ë² ì´ìŠ¤ API ì„¤ì • $\star$
    const firebaseConfig = {
        apiKey: "AIzaSyA-QVwu7jpUUeLH3jtqYHChfwOW3FHY3pc",
  authDomain: "gkyoungee.firebaseapp.com",
  projectId: "gkyoungee",
  storageBucket: "gkyoungee.firebasestorage.app",
  messagingSenderId: "903817816298",
  appId: "1:903817816298:web:a607dd06d9729bc7a60f93"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myId = localStorage.getItem('catGameId') || 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('catGameId', myId);

    window.gold = 10000;
    window.nickname = localStorage.getItem('catNickname') || "";
    window.currentCat = null;
    window.myHistory = [];

    const gradeInfo = {
        "ê¸¸ê³ ì–‘ì´": { color: "#b2bec3", mod: 1.0, rank: 0, names: ["ì¹˜ì¦ˆëƒ¥", "ê³ ë“±ì–´ëƒ¥"], baseProb: 61.5 },
        "ì§‘ê³ ì–‘ì´": { color: "#00cec9", mod: 0.85, rank: 1, names: ["ìƒ´", "í˜ë¥´ì‹œì•ˆ"], baseProb: 25.0 },
        "í’ˆì¢…ë¬˜": { color: "#a29bfe", mod: 0.7, rank: 2, names: ["ë±…ê°ˆ", "ëŸ¬ì‹œì•ˆë¸”ë£¨"], baseProb: 10.0 },
        "ì˜ë¬¼": { color: "#fdcb6e", mod: 0.5, rank: 3, names: ["ë©”ì¸ì¿¤", "ë ‰ëŒ"], baseProb: 3.0 },
        "ì‹ ìˆ˜": { color: "#ff7675", mod: 0.3, rank: 4, names: ["ë² ë¥´ë§Œ", "ë…¸ë¥´ì›¨ì´ìˆ²"], baseProb: 0.5 }
    };

    // 1. ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ ë° ì‹œì‘
    window.checkNicknameAndStart = async function() {
        const input = document.getElementById('user-nickname').value.trim();
        const errorMsg = document.getElementById('nick-error');
        if (input.length < 2) return alert("ë‹‰ë„¤ì„ì„ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        // ì¤‘ë³µ ì²´í¬ ì¿¼ë¦¬ $\star$
        const q = query(collection(db, "users"), where("nickname", "==", input));
        const querySnapshot = await getDocs(q);
        
        let isDuplicate = false;
        querySnapshot.forEach((doc) => {
            if (doc.id !== myId) isDuplicate = true;
        });

        if (isDuplicate) {
            errorMsg.style.display = 'block';
            return;
        }

        window.nickname = input;
        localStorage.setItem('catNickname', input);
        document.getElementById('nick-modal').style.display = 'none';
        await saveGame();
        updateUI();
    };

    // 2. ì´ˆê¸°í™” (ìë™ ë¡œê·¸ì¸ í™•ì¸)
    async function initializeGame() {
        if (!window.nickname) {
            // ì„œë²„ì— ë‹‰ë„¤ì„ì´ ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ í•œ ë²ˆ ë” í™•ì¸
            const snap = await getDoc(doc(db, "users", myId));
            if (snap.exists() && snap.data().nickname) {
                window.nickname = snap.data().nickname;
                localStorage.setItem('catNickname', window.nickname);
            } else {
                document.getElementById('nick-modal').style.display = 'flex';
                return;
            }
        }
        
        const snap = await getDoc(doc(db, "users", myId));
        if (snap.exists()) {
            const d = snap.data();
            window.gold = d.gold || 10000;
            window.myHistory = d.catHistory || [];
            window.currentCat = d.currentCat;
        }
        updateUI();
    }

    window.updateUI = function() {
        document.getElementById('gold-display').innerText = window.gold.toLocaleString() + " ëƒ¥";
        const evolveBtn = document.getElementById('btn-evolve');
        const buyBtn = document.getElementById('btn-buy');
        const adoptBtn = document.getElementById('btn-adopt');

        if (window.currentCat) {
            const info = gradeInfo[window.currentCat.grade];
            document.getElementById('cat-level').innerText = "+" + window.currentCat.level;
            document.getElementById('cat-level').style.color = info.color;
            document.getElementById('cat-name').innerText = window.currentCat.name;
            document.getElementById('grade-badge').innerText = window.currentCat.grade;
            document.getElementById('grade-badge').style.color = info.color;
            
            const cost = Math.floor(2000 * Math.pow(1.8, window.currentCat.level));
            evolveBtn.innerText = `ì§„í™” (${cost.toLocaleString()})`;
            evolveBtn.disabled = window.gold < cost;
            buyBtn.disabled = true; adoptBtn.disabled = false;
        } else {
            document.getElementById('cat-level').innerText = "?";
            document.getElementById('cat-name').innerText = "ì…ì–‘ ëŒ€ê¸° ì¤‘";
            evolveBtn.innerText = "ì§„í™”"; evolveBtn.disabled = true;
            buyBtn.disabled = false; adoptBtn.disabled = true;
        }
        syncWorldRankOne();
    };

    window.fetchNewCat = () => {
        if (window.gold < 1000) return;
        window.gold -= 1000;
        const r = Math.random() * 100;
        let g = (r < 0.5) ? "ì‹ ìˆ˜" : (r < 3.5) ? "ì˜ë¬¼" : (r < 13.5) ? "í’ˆì¢…ë¬˜" : (r < 38.5) ? "ì§‘ê³ ì–‘ì´" : "ê¸¸ê³ ì–‘ì´";
        window.currentCat = { name: gradeInfo[g].names[Math.floor(Math.random()*2)], grade: g, level: 0, survivalRate: 100 };
        addLog(`ğŸ¾ [${g}]ë¥¼ ì…ì–‘í–ˆìŠµë‹ˆë‹¤.`);
        updateUI(); saveGame();
    };

    window.evolve = () => {
        const cost = Math.floor(2000 * Math.pow(1.8, window.currentCat.level));
        if (window.gold < cost) return;
        window.gold -= cost;
        
        const successLimit = Math.max(10, 80 - (window.currentCat.level * 9));
        if (Math.random() * 100 < successLimit) {
            window.currentCat.level++;
            addLog(`âœ¨ ì§„í™” ì„±ê³µ! +${window.currentCat.level}`, "#2ecc71");
            playAnimation('success');
        } else {
            addLog(`ğŸ˜­ +${window.currentCat.level} ê³ ì–‘ì´ê°€ ê°€ì¶œí–ˆìŠµë‹ˆë‹¤.`, "#e74c3c");
            window.currentCat = null;
            playAnimation('shake');
        }
        updateUI(); saveGame();
    };

    window.adoptOut = async function() {
        if (!window.currentCat) return;
        const info = gradeInfo[window.currentCat.grade];
        const price = Math.floor(1000 * (info.rank + 1) * 10 * Math.pow(1.6, window.currentCat.level));
        const prob = parseFloat((info.baseProb * Math.pow(0.75, window.currentCat.level)).toFixed(8));

        const record = {
            owner: window.nickname,
            catName: window.currentCat.name,
            grade: window.currentCat.grade,
            level: window.currentCat.level,
            prob: prob,
            value: price,
            date: Date.now()
        };

        window.myHistory.unshift(record);
        window.gold += price;
        addLog(`ğŸ’° ë¶„ì–‘ ì™„ë£Œ: +${price.toLocaleString()} ëƒ¥`);
        window.currentCat = null;
        updateUI(); await saveGame();
    };

    // ê¸€ë¡œë²Œ ë­í‚¹ ë°ì´í„° ë¡œë“œ (ì˜¤ë¥˜ ìˆ˜ì •)
    async function fetchGlobalData() {
        try {
            const querySnapshot = await getDocs(collection(db, "users"));
            let all = [];
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (data.catHistory && Array.isArray(data.catHistory)) {
                    all = all.concat(data.catHistory);
                }
            });
            // undefined ë°©ì§€ ì²˜ë¦¬
            return all.filter(c => c && c.prob).sort((a, b) => a.prob - b.prob).slice(0, 20);
        } catch(e) { return []; }
    }

    async function syncWorldRankOne() {
        const bests = await fetchGlobalData();
        const info = document.getElementById('world-best-info');
        if (bests.length > 0) {
            const top = bests[0];
            const color = gradeInfo[top.grade]?.color || "#eee";
            info.innerHTML = `
                <div style="color:${color}; font-size:1.8rem; font-weight:900;">+${top.level}</div>
                <div style="color:#fff; font-weight:bold;">${top.owner}ì˜ (${top.catName})</div>
                <div style="color:#ffd700; font-size:0.7rem;">í¬ê·€ë„: ${top.prob}%</div>
            `;
        } else { info.innerText = "ì„œë²„ ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."; }
    }

    window.openMyHistory = () => {
        document.getElementById('my-history-page').style.display = 'block';
        const list = document.getElementById('my-history-list');
        list.innerHTML = window.myHistory.map(c => `
            <div class="rank-item" style="border-left-color:${gradeInfo[c.grade].color}">
                <div><span style="color:${gradeInfo[c.grade].color}; font-weight:bold;">+${c.level} ${c.catName}</span><div style="font-size:0.6rem; color:#666;">ë¶„ì–‘ê°€: ${c.value.toLocaleString()} ëƒ¥</div></div>
                <div style="text-align:right; font-size:0.7rem; color:#888;">${new Date(c.date).toLocaleDateString()}</div>
            </div>`).join('') || "<p style='text-align:center; color:#555;'>ë¶„ì–‘ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    };

    window.openGlobalRanking = async () => {
        document.getElementById('global-rank-page').style.display = 'block';
        const list = document.getElementById('global-rank-list');
        list.innerHTML = "<p style='text-align:center; color:#ffd700;'>ì›”ë“œ ë­í‚¹ ë™ê¸°í™” ì¤‘...</p>";
        const bests = await fetchGlobalData();
        list.innerHTML = bests.map((c, i) => `
            <div class="rank-item" style="border-left-color:${gradeInfo[c.grade]?.color}">
                <div>
                    <span style="color:#ffd700; font-weight:bold;">${i+1}ìœ„</span>
                    <span style="color:#fff; margin-left:10px;">${c.owner || 'ë¬´ëª…'}ì˜</span> 
                    <span style="color:${gradeInfo[c.grade]?.color}; font-weight:bold;">+${c.level} ${c.catName}</span>
                </div>
                <div style="text-align:right; color:#ffd700; font-weight:bold; font-size:0.8rem;">${c.prob}%</div>
            </div>`).join('') || "<p style='text-align:center;'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    };

    window.resetGame = () => { 
        if(confirm("â— ê²½ê³ : ëª¨ë“  ê¸°ë¡(ë‹‰ë„¤ì„, ë¶„ì–‘ ê¸°ë¡, ì¬í™”)ì´ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
            localStorage.clear(); 
            location.reload(); 
        } 
    };

    async function saveGame() {
        localStorage.setItem('gold', window.gold);
        localStorage.setItem('myHistory', JSON.stringify(window.myHistory));
        localStorage.setItem('currentCat', JSON.stringify(window.currentCat));
        try {
            await setDoc(doc(db, "users", myId), { 
                gold: window.gold, 
                currentCat: window.currentCat, 
                catHistory: window.myHistory,
                nickname: window.nickname 
            });
        } catch(e) {}
    }

    function addLog(msg, color="#aaa") { const b = document.getElementById('game-log'); b.innerHTML = `<div style="color:${color}">> ${msg}</div>` + b.innerHTML; }
    function playAnimation(type) {
        const el = document.getElementById('cat-display-area');
        const cls = type === 'success' ? 'anim-success' : 'anim-shake';
        el.classList.remove('anim-success', 'anim-shake'); void el.offsetWidth; el.classList.add(cls);
        setTimeout(() => el.classList.remove(cls), 800);
    }
    window.closePage = (id) => document.getElementById(id).style.display = 'none';

    initializeGame();
</script>
</body>
</html>
